# Tealium iQ Extension Documentation: Set Send Retarget Variables

## 1. Extension Overview

- **Name**: WTA : TAG : Set : Send Retarget Variables
- **ID**: 1077
- **Type**: Javascript Code
- **Scope**: 894
- **Execution Frequency**: Active

### Summary
This extension processes application state and journey action data in order to determine whether to send retargeting variables. It checks a series of conditions related to the application's status and the user's journey. If certain criteria are met, it populates several retargeting variables in the `b` object, which is presumably used in downstream analytics and retargeting efforts. Its main purpose is to facilitate targeted marketing efforts by ensuring that relevant customer data is sent when conditions are appropriate.

## 2. Code Explanation

### Key Variables
- **`appStatus`**: Holds the application state, fetched from either `b.ApplicationStateInternal` or `b.ApplicationState`.
- **`statusConfig`**: An object containing states (like "Referred", "Fulfilled", etc.) that, when the `appStatus` matches, will trigger suppression of retargeting.
- **`actionConfig`**: An object containing journey actions (like "Downsell", "Application Processing", etc.) that also trigger suppression if matched.

### Logic Flow
1. The extension retrieves the current application state and checks it against `statusConfig`.
2. It also checks the current journey action against `actionConfig`.
3. If either the application status or journey action is found in their respective configuration objects, the `b.SendRetargetSuppress` variable is set to "yes".
4. If `b.SendRetargetSuppress` is not set (indicating that retargeting is not suppressed), the extension checks if several required retargeting variables (`RetargetEmail`, `RetargetPostcode`, etc.) are present.
5. If all required variables exist, they are copied into the prefixed variables that will trigger retargeting.

### Dependencies
- The code relies on the assumption that the `b` object contains properties representing the application state and user journey data.
- It is implied that certain global objects (`eventType`, `eventPayload`, `tagObject`) are available, with no additional external libraries needed.

## 3. Usage Examples

### Normal Condition Scenario
Assuming:
- `b.ApplicationState` = "Fulfilled"
- `b.JourneyAction` = "d1"
- `b.RetargetEmail`, `b.RetargetPostcode`, `b.RetargetProduct`, `b.ProductGroup`, `b.ReturnURL`, `b.RetargetSurname`, and `b.RetargetTitle` are all populated.

**Outcome**:  
- `b.SendRetargetSuppress` will not be set (as the conditions to suppress are not met).
- The variables are sent as:
  - `b.SendRetargetEmail` = value of `b.RetargetEmail`
  - `b.SendRetargetPostcode` = value of `b.RetargetPostcode`
  - etc.

### Edge Condition Scenario
Assuming:
- `b.ApplicationState` = "Declined"
- All retargeting variables are populated.

**Outcome**:  
- `b.SendRetargetSuppress` will be set to "yes".
- None of the retargeting variables will be assigned to the prefixed variables in the `b` object.

## 4. Known Limitations & Gotchas

- If `b.ApplicationStateInternal` and `b.ApplicationState` are undefined, `appStatus` will lead to unanticipated behaviour since it would evaluate to `undefined`.
- If the required retargeting variables are missing, no data will be sent, which may affect the effectiveness of retargeting campaigns.
- The extension may conflict with other extensions that modify the `b` object or set `SendRetargetSuppress` without proper order of execution, leading to issues in variable population.

## 5. Recommendations for Refactoring

- Consider implementing more robust checks to verify the existence of necessary properties on the `b` object to avoid silent failures:
  - For example, validate `b.RetargetEmail`, `b.RetargetPostcode`, etc. are not only present but also conform to expected formats.
- Although ES5 is the requirement, improve code readability by modularising the functionality into smaller, named functions (e.g., `setSuppress()`, `populateRetargetVariables()`).
- Maintain consistent naming conventions throughout the object properties for easier integration with other data layers or systems.

## 6. Maintenance & Further Notes

- **Ownership**: Assign ownership to a specific developer or a team to ensure accountability for updates and improvements.
- **Testing Guidelines**: 
  - Establish a set of unit tests that cover key scenarios: normal and edge cases, empty inputs, and potential conflicts with other extensions.
- Ensure that documentation is routinely updated alongside code changes to maintain accuracy and relevance.

---

This structured document provides a comprehensive overview of the Tealium iQ extension, offering clear insights into its functionality, behaviour, and areas for improvement, positioned well for dissemination within developer teams or stakeholders.