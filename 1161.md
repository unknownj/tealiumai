# Tealium iQ Extension Documentation: Legacy Event Support for Tablet in Branch

## 1. Extension Overview
- **Name**: Legacy Event Support for Tablet in Branch
- **ID**: 1161
- **Type**: Advanced Javascript Code
- **Scope**: DOM Ready
- **Execution Frequency**: Run Once

### Summary
This extension is designed to provide legacy event support for tablet devices in the Branch framework. It processes query string parameters from the URL, remaps them according to a predefined mapping, and triggers a `utag.view` event with the formatted payload. The goal is to ensure that events from legacy systems can be properly handled and reported in the new tablet setup without requiring significant changes to the existing data flow.

---

## 2. Code Explanation

### Key Variables
- **utag**: The main global object for Tealium's Universal Tag that handles data and events.
- **m**: A map of mappings (from the `utag.sender[894].map`) used to transform query string parameters.
- **remap**: An object that holds the remapped key-value pairs derived from the original mappings.
- **qsparts**: An array of query string parts split from the incoming URL.
- **payload**: An object that will be populated with the remapped parameters and their corresponding values.

### Logic Flow
1. **Initialization**: The function checks for the presence of `window.utag`. If `utag` is not defined, it retrieves the mapping data from the specified sender index.
2. **Mapping Creation**: It iterates over the mapping object (`m`) and constructs the `remap` object, which holds key mappings.
3. **Query String Processing**: The incoming query string (`qs`) is split into parts. Each part is further split into keys and values.
4. **Payload Population**: The function checks each key against the `remap` object and populates the `payload` with the remapped key or the original key if no remapping exists.
5. **Event Trigger**: Finally, the `utag.view(payload)` function triggers a Tealium event, sending the constructed payload for tracking.

### Dependencies
- The extension relies on the global `utag` object and its `view` method. It assumes that the mapping data is present in `utag.sender[894].map`.

---

## 3. Usage Examples

### Normal Scenario
- **Incoming Query String**: `example.com/?param1=value1&param2=value2`
- **Mapping**: If `param1` maps to `new_param1` and `param2` maps to `new_param2`, the payload sent to `utag.view` would be:
  ```javascript
  {
    new_param1: 'value1',
    new_param2: 'value2'
  }
  ```

### Edge Case
- **Missing Mapping**: If a key in the query string (`param3`) does not exist in the mapping, it will retain its original key in the payload and be sent as:
  ```javascript
  {
    new_param1: 'value1',
    new_param2: 'value2',
    param3: 'value3'
  }
  ```
  This allows for backward compatibility, ensuring that no data is lost due to missing mappings.

---

## 4. Known Limitations & Gotchas
- **Dependency on Mapping**: If the mapping data in `utag.sender[894].map` is not configured correctly or is missing, the extension will not function as expected.
- **Global Namespace Pollution**: Since the function directly modifies the `utag` object, care must be taken to avoid conflicts with similarly named functions or properties in external scripts.
- **Performance on Large Query Strings**: If the incoming query string contains a significant number of parameters, performance might be impacted as the function processes each part sequentially.

---

## 5. Recommendations for Refactoring
- **Error Handling**: Implement robust error handling to manage cases where the mapping might not be found, thus preventing potential breakage.
- **Function Structure**: Consider encapsulating logic into smaller functions, for example:
  - A function to handle the creation of the mapping.
  - A function to process the query string.
  - This enhances readability and maintainability.
- **Use of Array Mapping**: Consider using an array for `qsparts` split logic to improve clarity and reduce repetitive code.

---

## 6. Maintenance & Further Notes
- **Ownership**: Assign a team member as the primary owner of this extension for ongoing maintenance and updates.
- **Testing**: Ensure thorough testing is conducted whenever updates are made to the mappings or the logic within this extension.
- **Documentation Updates**: Regularly review and update this documentation to reflect any changes in the extension's logic or dependencies. This ensures that all team members have access to the most current information.

--- 

This structured documentation provides insights into the "Legacy Event Support for Tablet in Branch" extension, enabling developers and stakeholders to understand its purpose, functionality, and areas for improvement effectively.