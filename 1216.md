# Tealium iQ Extension Documentation

## 1. Extension Overview
- **Name**: OVA : TAG : Set : Lloyds : Event Listeners : Mortgage
- **ID**: 1216
- **Type**: JavaScript Code
- **Scope**: 995
- **Execution Frequency**: Active

### Summary
This Tealium iQ extension is responsible for integrating the Lloyds Virtual Assistant into a web page and setting up event listeners to track user interactions. These interactions include clicks on specific buttons and links related to the virtual assistant. When a user interacts with the virtual assistant, the extension captures relevant data and sends it to Tealium for analytics, thereby providing insights into user behaviour and journey.

---

## 2. Code Explanation

### Key Variables
- `cvdiv`: A `DIV` element created to host the virtual assistant.
- `cvscript`: A `SCRIPT` element that loads the Lloyds Virtual Assistant.
- `c$`: A reference to the `clova2` library, which is used to handle events.

### Logic Flow
1. The extension checks if the `u.initialised` property is set. If not, it continues to initialize the virtual assistant.
2. A new `DIV` is created and appended to the document body to serve as a container for the virtual assistant.
3. The `SCRIPT` element is created, pointing to the minified script of the Lloyds Virtual Assistant, and appended to the newly created `DIV`.
4. The extension sets up three event listeners that track specific user actions:
   - Clicking on the virtual assistant trigger (`div.va-trigger`).
   - Submitting a search input via the virtual assistant (`input.va-inp-btn[value=Submit]`).
   - Clicking links within the virtual assistant's FAQ sections (`.va-faq-ul li a` and `.va-faqs li a`).

### Global Dependencies
- The extension relies on `window.utag` for sending tracking data to Tealium.
- It uses `window.clova2.$`, which is a jQuery-like library for event handling.

---

## 3. Usage Examples

### Normal Conditions
- When a user clicks on the virtual assistant trigger, the extension captures the event and sends the following data to Tealium:
  - **JourneyName**: "VirtualAssistant"
  - **JourneyStep**: 1
  - **JourneyEvent**: "Overlay"

- Upon clicking the 'Submit' button after entering a search query, the following data is sent:
  - **JourneyName**: "VirtualAssistant"
  - **JourneyStep**: 2
  - **JourneyEvent**: "Field Update"
  - **EventAction**: "Filter"
  - **EventNarrative**: "Virtual Assistant Search"
  - **EventValue**: The value of the input field.

- When a FAQ link is clicked, the extension triggers:
  - **JourneyName**: "VirtualAssistant"
  - **JourneyStep**: 3
  - **JourneyEvent**: "Internal Link"
  - **EventAction**: "Supporting Information"
  - **EventNarrative**: The text of the clicked link.

### Edge Conditions
- If the Lloyds Virtual Assistant fails to load, no events will be tracked, and the user interactions will not be captured. This should be monitored during testing.

---

## 4. Known Limitations & Gotchas

- The extension assumes the availability of the `div.va-trigger`, `input.va-inp-btn[value=Submit]`, and FAQ links in the DOM. If these elements do not exist, the corresponding event listeners will not trigger.
- It generates no feedback for failed loading; thus, error handling may need to be implemented in the virtual assistant's script.
- There could be conflicts with other scripts manipulating similar DOM elements, leading to unintended behaviour.

---

## 5. Recommendations for Refactoring

- **Modularization**: Consider breaking down the script into smaller functions that can handle the creation of the virtual assistant, event listener attachment, and data tracking. This can improve readability and maintainability.
  
- **Defensive Checks**: Add checks to ensure that `cvdiv` and `cvscript` are successfully created and appended. Similarly, event listeners should be conditionally attached only if the elements exist in the DOM.
  
- **Error Handling**: Implement a fallback mechanism for detecting errors during the loading of the virtual assistant. 

- **Variable Naming**: Consider using more descriptive variable names for better clarity on what each variable represents (e.g., `virtualAssistantDiv` instead of `cvdiv`).

---

## 6. Maintenance & Further Notes

- **Ownership**: The team responsible for maintaining this extension should ensure that the script is periodically reviewed, especially after updates to the Lloyds Virtual Assistant or changes in the user interface.
- **Testing Guidelines**: Any changes to this extension should be thoroughly tested in various environments to ensure event tracking works under all conditions.
- **Documentation Updates**: Keep this documentation updated as new features are added or existing features change, ensuring that it accurately reflects the current state of the extension. 

The extension must also be tested for compatibility with various browsers to maintain a consistent user experience.