# Tealium iQ Extension Documentation: Read NGA Constants

## 1. Extension Overview

- **Name**: Read NGA Constants
- **ID**: 1223
- **Type**: Advanced JavaScript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension is designed to read the `nga_constants` object from the global `window` scope. Upon detecting this object, it flags the traffic as originating from a webview and populates specific data items into the Tealium data layer. It includes functionality to hash personally identifiable information (PII) such as email addresses and phone numbers. The extension also handles a scenario where `nga_constants` is not immediately available, setting up a polling mechanism to check for its presence at regular intervals.

---

## 2. Code Explanation

### Key Variables
- **a**: Represents `eventType` passed into the function, indicating the type of event triggering the extension.
- **b**: Represents `eventPayload`, the object that will carry data to be sent to Tealium.
- **n**: A variable referencing `window.nga_constants.tealium` if it exists.

### Logic Flow
1. **Check for `nga_constants`**:
   - If the `window.nga_constants` object is found, the extension flags the traffic as a webview and begins processing the tealium-specific data items found within `n`.
   
2. **Hashing PII**:
   - For the `FirstPartyEmail` and `FirstPartyPhone` properties in `n`, if present and valid, they are hashed using the SHA256 algorithm.
   - Special handling for `FirstPartyEmail` involves stripping periods from Gmail addresses before hashing, thereby ensuring they are stored without redundancy.

3. **Polling for `nga_constants`**:
   - If `nga_constants` is not found, a timestamp is recorded and a polling interval is initiated (every 200 ms) to check for its availability.
   - Upon detecting `nga_constants`, the interval stops and an analytics event is triggered, documenting the time taken to find the object.

### Dependencies
- The code relies on the global `window` object for `nga_constants` and `utag.ut.sha256` for hashing capabilities. Ensure these are available and correctly configured in your environment.

---

## 3. Usage Examples

### Scenario 1: Normal Flow
- **Input**: The `window.nga_constants` object is present, containing a `tealium` property with the necessary data.
- **Output**: Relevant properties including hashed email and phone number are populated in the `eventPayload`, and the traffic is flagged as a webview.

### Scenario 2: Edge Case - Slow Load
- **Input**: `window.nga_constants` is not present when the extension first runs.
- **Output**: A polling mechanism is established, which checks for the `nga_constants` every 200 ms, logging how long it took once found.

---

## 4. Known Limitations & Gotchas

- **Polling Load**: Continuous polling every 200 ms could lead to performance overhead if it lasts longer than expected. Monitor the number of checks to avoid unnecessary load.
- **Conflict with Other Extensions**: If another extension modifies `eventPayload` simultaneously, there may be conflicts or data overwrites. Ensure proper sequencing of extensions in Tealium.
- **Missing Data Handling**: If PII fields are not structured as expected, the hashing and assignment logic may silently fail; consider adding logging for unhandled cases.

---

## 5. Recommendations for Refactoring

- **Defensive Checks**: Although it is assumed that `eventType` and `eventPayload` will be present, including validation checks for properties in `n` can enhance stability if changes occur.
- **Code Modularity**: Consider breaking out the hashing functionality and polling logic into separate functions. This will enhance readability and maintainability.
- **Code Style**: Consistency in variable naming and indentation level can be enhanced. Using descriptive variable names over single letters (e.g., `dataLayer` vs. `b`) can improve comprehension.

---

## 6. Maintenance & Further Notes

- **Ownership**: Assign a dedicated team member to oversee changes and updates to the extension.
- **Testing Guidelines**: Regularly test the extension in different environments to ensure consistent performance. Incorporate automated checks where feasible.
- **Documentation Updates**: Maintain the documentation as the extension evolves or integrates new features. Ensure any changes are highlighted in version notes for clarity. 

Keep this documentation accessible for new developers and stakeholders to understand how the `Read NGA Constants` extension functions and integrates with the Tealium iQ ecosystem.