# Page Load Adobe Event Triggers Extension Documentation

This document provides a detailed overview and technical explanation of the "Page Load Adobe Event Triggers" Tealium iQ extension. It is aimed at developers and stakeholders for understanding, maintenance, and potential improvements.

---

## 1. Extension Overview

- **Name:** Page Load Adobe Event Triggers
- **ID:** 1225 (Extension internal ID); Extension ID 100040
- **Type:** Advanced Javascript Code
- **Scope:** DOM Ready
- **Execution Frequency:** Run Once

**Summary:**  
This extension performs three primary functions on page load:

1. It conditionally sets a unique journey identifier when the current URL contains the segment "/cwa/".
2. It listens for the browser's before print event and fires a corresponding Adobe event (generic event 87).
3. It intercepts clicks on telephone links (i.e. those with an href starting with "tel:") to fire an external click event (generic event 204) with additional metadata.

The extension is designed to integrate with global analytics objects and event functions, thereby facilitating data-layer updates and event tracking for Adobe analytics through Tealium iQ.

---

## 2. Code Explanation

### Key Variables & Global Objects

- **Global Objects:**
  - `window.clova3.datalayer`: Used for setting the "JourneyUniqueID" on qualifying pages.
  - `window.LBGAnalytics.events`: Used to send analytics event data using the `genericEvent` function.
  - `window.clova2.$`: jQuery-like library used to handle DOM events (in this case, click events on telephone links).

### Code Logic Flow

1. **JourneyUniqueID Generation:**
   - The code checks if the current URL’s pathname contains the string “/cwa/”.  
     **Note:** The check uses `indexOf("/cwa/") > 0`, meaning it will trigger only if “/cwa/” is not at the very beginning of the pathname.
   - If the condition is met, a unique identifier is generated by:
     - Capturing the current time in milliseconds.
     - Appending a random numeric string (derived from `Math.random()`).
     - Combining these values and converting the result to a base-36 string.
   - This unique identifier is then set on the data layer under the key "JourneyUniqueID".

2. **Before Print Event Handler:**
   - The code attaches an event listener to the `window` object for the "beforeprint" event.
   - On triggering this event (for example, when the user initiates printing), the function calls:
     - `e.genericEvent(87).send();`  
       This sends an event identified by the numeric code 87 to Adobe Analytics.

3. **Telephone Link Click Handler:**
   - The extension uses a jQuery-like selector to capture click events on anchor tags (`<a>`) whose `href` attribute starts with "tel:".
   - When such an element is clicked, the code:
     - Calls `e.genericEvent(204).send()` with an object containing additional properties:
       - `JourneyEvent: "External Click"`
       - `EventAction: "Click to Call"`
       - `EventNarrative`: Captures the inner text of the clicked element.
   - This assists in tracking outbound or external interactions with telephone links.

### Code Dependencies
- **Global Objects & Libraries:**  
  The extension depends on:
  - `window.clova3.datalayer` for setting data-layer values.
  - `window.LBGAnalytics.events` provides the Adobe event system.
  - `window.clova2.$` (assumed to be a jQuery-like implementation) for delegated event handling.
- **Event Methods:** Utilises the `.send()` method on the result of `e.genericEvent()` to transmit event details.

---

## 3. Usage Examples

### Scenario 1: Page Visit with "/cwa/" in the URL
- **Situation:** A user navigates to a URL such as "https://example.com/shop/cwa/product".
- **Expected Behaviour:**
  - The condition `window.location.pathname.indexOf("/cwa/") > 0` is true.
  - A unique JourneyUniqueID is generated and set within the data layer.
  - Other event handlers remain in standby until their specific events occur.

### Scenario 2: User Initiates Printing
- **Situation:** A user chooses to print the current page.
- **Expected Behaviour:**
  - The "beforeprint" event is detected.
  - The extension calls `e.genericEvent(87).send()`, sending a generic event with the ID 87 to Adobe Analytics.

### Scenario 3: User Clicks a Telephone Link
- **Situation:** A user clicks on a telephone link (e.g., `<a href="tel:+123456789">Call Us</a>`).
- **Expected Behaviour:**
  - The extension captures the click via a delegated event handler.
  - The click triggers `e.genericEvent(204).send()` sending an event with properties:
    - `JourneyEvent: "External Click"`
    - `EventAction: "Click to Call"`
    - `EventNarrative`: Contains the inner text of the clicked link, such as "Call Us".

### Edge Conditions
- If the pathname starts with "/cwa/" (i.e. index 0), the unique ID generation will not execute because the condition checks for index greater than 0.
- If any of the dependent global objects (e.g., `window.clova3`, `window.LBGAnalytics`, `window.clova2`) are not defined before this extension runs, the corresponding events or data layer update may fail silently.

---

## 4. Known Limitations & Gotchas

- **URL Pathname Check:**  
  The utilisation of `indexOf("/cwa/") > 0` does not cover cases where "/cwa/" is at the start of the pathname (index 0). Review whether this behaviour is intended.

- **Global Object Dependencies:**  
  The code assumes the availability of `window.clova3`, `window.LBGAnalytics`, and `window.clova2.$`. If these objects are not present or initialised before this extension code is executed, errors may occur.

- **Event Listener Conflicts:**  
  There is a possibility of conflict with other Tealium iQ extensions or external scripts that:
  - Modify the same global objects.
  - Bind additional event listeners to the same DOM elements or events.

- **Minimal Defensive Coding:**  
  Since ES5 compatibly is needed, no ES6 features are used; however, there is minimal checking of the existence of critical global objects and methods.

---

## 5. Recommendations for Refactoring

- **Defensive Checks:**  
  Although it is presumed that the required objects (`window.clova3`, `window.LBGAnalytics`, `window.clova2.$`) are available, it may be beneficial (if permitted) to include minimal defensive checks to prevent runtime errors in an unpredictable environment.

- **URL Check Improvement:**  
  If the intention is to generate a unique identifier even when the URL starts with "/cwa/", consider revising the condition to:
  - `if (window.location.pathname.indexOf("/cwa/") !== -1) { ... }`  
    This will ensure that the check passes regardless of the position of "/cwa/" in the string.

- **Modularisation:**  
  Consider breaking the code into distinct functions for:
  - Generating and setting the JourneyUniqueID.
  - Handling the before print event.
  - Handling telephone link clicks.
  
  This separation can improve readability and maintainability.

- **Inline Documentation:**  
  Introduce inline comments to elaborate on the purpose of critical code sections to assist future developers.

- **Error Handling:**  
  Where possible, add try/catch blocks (in ES5 syntax) around blocks that interact with global objects that might occasionally be undefined to prevent the entire extension from failing.

---

## 6. Maintenance & Further Notes

- **Testing Guidelines:**
  - Conduct unit tests on each modular function if refactoring is done.
  - Perform manual testing on pages with and without the "/cwa/" URL segment.
  - Test print invocation in different browsers to ensure the "beforeprint" event is consistently captured.
  - Verify the click event works across various telephone links on different devices.

- **Ownership & Code Reviews:**  
  - Assign a dedicated developer or team for the maintenance of this extension.
  - Regularly review dependencies and version updates for libraries such as the jQuery-like framework used via `window.clova2.$`.
  - Validate functionality after any global object changes on the site.

- **Documentation Updates:**  
  Maintain updated documentation (similar to this page) whenever changes are made, ensuring that stakeholders and other developers are informed of the latest logic and dependencies.

- **Performance Considerations:**  
  Monitor the performance impact of the event listeners, particularly on pages with heavy DOM interactions.

---

By adhering to this documentation, future developers and stakeholders should have a clear understanding of the extension’s purpose, functionality, and areas for potential improvement while ensuring continued compatibility with ES5 standards.