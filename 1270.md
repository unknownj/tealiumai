# Tealium iQ Extension Documentation: Pegasus Tag Title

## 1. Extension Overview
- **Name**: Pegasus Tag Title
- **ID**: 1270
- **Type**: Advanced Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
The Pegasus Tag Title extension enhances the data layer by creating a structured tag naming convention based on multiple brand and product attributes. It allows for dynamic mapping of brand names, product groups, page roles, and application states, and it provides flexibility in handling non-standard values. This is particularly useful in mitigating issues arising from malformed product group values, thus supporting reliable data collection for analytics.

---

## 2. Code Explanation

### Key Variables
- **`b`**: An object representing the event payload from which data is manipulated.
- **`utag.data`**: An object representing the Tealium data layer to which the mapped values are assigned.
- **`tag_structure`**: An array defining the structure of the tags to be created, including acceptable values and mappings for each attribute.

### Logic Flow
1. **Brand Mapping**: The code identifies the brand based on certain keywords (e.g., "LLOYDS", "HALIFAX") and constructs a new brand name that concatenates the brand with the division if applicable.
2. **Creating Additional Variables**:
   - It initializes `PegasusProductGroup`, `PegasusPageRole`, and `PegasusApplicationState` if they're not already defined or are empty.
3. **Tag Structure Processing**:
   - The extension iterates over `tag_structure`, validating and mapping values from `b`. If the value is defined in `allowable`, it will map any non-standard names to their corresponding standard names.
4. **Pegasus Friendly Name**: It generates a user-friendly name for the data layer by appending significant information based on certain conditions.
5. **Final Tag Name Creation**: Combines all structured tags into a final `PegasusTagName`, reflecting the complete tagging schema.

### Dependencies
- The extension uses global objects `utag` and `clova3.datalayer`. It assumes that `utag.data` and `clova3.datalayer set` functions are defined and accessible in the execution context.

---

## 3. Usage Examples

### Normal Scenario
- **Input**: An event payload with `Brand` as "Lloyds" and `Division` as "Commercial".
- **Output**:
  - `PegasusBrand` will be set to "Lloyds Commercial".
  - `PegasusTagName` will include "Pegasus | Lloyds Commercial | ..." based on product group and page role values.

### Edge Condition
- **Input**: An event payload with an unrecognised `ProductGroup`.
- **Output**:
  - If `PegasusProductGroup` is undefined or empty, it takes the value from `ProductGroup`, even if it falls outside the allowable list. Consequently, `PegasusTagName` still includes the unconventional value, which may lead to less predictable analytics reporting.

---

## 4. Known Limitations & Gotchas
- The extension relies heavily on the presence of specific keys (`Brand`, `ProductGroup`, etc.) in the input object. If these are absent, it could lead to undefined behaviour.
- There are potential naming conflicts with other extensions modifying the `utag.data` object. It's essential to maintain clear governance to prevent overwriting critical data.
- The behaviour for edge cases (entries not present in the allowable values) is to append "NA", which might introduce noise in the data layer.

---

## 5. Recommendations for Refactoring
- **Defensive Checks**: Implement checks to verify that properties exist before accessing them (e.g. checking that `b["Brand"]` is defined).
- **Code Style**: Maintain consistent indentation and use of whitespace for better readability. For instance, ensure proper spacing around operators and keywords.
- **Modularisation**: Consider breaking the larger function into smaller, reusable functions that handle specific tasks such as brand mapping, product group assignment, and tag name creation.

---

## 6. Maintenance & Further Notes
- **Ownership**: Designate a primary owner for this extension who is responsible for reviewing changes and updates.
- **Testing Guidelines**: Conduct regular testing by simulating various event payloads to ensure that the extension performs as expected. 
- **Version Control**: Document changes in a changelog to track modifications over time and facilitate collaboration among developers.

This comprehensive documentation aims to equip developers and stakeholders with the necessary understanding to maintain and enhance the Pegasus Tag Title extension effectively.