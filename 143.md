# Tealium iQ Extension Documentation: Privacy Manager

## 1. Extension Overview
- **Name:** Privacy Manager
- **ID:** 220
- **Type:** Privacy Manager
- **Scope:** After Load Rules
- **Execution Frequency:** Run Always

### Summary
The Privacy Manager extension is designed to handle retargeting rules based on the application state and journey actions. It suppresses retargeting communication for specific application statuses and journey actions and ensures that relevant data is passed through only when certain conditions are met. This functionality is particularly important for maintaining compliance with privacy regulations and enhancing user experience by not bombarding users with unnecessary communications.

---

## 2. Code Explanation

### Key Variables
- **appStatus:** This retrieves the current application state using either `b.ApplicationStateInternal` or `b.ApplicationState`.
- **suppress_statuses:** An object that defines which application statuses should lead to suppression of retargeting communications.
- **suppress_actions:** An object that identifies which journey actions should prevent retargeting communications from being sent.
  
### Logic Flow
1. The extension first checks the application's status against the `suppress_statuses` to determine if retargeting should be suppressed.
2. Next, it evaluates the `JourneyAction` against the `suppress_actions` to see if any action should suppress the retargeting.
3. If neither suppression condition applies and essential fields (like email, postcode, product etc.) are populated, the extension proceeds to assign these fields to the required retargeting output variables:
   - `SendRetargetEmail`
   - `SendRetargetPostcode`
   - `SendRetargetProduct`
   - `SendRetargetProductGroup`
   - `SendRetargetReturnURL`
   - `SendRetargetSurname`
   - `SendRetargetTitle`

### Dependencies
The code relies on the following global objects:
- `eventType`: A string identifier for the event.
- `eventPayload`: An object containing the application's data necessary for processing the retargeting logic.

---

## 3. Usage Examples

### Scenario 1: Normal Flow
- **Input:** 
    - `ApplicationState`: "Approved"
    - `JourneyAction`: "d1"
    - `RetargetEmail`, `RetargetPostcode`, etc. are all populated.
- **Output:** 
    - No suppression occurs since the app status is "Approved" and the journey action is not one of the suppressed ones. All retargeting fields are populated for sending.

### Scenario 2: Suppressed State
- **Input:** 
    - `ApplicationState`: "Declined" 
    - `JourneyAction`: "p"
- **Output:** 
    - Both suppressions kick in. `SendRetargetSuppress` is set to "yes", and no retargeting information is sent out.

### Edge Condition: Missing Fields
- **Input:** 
    - `ApplicationState`: "Approved"
    - `JourneyAction`: "Approved"
    - But `RetargetEmail` is missing.
- **Output:** 
    - The retargeting Information will not be assigned, indicating incomplete data and ensuring no invalid retargeting attempts occur.

---

## 4. Known Limitations & Gotchas

1. **Uncaught Exceptions:** If the payload does not include one of the expected properties (even though its presence is guaranteed), the code may fail silently; thorough testing should be conducted in such cases.
2. **Conflicts with Other Extensions:** If another extension modifies `eventPayload` concurrently, unexpected results may occur due to shared mutable state.
3. **Race Conditions:** If multiple events are processed in quick succession, there could be a risk of overwriting desired values in the `eventPayload`.

---

## 5. Recommendations for Refactoring

1. **Modularisation:**
   - Consider breaking down large functions into smaller, maintainable functions for better readability and testability.
   
2. **Code Style:**
   - Maintain consistent code formatting for easier reading and maintenance. This includes consistent use of whitespace and indentation levels.

3. **Enhanced Logging:**
   - Introduce logging at key decision points in the logic to aid troubleshooting and understanding of flow through the extension.

4. **Defensive Checks:**
   - Although the availability of `eventType` and `eventPayload` is guaranteed, consider adding checks for the properties inside `eventPayload` to enhance robustness.

---

## 6. Maintenance & Further Notes

- **Ownership:** Assign a primary owner for this extension responsible for updates based on business needs and compliance requirements.
- **Testing Guidelines:** 
    - Regular testing should be performed especially after any updates to ensure the extension continues to perform as expected under various scenarios.
    - This should include unit tests simulating edge cases and integrations with other extensions.
- **Documentation Update:** Maintain up-to-date documentation whenever changes are made to the code, ensuring clarity for new developers or stakeholders.

--- 

This documentation aims to provide a comprehensive understanding of the Privacy Manager extension, facilitating easier maintenance and collaboration among developers.