# Tealium iQ Extension Documentation: LivePerson Site ID

## Extension Overview

- **Name**: LivePerson Site ID
- **ID**: 1451
- **Type**: Advanced Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension is designed to dynamically configure the appropriate LivePerson site ID based on the current environment and URL paths. It evaluates the conditions under which specific configurations apply, enabling seamless integration with LivePerson's chat solutions. With support for multiple domains and environments such as development, QA, and production, this extension helps ensure that the correct LivePerson instance is used, improving overall user experience and operational efficiency.

---

## Code Explanation

### Key Variables
- **`livePersonAccountConfigs`**: An array of configuration settings that contains various environments and conditions. Each configuration object includes:
  - `name`: A descriptive name for the configuration.
  - `criteria`: A function that defines the conditions under which this configuration is applicable.
  - `id`: The associated LivePerson site ID.

### Logic Flow
1. The extension first checks if a LivePerson site ID already exists in the global object `b`. If it does, the function exits early.
2. It calls `getLivePersonConfig(b)` to find the first configuration whose criteria are met based on the current state of the data layer `b`.
3. If a valid configuration is found, it sets `b.LP_SiteID` and `b.LP_SiteName` with the corresponding values.
4. These values are pushed to the data layer using `LBGAnalytics.datalayer.set()` for further use in the analytics stack.
5. The entire process is wrapped in a `try-catch` block to handle any potential errors without disrupting function execution.

### Dependencies
- **Global Objects**: 
  - `window`: Used for accessing the current hostname and URL path.
  - `sessionStorage`: Utilised for storing and retrieving session-specific data.
  - `document`: Used for manipulating the DOM to hide or show webchat components based on user interactions.
- **External Libraries**: 
  - Assumes the presence of the `LBGAnalytics` library for data layer handling.

---

## Usage Examples

### Normal Conditions
- **Scenario**: User navigates to the development site `sit02-dlb-secure-w.digital.lloydsbank.co.uk`.
  - The `criteria` for the "Embark Test" configuration returns true.
  - `b.LP_SiteID` is set to `89460435` and `b.LP_SiteName` is set to `"Embark Test"`.
  - This config is stored in the data layer for tracking.

### Edge Conditions
- **Scenario**: User accesses a production page but is in a development environment.
  - The criteria for configurations using the production site ID will not be met; the default configuration will be applied.
  - This fallback ensures that the application wonâ€™t crash due to absence of a valid configuration.

### Data Flow
- Input: The extension reads the current URL and environment settings from the `b` object.
- Output: The relevant LivePerson site ID and name are set in the `b` object and in the data layer.

---

## Known Limitations & Gotchas

- **Incomplete Domain Checks**: Certain hostname checks do not account for all possible environments. Developers must ensure that any new environments or domains are added to the `livePersonAccountConfigs` array.
- **Console Reporting**: Console logs are included for debugging but may clutter the console during production use. Consider removing or wrapping them in a debug mode check.
- **Dependence on Order of Execution**: This extension must run before any other extensions that rely on `b.LP_SiteID` or `b.LP_SiteName`.

---

## Recommendations for Refactoring

1. **Modularisation**: Break down the `criteria` functions into separate named functions to enhance readability and maintainability. Each environment-specific logic could be encapsulated in its own function.
2. **Simplify Conditions**: Some hostname checks can be simplified. For example, arrays can be used to check multiple hostnames in a more maintainable way rather than repeating checks.
3. **Session Storage Management**: Consider adding a method for cleaning up session storage to prevent potential memory issues caused by uncontrolled growth.
4. **Use of Constants**: Define commonly used values such as session storage keys as constants for better manageability.
  
---

## Maintenance & Further Notes

- **Ownership**: Assign a designated team or individual as the owner of this extension for ongoing maintenance.
- **Testing Guidelines**: Rigorous testing should be conducted whenever new domains or environments are added. Consider implementing unit tests for each `criteria` function.
- **Documentation**: Ensure that any changes to configurations or criteria are well-documented within the code and communicated to relevant stakeholders.

By adhering to these guidelines, we can maintain a robust and flexible extension that adapts to changing business needs and leverages the LivePerson service effectively.