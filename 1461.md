# Tealium iQ Extension Documentation: CommCode Fix

## 1. Extension Overview
- **Name:** CommCode Fix
- **ID:** 100040
- **Type:** Advanced Javascript Code
- **Scope:** DOM Ready
- **Execution Frequency:** Run Once

### Summary
The **CommCode Fix** extension enhances URLs on the Lloyds Banking Group websites by appending a `CommCode` cookie value to specific links. It checks the hostname and modifies certain links based on the presence of a query parameter and an existing cookie. This implementation is designed to ensure accurate attribution for marketing campaigns by preserving the `CommCode` across user sessions.

## 2. Code Explanation

### Key Variables
- `commcode`: Stores the value of the `CommCode` query parameter fetched from the URL.
- `aspinc`, `commcode`, `carinsure`, `vaninsure`: Node lists capturing different categories of anchor (`<a>`) tags based on specific URL patterns.

### Logic Flow
1. **Hostname Check**: The extension first checks the current hostname against predefined conditions for Lloyds Bank and Halifax.
2. **Get URL Parameters**: The function `getParameterByName` retrieves the `CommCode` from the URL query parameters.
3. **Set Cookie**: If `CommCode` is found, it sets a cookie with the same name.
4. **Modify Links**:
   - The extension looks for anchor links that match specific patterns (`asp_includes`, `apply_now_commcode`, etc.) and modifies them to include the `CommCode` cookie value in their URLs.
5. **Utility Functions**: The extension contains utility functions to set and get cookies, as well as to replace links based on the cookie value.

### Dependencies
- **Global Objects**: The extension relies on standard global objects such as `window`, `document`, and JavaScript's built-in functions (e.g., `decodeURIComponent`, `Date`).
- **Libraries**: No external libraries or frameworks are used.

## 3. Usage Examples

### Scenario 1: Standard Operation
1. A user visits the Lloyds Bank website with a URL containing `?CommCode=XYZ123`.
2. The `CommCode` is extracted and stored as a cookie.
3. All relevant links on the page are modified to include `CommCode=XYZ123` in their URLs, ensuring proper tracking.

### Scenario 2: Edge Condition - No CommCode Parameter
1. A user visits without a `CommCode` in the URL (e.g., `www.lloydsbank.com`).
2. The extension does not set the cookie, and the modified links will not contain a `CommCode` parameter.

### Scenario 3: Cookie Expiry
- The cookie is designed to expire after one day. After expiry, subsequent visits without a `CommCode` will result in links being generated without the `CommCode` appended.

## 4. Known Limitations & Gotchas

- **Ineffective on Non-Matching Hostnames**: If the hostname does not match either Lloyds Bank or Halifax criteria, the extension will not run.
- **Hardcoded Default Values**: The function `replaceInLink` uses hardcoded default values (`LY01`, `LV06`, `HX01`) which may not adapt to future URL changes without code modifications.
- **Cookie Length Limit**: Some browsers may impose limits on cookie sizes, potentially leading to issues if multiple lengthy `CommCode` values are stored.
- **Potential Conflicts**: If other scripts modify the same links or cookies, there may be unexpected behaviour unless tested for compatibility.

## 5. Recommendations for Refactoring

- **Modular Functions**: Consider breaking down the functionality into smaller reusable functions. For example, instead of having two identical blocks for Lloyds Bank and Halifax, unify them under one function that passes parameters.
- **Error Handling**: Improve error handling by logging to the console for easier debugging instead of silently failing (e.g., in `getParameterByName`).
- **Avoid Redundant Cookie Retrieval**: Currently, `getCookie("CommCode")` is called multiple times. Store its result in a variable to improve performance.
- **Descriptive Variable Names**: While naming is largely clear, consistent naming related to the content of the variables (like changing `aspinc` to a more descriptive name) can improve readability.

## 6. Maintenance & Further Notes

- **Ownership**: Assign a specific team member or developer as the owner for the extension to oversee future changes and updates.
- **Testing Guidelines**: Regularly test the extension across multiple web environments (production, staging) and devices to ensure continued functionality, especially after deployment of new features or changes.
- **Documentation Updates**: As code changes are made, ensure that this documentation is updated to reflect any new logic, behaviours, or function changes to maintain accuracy.

---

By following this structured documentation, developers and stakeholders can gain clear insights into the workings, usage, and maintenance of the **CommCode Fix** extension, facilitating effective collaboration and future enhancements.