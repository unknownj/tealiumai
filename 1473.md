# Tealium iQ Extension Documentation: Event Timings

## 1. Extension Overview
- **Name**: Event Timings
- **ID**: 100040
- **Type**: Advanced Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension captures and tracks event timings during page loads and user interactions. It stores timestamps for the initial page load and updates the timestamp upon each view event. It also calculates and stores the time elapsed since the page load and the last view event, providing valuable metrics for analytics and performance monitoring.

---

## 2. Code Explanation

### Key Variables
- **`now`**: A variable that holds the current timestamp (in milliseconds since the Unix epoch) at the point of execution.
- **`PageLoadTimeStamp`**: Stores the timestamp of when the page initially loaded.
- **`UtagViewTimeStamp`**: Captures the timestamp of when a view event occurs.
- **`TimeSincePageLoad`**: Function to calculate the elapsed time since the page was loaded.
- **`TimeSinceViewEvent`**: Function to calculate the elapsed time since the last view event.

### Logic Flow
1. The current timestamp is recorded at the start of the function.
2. If `PageLoadTimeStamp` is undefined (i.e., page has not been loaded yet):
   - Set `PageLoadTimeStamp` and `UtagViewTimeStamp` to the current timestamp.
   - Define two functions to calculate the time since page load and the last view event.
   - Initialize the properties `TimeSincePageLoad` and `TimeSinceViewEvent` to zero.
3. If the event type (`eventType`) is "view":
   - Update `UtagViewTimeStamp` with the current timestamp.
   - Reset `TimeSinceViewEvent` to zero.
4. If both `TimeSincePageLoad` and `TimeSinceViewEvent` are defined:
   - Set corresponding event values (`aa.event601`, `aa.event602`, `aa.event603`) in the data layer for analytics purposes.

### Dependencies
- **`LBGAnalytics`**: This extension relies on the `LBGAnalytics.datalayer` object to set values within the data layer.

---

## 3. Usage Examples

### Normal Condition
- On initial page load:
  - `PageLoadTimeStamp` is set to the current timestamp.
  - After the first view event, `UtagViewTimeStamp` is updated.
  - Both `TimeSincePageLoad` and `TimeSinceViewEvent` are calculated and stored.

### Edge Condition
- If the page is reloaded and a second view event occurs within 10 minutes, both timestamps will be updated, but the time calculations will ensure they only reflect the most recent events.

### Data Flow Example
1. **Initial Load**:
   - Data layer contains:  
     ```json
     {
       "PageLoadTimeStamp": 1633072800000,
       "UtagViewTimeStamp": 1633072800000,
       "TimeSincePageLoad": 0,
       "TimeSinceViewEvent": 0
     }
     ```
2. **First View Event** triggers an update, leading to:
   - `UtagViewTimeStamp` is set to a new timestamp, with `TimeSinceViewEvent` reset to zero. Time since page load is calculated.

---

## 4. Known Limitations & Gotchas
- **Time Limit**: The extension only tracks event timings within a 10-minute window. If user engagement exceeds this duration, the timing metrics will not reflect the required period.
- **Potential Conflicts**: If another extension modifies the same data layer properties (`PageLoadTimeStamp`, `UtagViewTimeStamp`), this could lead to incorrect timestamping. Coordination between extensions is advised.
- **Non-Standard Events**: If events other than "view" are processed, this extension may not account for those, potentially missing necessary timing updates.

---

## 5. Recommendations for Refactoring
- **Defensive Checks**: While not necessary for `eventType` and `eventPayload`, checks can be added for the presence of data layer properties when initially setting them to avoid overwriting valid data.
- **Modularity**: Consider separating the time calculation functions from the main logic for better readability and maintainability.
- **Documentation**: Include inline comments directly in the code for clarity, helping future developers understand each section's purpose quickly.

---

## 6. Maintenance & Further Notes
- **Ownership**: Assign a dedicated team member to oversee the maintenance of this extension, ensuring updates are noted and version controlled.
- **Testing Guidelines**: Regularly test the extension in various scenarios, especially around high-traffic times, to ensure it operates correctly under load.
- **Documentation**: Keep this documentation updated as changes occur in the extension's logic or dependencies for future reference among developers and stakeholders.

--- 

This structured documentation aims to provide comprehensive insights into the workings and nuances of the Event Timings extension, ensuring that it is readily understandable for developers and stakeholders alike.