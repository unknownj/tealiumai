# Tealium iQ Extension Documentation: Spending Rewards Correlations

## 1. Extension Overview

- **Name**: Spending Rewards Correlations
- **ID**: 1479
- **Type**: Advanced JavaScript Code
- **Scope**: DOM Ready
- **Execution Frequency**: Run Once

### Summary
The "Spending Rewards Correlations" extension captures and processes information regarding offers available on specific pages of the website. It collects data on offers that include a title, merchant name, discount percentage, and expiry date, and sends this information to LBGAnalytics for correlation analysis. This functionality aids in monitoring user engagement and the effectiveness of rewards offers available on the site.

## 2. Code Explanation

### Key Variables
- `window.location.pathname`: Used to determine the current URL path to identify if it matches specific reward hub keywords.
- `setTimeout()`: Ensures that the code execution occurs after a specified delay (3 seconds) to allow the DOM to fully load.
- `$`: A reference to `window.clova2.$`, assumed to be a jQuery-like library for document traversal and manipulation.
- `offers`: An array of DOM elements containing offer data.

### Logic Flow
1. **Path Check**: The script first checks if the URL path includes either of the keywords: `sr_hub` or `spending_rewards_hub`.
2. **Delay Execution**: If the path matches, it waits 3 seconds before executing the next block of code, allowing for any asynchronous loading of content.
3. **Data Extraction**: The script uses jQuery selectors to gather data from the elements representing offers. It extracts:
   - The ID of the button associated with the offer title.
   - The merchant's name.
   - The discount percentage.
   - The expiry date, which is further processed to remove unnecessary text.
4. **Data Formatting**: All extracted data points are joined into a single string for each offer, formatted appropriately.
5. **Analytics Logging**: The formatted offer strings are sent to LBGAnalytics through its `correlations.add()` method, linking the data with a specific identifier (71).

### Dependencies
- The code relies on the global `$` variable from `window.clova2`, which suggests a dependency on a custom or third-party library for DOM manipulation.

## 3. Usage Examples

### Normal Use Case
When a user navigates to a rewards hub (i.e., URLs containing `sr_hub` or `spending_rewards_hub`), after 3 seconds, the extension will collect data such as:
- Button ID: `offer-123`
- Merchant Name: `SuperMart`
- Discount Percentage: `20%`
- Expiry Date: `31 December 2023`

These data points will be formatted as:
```
offer-123/SuperMart/20%/31 December 2023
```
And sent to LBGAnalytics for processing.

### Edge Conditions
- **No Offers Present**: If there are no offer elements on the page, the extension will simply not send any data to LBGAnalytics but will not throw errors.
- **Slow Loading Elements**: If the page takes longer than 3 seconds to load key offer elements, the data will not be captured, and hence not sent to LBGAnalytics.

## 4. Known Limitations & Gotchas

- **Path Match Sensitivity**: The current implementation does a case-sensitive match; any change in the URL structure might lead to non-execution of the extension.
- **Delayed Execution**: The reliance on a fixed 3-second delay might not account for variations in page load times across different environments or users.
- **Selector Dependency**: The extension is heavily dependent on the specific DOM structure; any changes to the class names or structure of the offer elements will break the functionality.
- **Conflict with Other Extensions**: If other Tealium extensions manipulate the same offer elements before this script runs, it might lead to incorrect data capture.

## 5. Recommendations for Refactoring

- **Defensive Checks**: Ensure that required elements are present before attempting to access their properties. For instance, check if `$offer.find("button[id].sn-accordion-title-button")` returns an element before attempting to access its `attr()` method.
  
- **Modularisation**: Consider splitting the functionality into smaller, reusable functions. For example, one function could handle data extraction while another could handle data formatting and analytics sending.

- **Variable Naming**: Use more descriptive variable names to improve readability. For instance, renaming `offers` to `offerElements` could clarify its purpose.

- **Error Logging**: Implement error logging to catch and report any issues that arise from missing data or failed DOM queries.

## 6. Maintenance & Further Notes

- **Ownership**: Assign a team member to be responsible for this extension, ensuring that they are familiar with the underlying logic and any dependencies.
- **Testing Guidelines**: Regularly test the extension in various environments to ensure compatibility and performance. It should also be tested after any significant changes to the website's structure.
- **Documentation Updates**: Keep this documentation updated for any changes to the code or logical flow, ensuring that future developers understand the extension's purpose and functionality.

This documentation should effectively serve other developers or stakeholders looking to understand the "Spending Rewards Correlations" Tealium iQ extension.