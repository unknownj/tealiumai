# Tealium iQ Extension Documentation

## 1. Extension Overview

- **Name:** Compound Journey Analytics Props
- **ID:** 100040
- **Type:** Advanced Javascript Code
- **Scope:** 928
- **Execution Frequency:** On every page load

### Summary
This extension is designed to collect and format journey-related analytics properties from the global data layer into specific properties for use in analytics tracking. It consolidates journey information such as name, step, and state, as well as action and event details, into three distinct properties for improved tracking and reporting in your analytics platform.

---

## 2. Code Explanation

### Key Variables
- **Global Objects:**
  - `b`: Represents the global object where gobal variables like `JourneyName`, `JourneyStepName`, `ApplicationState`, etc., reside.
  - `s`: The analytics tracking object where the properties will be assigned.
  - `u`: An object that maps properties for use in Tealium.

### Logic Flow
1. The code begins by checking if the `JourneyName` exists in the global object `b`.
2. If it exists, three compound properties (`JourneyAnalytics1`, `JourneyAnalytics2`, `JourneyAnalytics3`) are constructed:
   - **JourneyAnalytics1:** Combines `JourneyName`, `JourneyStepName`, and `ApplicationState`.
   - **JourneyAnalytics2:** Combines `JourneyAction` and `JourneyActionNarrative`.
   - **JourneyAnalytics3:** Combines `JourneyEvent`, `EventAction`, and `EventNarrative`.
3. Each property undergoes a series of processing steps:
   - Conversion to string.
   - Stripping of semicolons.
   - Conversion to lowercase.
4. The final values are assigned to specific properties in the tracking object (`s.prop21`, `s.prop22`, `s.prop23`).
5. The mapping is updated in the object `u` for Tealium integration.

### Data Processing Steps
```javascript
// Example for JourneyAnalytics1
b.JourneyAnalytics1 = ([
  b.JourneyName,
  b.JourneyStepName || "None",
  b.ApplicationState || "None"
]).map(function(a) {
  return "" + a; // Convert to string
}).map(function(a) {
  return a.split(";").join(""); // Strip semicolons
}).map(function(a) {
  return a.toLowerCase(); // Convert to lowercase
}).join(".");
```

### Dependencies
- The function relies on global variables defined as properties of the object `b`, such as `JourneyName`, `JourneyStepName`, etc.
- It also uses the `s` object for setting analytics properties.

---

## 3. Usage Examples

### Normal Conditions
When `b` contains valid data:
- `b.JourneyName = "HomePage";`
- `b.JourneyStepName = "Step1";`
- `b.ApplicationState = "Active";`

The resulting properties:
- `s.prop21` will be set to "homepage.step1.active".

### Edge Conditions
When certain values may be absent:
- If `b.JourneyStepName` or `b.ApplicationState` is not defined:
```javascript
b.JourneyStepName = undefined;
b.ApplicationState = null; // Will default to "None"
```
- Resulting properties will be:
- `s.prop21` will be set to "homepage.none.none".

---

## 4. Known Limitations & Gotchas

- **Missing Data**: If `b.JourneyName` is not set, the entire logic will not execute, meaning no properties will be set.
- **Embedding**: Improper integration with other global scripts might cause conflicts if they manipulate the same properties in `b`.
- **Data Consistency**: It's important to ensure that all required properties (`JourneyName`, `JourneyAction`, etc.) are consistently structured in the data layer.

---

## 5. Recommendations for Refactoring

- **Defensive Checks**: While eventType and eventPayload are assured, it might be beneficial to check for the existence of other properties in `b` before processing.
- **Code Style**: Consider refactoring repeated code blocks (e.g., mapping and joining logic) into a helper function to enhance maintainability and readability.
- **Modularisation**: Break down the logic into distinct functions for each `JourneyAnalytics` property. This would improve clarity and ease future enhancements.

Example:
```javascript
function formatJourneyProperty(arr) {
  return arr.map(function(a) {
    return "" + a;
  }).map(function(a) {
    return a.split(";").join("");
  }).map(function(a) {
    return a.toLowerCase();
  }).join(".");
}
```

---

## 6. Maintenance & Further Notes

- **Ownership**: Assign a team member as the primary owner for ongoing documentation updates and implementation.
- **Testing Guidelines**: Regularly test the extension against various scenarios to ensure it reliably captures all required properties, especially after any changes in the data layer.
- **Version Control**: Use version control to manage changes and facilitate rollbacks if necessary.
- **Documentation Updates**: Keep the documentation current with any changes to the logic or data dependencies.

This document should serve as a comprehensive guide for current and future developers working with the Compound Journey Analytics Props extension in Tealium iQ.