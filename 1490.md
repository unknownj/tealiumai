# Tealium iQ Extension Documentation: GA360 : Set VirtualPathName

## 1. Extension Overview

- **Name**: GA360 : Set VirtualPathName
- **ID**: 1490
- **Type**: Advanced Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension is designed to generate a virtual URL for Google Analytics 360 (GA360) based on a structure that incorporates various data layer attributes. The virtual URL is structured to improve tracking and reporting in GA360 by providing clear paths that represent user interactions on the site. The extension performs multiple transformations and normalisations of product names and other relevant data to create consistent and meaningful URLs.

## 2. Code Explanation

### Key Variables
- **dl**: Data layer (context object) passed into the function containing various properties such as `ProductGroup`, `JourneyStep`, `PageRole`, etc.
- **v**: String representing the constructed virtual path.
- **hashAfterBang**, **hashSlashArray**: Variables used to parse and manipulate parts of the URL, specifically dealing with hash segments in the URL.

### Logic Flow
1. **Initialisation**: The function `outputVirtualUrlsAndTitles` starts by invoking another function, `buildVirtualURL`, which constructs the virtual path.
2. **Variable Normalisation**: The code normalises variables like product names to standardised formats, addressing variations in naming conventions.
3. **Conditional Logic**: Multiple conditional statements determine how to build the path based on the presence and state of various data layer properties.
4. **Final Construction**: The final virtual URL is constructed from different components and formatted to ensure consistency (e.g., removing white spaces and replacing them with dashes).
5. **Data Layer Updates**: The final constructed virtual path is written back into the data layer as `dl.VirtualPathName`.

### Dependencies
The code relies on:
- The existence of a data layer object (`dl`) provided to the function.
- Key properties within the data layer that must be correctly set for the code to function.

## 3. Usage Examples

### Normal Condition
- When a user navigates to a savings product page, the relevant data layer attributes (like `ProductGroup`, `JourneyStep`) are populated.
- The output might be a virtual URL like `/products/savings/application-state/journey-step`.

### Edge Condition
- If the `JourneyStep` is not defined, the function falls back to a simpler structure by skipping step data. For example, if `JourneyStep` is undefined, it may output `/products/savings/application-state`.

## 4. Known Limitations & Gotchas
- If any data layer properties required for normal operation are not set, unexpected results may occur or the virtual path might be incomplete.
- The handling of specific cases, such as checking for "top" and "bottom" within the hash, could lead to any misinterpretation of valid data.
- Conflicts may arise if other extensions manipulate the same data layer variables, potentially causing overwrites or unintended behaviours.

## 5. Recommendations for Refactoring
- **Modularisation**: Consider breaking the function down into smaller helper functions for better readability and maintenance.
- **Defensive Checks**: Although not required, validating the presence of `dl` attributes within the `buildVirtualURL` function could prevent runtime errors.
- **Code Style**: Ensure consistent indentation and spacing for improved readability. Comment blocks can be added to explain complex logic more clearly.

## 6. Maintenance & Further Notes
- **Ownership**: Assign clear ownership for updates and modifications; this should be maintained by the analytics team.
- **Testing Guidelines**: Create unit tests for various input scenarios, especially edge cases to ensure reliable functionality as the site evolves.
- **Documentation Updates**: Revise this documentation alongside any significant changes to the extension or its logic to ensure that it remains helpful for future developers.