# Tealium iQ Extension Documentation

## 1. Extension Overview

- **Name**: Celebrus RTIM BLR Code
- **ID**: 1507
- **Type**: Advanced Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension evaluates conditions based on the browser's hostname and other parameters to determine whether to enable Celebrus functionality (a Real-Time Interaction Management tool) and capture relevant lead data. It is designed primarily for specific financial institutions and their development and testing environments. The code checks specific hostnames and paths to manage the enabling or disabling of Celebrus features and subsequently listens for lead data.

## 2. Code Explanation

### Key Variables
- **`b`**: Represents the event payload, which carries data throughout the extension.
- **`LBGAnalytics`**: A global object that provides methods to manage leads and interactions.
  
### Logic Flow
1. **Environment Check**: 
   - If the environment is "dev" (development), `b.CelebrusEnabled` is set to "Y".
   - Additional checks determine if the hostnames contain specific substrings (like "luat", "mbna", "bankofscotland", etc.), enabling Celebrus functionality for those conditions.

2. **Path Evaluation**: 
   - If the URL path contains "gform", Celebrus is enabled.
   
3. **Hostname Exclusions**: 
   - Certain hostnames like "calculator.halifax.co.uk" and "mortgages.halifax.co.uk" will unset `b.CelebrusEnabled`, preventing Celebrus from being activated on those domains.
   
4. **Development Domain Check**: 
   - Checks if the hostname matches a series of development domains. If true, it sets `b.CelebrusPreProd` to true.
   - If set to be in "test" or not in "prod", it also sets `b.CelebrusPreProd` to true.

5. **Lead Data Handling**: 
   - If `LBGAnalytics.leads` exists, it gathers all CMS IDs and joins them into a string assigned to `b.RTIMImpressions`.

6. **Set Timeout for Lead Listening**: 
   - After a short delay (100 milliseconds), it attempts to call `listenForLeads()` and `checkNegativeClick()` on `LBGAnalytics.leads`. Errors here are silently caught.

### Dependencies
- This extension relies on the global `LBGAnalytics` object, which must be defined for the lead management functions to operate correctly. It also assumes that certain properties (`leads`, `Platform`, etc.) on the `b` object are present.

## 3. Usage Examples

### Normal Conditions
- For an environment configured as "dev":
  - `b.CelebrusEnabled` is set to "Y".
  
- When accessing `https://luat.example.com`:
  - `b.CelebrusEnabled` is set due to the presence of "luat" in the hostname.

### Edge Conditions
- Accessing `https://calculator.halifax.co.uk`:
  - `b.CelebrusEnabled` is deleted, preventing any Celebrus functionality.

- Operating in a development environment (like "localhost"):
  - `b.CelebrusPreProd` is set to true, allowing testing for non-production scenarios.

## 4. Known Limitations & Gotchas

- This extension expressly relies on specific hostnames and paths; adding or changing these may necessitate revisiting the logic.
- There is no use of defensive coding for the availability of `LBGAnalytics`. If this object is not defined, the lead handling logic fails.
- Conflicts may arise with other extensions where multiple scripts manipulate the same properties on `b`, which can lead to unpredictable results.

## 5. Recommendations for Refactoring

- **Error Handling**: The current error handling in the lead listening logic is minimal; consider implementing more robust logging where appropriate to assist with debugging.
- **Modularisation**: Break down complex checks into smaller functions for clarity and testability. For example, create functions that handle hostname checks or lead data manipulation.
- **Commenting**: Ensure that comments describe the rationale behind checks, especially for conditions that could appear cryptic.
- **Performance Optimisations**: Refactor the creation of `devdomains` into a separate utility function to avoid repeatedly creating the array within map and filter.

## 6. Maintenance & Further Notes

- **Ongoing Maintenance**: Regularly review environment variables and ensure that any new domains requiring Celebrus checks are added to the logic.
- **Ownership**: Assign a dedicated individual or team for ongoing support, making them responsible for updates and adjustments based on evolving business needs.
- **Testing Guidelines**: Implement thorough tests for both functional and edge cases. Ensure compatibility with all environments (prod, dev, test) to maintain optimal behavior across different setups.

---

This documentation serves as a guide for developers and stakeholders involved with the Tealium iQ extension for Celebrus RTIM. It is crucial to keep this document updated as changes are made to the extension or the conditions under which it operates evolve.