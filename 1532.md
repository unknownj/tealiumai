# Tealium iQ Extension Documentation: GA360 : Set GA360 page (&dp)

## 1. Extension Overview
- **Name**: GA360 : Set GA360 page (&dp)
- **ID**: 1532
- **Type**: Advanced Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension is designed to construct the Google Analytics 360 (GA360) page URL from the data layer (dl) variables. It determines whether to use a canonical URL or a virtual path based on the domain and context of the page being tracked. The generated URL includes query parameters collected from the data layer for enhanced reporting capabilities. This ensures accurate data collection across various scenarios and environments.

---

## 2. Code Explanation

### Key Variables
- `cd`: Canonical Domain from the data layer.
- `cp`: Canonical Path from the data layer.
- `vp`: Virtual Path Name from the data layer.
- `ga4vet`: GA4 Virtual Event Title from the data layer.
- `ctitle`: Document title (`dom.title`) from the data layer.
- Other query parameters (e.g., `qp.q`, `qp.term`, etc.) are used to build the final URL.

### Logic Flow
1. **URL Construction**:
   - The code checks the `cd` to determine which type of URL (canonical or virtual) it should construct.
   - Depending on the domain, it decides if it should set `ga_page` to `cp` (canonical) or `vp` (virtual).
   - It also checks for the environment (`ut.env`) and logs relevant information if in a development environment.

2. **Handling Query Parameters**:
   - The code tests for the presence of different query parameters to append them to the constructed URL.
   - If `qp_q`, `qp_term`, `qp_qp`, and `qp_l` are available, the `ga_page` is appended with appropriate values depending on their availability.

3. **Cross-Domain Linking and Search Parameters**:
   - It checks for `_ga` and `gclid` query parameters to ensure they are correctly included in the final URL.

### Dependencies
- The extension relies on global objects, particularly the `dl` (data layer), which must contain the expected properties for the extension to operate correctly.
  
---

## 3. Usage Examples

### Normal Scenario
1. A user visits a page on the Bank of Scotland website:
   - **Canonical Domain**: `secure.bankofscotland.co.uk`
   - **Canonical Path**: `/home`
   - This results in a GA360 page URL: `secure.bankofscotland.co.uk/home`.

### Edge Condition
2. A user accesses a virtual path on the Halifax site:
   - **Canonical Domain**: `aip.halifax.co.uk`
   - **Virtual Path Name**: `/fake-virtual-path`
   - **With Search Parameters**:
     - `qp_q`: `car`
     - `qp_term`: `car insurance`
   - The constructed URL would be: `aip.halifax.co.uk/fake-virtual-path?q=car&qp=undefined&l=undefined` since `qp_qp` and `qp_l` were not provided.

### Console Logging
In a development environment, the console will output:
```
GA360Page (&dp) is virtual: /fake-virtual-path
GA4VirtualEventTitle is virtual
```

---

## 4. Known Limitations & Gotchas

- The extension only processes the URL based on specific domain matching; thus, it may not work accurately for unexpected domains.
- If query parameters (`qp.q`, `qp.term`, `qp.qp`, `qp.l`) are not provided, the resultant URL may append `undefined`.
- Care should be taken to ensure that the data layer contains all the expected variables; if not, it may lead to empty or malformed URLs.
- Conflicts may arise with other extensions that manipulate the `dl` object encapsulating these parameters, particularly if they execute in a similar scope.

---

## 5. Recommendations for Refactoring

- **Defensive Checks**: Although eventType and eventPayload are guaranteed, consider implementing checks for other data layer properties to avoid potential failures.
- **Code Style**: Use consistent variable naming conventions and comments to enhance code readability.
- **Modularization**: Consider breaking down complex functions into smaller, reusable functions to improve maintainability.
- **Logging**: Include error handling and logging for issues beyond the basic construction, which can facilitate debugging in the event of incorrect URLs.

---

## 6. Maintenance & Further Notes

- **Ownership**: Define a clear ownership structure for this extension to ensure someone is accountable for updates and checks.
- **Testing Guidelines**: Establish a process to test URL generations in various environments (e.g., dev, staging, production) regularly.
- **Documentation Updates**: Keep this documentation updated with any changes in business logic or additional features added to the extension.

--- 

This structured documentation serves as a comprehensive guide for developers and stakeholders to understand, use, and maintain the GA360 : Set GA360 page (&dp) extension effectively.