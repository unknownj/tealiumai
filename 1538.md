# Tealium iQ Extension Documentation - Persistence BLR Code

## 1. Extension Overview
- **Name**: Persistence BLR code
- **ID**: 100040
- **Type**: Advanced Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
The **Persistence BLR Code** extension in Tealium iQ is designed to retrieve any persisted data items captured by the `LBGAnalytics` object and ensure they are added to the current event payload. This extension helps maintain a consistent data state across user sessions, ensuring that previously gathered information is not lost when new events are fired. It also streamlines the handling of specific cached items, such as impressions, by concatenating them if they exist in the payload.

---

## 2. Code Explanation

### Key Variables
- **`p`**: This variable retrieves the currently persisted data items using the `LBGAnalytics.persist.get()` method. It serves as the source of values we want to persist in the current event payload.
- **`k`**: This is a loop variable representing each key in the `p` object which holds the persisted data items obtained from the earlier step.
- **`b`**: Refers to the `eventPayload` passed as an argument, which is the object we aim to augment with persisted values.

### Logic Flow
1. The extension begins by fetching the persisted data items into the variable `p`.
2. It then iterates over each key in `p` using a `for...in` loop.
    - If the key does not already exist in `b`, it is added.
    - If the key already exists, a console warning is logged indicating that the value cannot be persisted because it is already set.
3. After processing the entries in `p`, if the `CachedImpression` key exists and is an array, the extension converts it into a semicolon-separated string.

### Dependencies 
- The extension relies on the global `LBGAnalytics` object which contains the method `persist.get()` for fetching persisted data. Ensure that this object is available in the global scope for the extension to function correctly.

---

## 3. Usage Examples

### Normal Conditions
- When a user navigates through the site, their interaction data (e.g., `CachedImpression`) gets stored persistently.
- On subsequent events (such as page views), this extension will retrieve the persisted data and add it to the event payload.
- If a page view event has not previously stored `CachedImpression`, it will not override it.

**Example**:
```javascript
// Assume CachedImpression was previously set to ['item1', 'item2']
eventType = 'page_view';
eventPayload = {};
// After running the extension, eventPayload will be: 
// { CachedImpression: "item1;item2" }
```

### Edge Conditions
- If `b` already contains a value for any key in `p` (i.e., due to conditions in earlier extensions), the console will display a warning, but the existing value will remain unchanged.
- If `CachedImpression` is not an array, it will not be processed as a semicolon-separated string.

**Example**:
```javascript
// For an eventPayload that mistakenly has 
// CachedImpression set as a string
eventType = 'page_view';
eventPayload = { CachedImpression: "item1" };
// After running the extension, the console will log:
// "Could not persist CachedImpression, value already set"
```

---

## 4. Known Limitations & Gotchas
- **Overwriting Values**: The extension will not replace existing values in `b`, which may lead to outdated information being retained inadvertently.
- **Non-Array CachedImpression**: If `CachedImpression` is not an array, it will not convert correctly, possibly leading to unexpected behaviour.
- **Dependency on `LBGAnalytics`**: Any absence or misconfiguration of the `LBGAnalytics` object will result in failure to load persisted data.
- **Console Warnings**: Important to monitor console logs during testing to catch any issues with data persistence.

---

## 5. Recommendations for Refactoring
- **Error Checking**: Consider validating that `p` is an object before iterating over it to avoid runtime errors.
- **Modularisation**: Separate the logic for retrieving persisted data and handling `CachedImpression` into distinct functions to enhance readability and maintenance.
- **Consistent Naming**: Use more descriptive variable names for clarity (e.g., `persistedData` instead of `p`).
- **Documentation Comments**: Enhance the inline comments to explain the logic and purpose behind each section of the code for future maintainers.

---

## 6. Maintenance & Further Notes
- **Ownership**: Designate a responsible team member for ongoing oversight of this extension to address future enhancements or issues promptly.
- **Testing Guidelines**: Regularly test the extension using a variety of event scenarios to ensure it operates as intended under different conditions.
- **Version Control**: Keep track of changes made to the extension code with comprehensive commit messages in version control to facilitate peer review and history tracking.

By following this structured documentation, developers and stakeholders can understand the purpose, functionality, and considerations surrounding the Persistence BLR Code extension in Tealium iQ.