# Tealium iQ Extension Documentation: AEM Link Tracking

## 1. Extension Overview
- **Name:** AEM Link Tracking
- **ID:** 100040
- **Type:** Advanced Javascript Code
- **Scope:** DOM Ready
- **Execution Frequency:** Run Once

### Summary
The AEM Link Tracking extension is designed to track user interactions with various link elements across a webpage. By capturing link click data, it enhances analytical capabilities to gather insights into user navigation behaviour. This information can then be leveraged to improve user experience and inform marketing strategies.

---

## 2. Code Explanation

### Key Variables
- **LBGAnalytics:** A global object that encapsulates application-based analytics functionalities.
- **$:** A jQuery reference used for DOM manipulation.
- **selector:** A CSS selector string identifying the links to track.
- **sectionName:** A custom name for the section of the page where the links are located.

### Logic Flow
1. **Adding Clicks to Links:**
   - The `addClicksToSection` method accepts a CSS selector and section name to gather and configure links for click tracking.
   - It retrieves the brand name from the data layer using `LBGAnalytics.datalayer.get("Brand")`.
   - The method creates an array of objects, each representing a link. Each object contains properties such as `linkArea`, `linkIndex`, `href`, and others.

2. **Link Properties:**
   - **linkDepth:** Determines the depth of the link within its parent structure.
   - **linkName:** Captured from link text or `aria-label`.
   - **linkAction:** Categorises links as 'samesite', 'samebrand', or identifies non-HTTP links.

3. **Storing Click Data:**
   - The `storeClickData` method saves click data to `sessionStorage` with an expiration time.
   
4. **Retrieving Click Data:**
   - The `retrieveClickData` method fetches stored click data from `sessionStorage` and checks if it has expired.

5. **Special Handling for Certain Domains:**
   - For specified hostnames, the extension performs additional disambiguation of link labels to track duplicate labels differently and append (link X) to distinguish them.

### Dependencies
- **jQuery:** This extension relies on jQuery for DOM manipulation and event handling.

---

## 3. Usage Examples

### Normal Conditions
- When a user clicks on a promotional link in the header, the extension captures the link details (area, depth, index, and name) and stores them in `sessionStorage`. This information may later be accessed or analyzed.

### Edge Conditions
- If the link's `href` attribute is missing, the extension assigns an empty string and tracks it accordingly. 
- If `sessionStorage` is full or has some retrieval issue, the `retrieveClickData` method will return `undefined`, ensuring that the application continues to function without crashing.

---

## 4. Known Limitations & Gotchas

- **URL Handling:** The extension may not adequately handle complex URL formats, such as those with query parameters or fragments, which could affect the `linkAction` categorisation.
- **Click Event Conflicts:** If other scripts manipulate the same link elements after this extension runs, there may be conflicts in the event handling.
- **Session Storage Limitations:** If `sessionStorage` reaches its limit, like max data per origin (5MB), new entries may fail to store.

---

## 5. Recommendations for Refactoring

- **Modularisation:** Consider encapsulating logic within standalone helper functions for reusability and clarity, such as functions for determining link action or constructing link values.
  
- **Defensive Checks:** Although not required here, consider adding validation for `href` attributes to improve resilience. For example, checks could be in place to handle unexpected data formats robustly.
  
- **Code Style Consistency:** Adopt consistent naming conventions across variables and method names (camelCase) to enhance readability.

- **Comments and Documentation:** Enhance inline comments to clarify complex logic sections for future maintainability.

---

## 6. Maintenance & Further Notes

- **Ongoing Maintenance:** Regularly check for any changes in the DOM structure that may affect the selectors used, and adapt the extension accordingly.
  
- **Ownership:** Assign a dedicated team member responsible for updates and functionality monitoring to ensure it remains effective as the site evolves.

- **Testing Guidelines:** Perform regression testing after modifications, especially in live environments. Ensure that any new DOM elements follow the tracking logic established in this extension.

By following these guidelines, the AEM Link Tracking extension can continue to effectively support analytics needs.