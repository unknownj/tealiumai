# Documentation for Tealium iQ Extension: GA360 : Persist JourneyStep

## 1. Extension Overview

- **Name**: GA360 : Persist JourneyStep
- **ID**: 1554
- **Type**: Persist Data Value
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
The "GA360: Persist JourneyStep" extension is designed to capture and persist the `JourneyStep` information for users who have navigated to specific journey events related to Personal Lending. It evaluates conditions surrounding the user's journey step, brand, and event type, ensuring accurate data capture for Google Analytics 360. This extension aids in tracking user interactions effectively, which is crucial for performance analysis and marketing optimisation.

---

## 2. Code Explanation

### Key Variables

- `a`, `b`: Parameters used in the immediately invoked function expressions (IIFE).
- `window.lpTag`: A global object that represents the LivePerson Tagging framework.
- `JourneyStepName`: A property on the `b` object that indicates the current step in the user's journey.

### Logic Flow

1. **Condition Validation**: The extension retrieves the `JourneyStepName` to check if it equals "overdraft referred pld". This check ensures that subsequent actions only occur when this specific journey step is in progress.
  
2. **Integration with LivePerson**: 
   - The extension checks if the `window.lpTag` object exists and confirms that the `newPage` method is available.
   - If all conditions are fulfilled, three timeouts are executed to call `lpTag.newPage()` with the current URL (`window.location.href`), thereby notifying LivePerson of a new page load after specific intervals (50ms, 1050ms, and 2050ms).

### Dependencies
This code relies on the presence of LivePerson SDK (represented by `window.lpTag`). If this dependency is absent, the code will not execute properly, potentially leading to missed tracking events.

---

## 3. Usage Examples

### Normal Condition Flow

1. **User Journey**: A user involved in a Personal Lending journey arrives at the "overdraft referred pld" step.
2. **Execution**: As the conditions are satisfied, the LivePerson tagging system is notified three times after specified delays about the page load.

### Edge Conditions

- **Non-Target Journey Step**: If the `JourneyStepName` is something other than "overdraft referred pld", the extension will not execute, resulting in no actions taken regarding LivePerson tagging.
  
- **Missing LivePerson SDK**: If `window.lpTag` is not available, the function does not call `newPage`, leading to potential tracking gaps.

---

## 4. Known Limitations & Gotchas

- **Timeout Timing**: The effectiveness of the timeouts is dependent on the load time of external resources. If the `newPage` function requires longer to be effective, it may lead to delayed data capture.
  
- **Dependency Management**: If `window.lpTag` is not available, the extension does not provide any fallback, silently failing to track the required data.

- **Complex Conditions**: The current design does not gracefully handle conditions if multiple `JourneyStep` or event types are introduced; this may lead to cumbersome code as requirements evolve.

---

## 5. Recommendations for Refactoring

1. **Code Modularity**: Consider modularising the function for clarity and ease of maintenance. For example, creating a separate function to handle the `newPage` calls could improve readability.
  
2. **Enhanced Logging**: Introduce additional logging to track when conditions are not met, which would aid in debugging.

3. **Handling Multiple Events**: If there is a potential for expanding the set of journey steps, implement a more dynamic condition handling mechanism to easily scale in the future.

4. **Defensive Checks**: Although not required, adding checks to validate the state of `JourneyStepName` prior to the comparison can help prevent errors in cases where data may be malformed or absent.

---

## 6. Maintenance & Further Notes

- **Ownership**: The responsibility for maintaining this extension should lie with a designated developer familiar with both Tealium iQ and LivePerson. Regular reviews are recommended to ensure compliance and functionality.

- **Testing Guidelines**: Establish a testing protocol to simulate various journey steps and the absence of the LivePerson tag to validate that the extension behaves as expected.

- **Change Logs**: Maintain a changelog to document any modifications made to the logic over time to facilitate easy management and understanding of the codeâ€™s evolution.

---

This documentation serves as a comprehensive guide to understanding, using, and maintaining the "GA360 : Persist JourneyStep" extension. It is crucial for all developers and stakeholders involved in this project to be familiarised with these details to ensure effective utilisation and support of the extension.