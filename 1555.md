# Extension Documentation: GA360 - Test for Duplicate Tag Load

## 1. Extension Overview
- **Name**: GA360 : Test for duplicate tag load
- **ID**: 1555
- **Type**: Advanced Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension is designed to prevent duplicate tag loads in specific customer journey scenarios. It compares data layer values `JourneyStep` and `JourneyUniqueID` with persisted values (`utag_main_js` and `utag_main_juid`). If duplicates are detected, the extension conveys this information by setting a boolean value into the variable `isPCADuplicateTagLoad`, helping to streamline the tracking of user interactions and ensuring data integrity across analytics platforms.

---

## 2. Code Explanation

### Key Variables
- **journey_step**: Value from the data layer representing the current step in the journey.
- **journey_step_cp**: Value from the persisted data layer variable indicating the journey step captured previously.
- **journey_unique_id**: Value from the data layer representing a unique identifier for the journey.
- **journey_unique_id_cp**: Value from the persisted data layer variable for unique identifier captured previously.

### Logic Flow
1. The function `test_for_dupe_tag_load` is defined to accept a data layer (`dl`) as an argument.
2. It retrieves the current and persisted values for both `journey_step` and `journey_unique_id`.
3. It performs a series of conditional checks:
   - If both persisted values are present and match the current values, it returns `true`.
   - If only the `journey_step_cp` is available, it checks if it matches `journey_step`; if it does, it returns `true`.
   - If both persisted values are `undefined` or `null`, it returns `false`.
   - In all other scenarios, it also returns `false`.
4. The result of this function is assigned to `b.isPCADuplicateTagLoad`.

### Dependencies
- The extension relies on global objects `eventType` and `eventPayload` as input parameters. It is assumed that these are present and correctly formatted when the extension is invoked.

---

## 3. Usage Examples

### Scenario 1: No Duplicates
- **Input**:
  - `dl.JourneyStep = "Step1"`
  - `dl.JourneyUniqueID = "UID123"`
  - `dl["cp.utag_main_js"] = "Step1"`
  - `dl["cp.utag_main_juid"] = "UID123"`
  
- **Output**:
  - `b.isPCADuplicateTagLoad` would be set to `true`.

### Scenario 2: Duplicate Detected
- **Input**:
  - `dl.JourneyStep = "Step1"`
  - `dl.JourneyUniqueID = "UID123"`
  - `dl["cp.utag_main_js"] = "Step1"`
  - `dl["cp.utag_main_juid"] = "UID456"`
  
- **Output**:
  - `b.isPCADuplicateTagLoad` would be set to `false`.

### Edge Case: Both Persisted Values Missing
- **Input**:
  - `dl.JourneyStep = "Step1"`
  - `dl.JourneyUniqueID = "UID123"`
  - `dl["cp.utag_main_js"] = null`
  - `dl["cp.utag_main_juid"] = null`
  
- **Output**:
  - `b.isPCADuplicateTagLoad` would be set to `false`.

---

## 4. Known Limitations & Gotchas
- If the data layer's properties (`JourneyStep`, `JourneyUniqueID`, or the persisted variables) are not defined or contain unexpected values, the extension might yield misleading results.
- The extension does not standardize checks for data types (e.g., comparing numbers with strings), which can lead to inconsistencies.
- Conflicts may arise if other extensions also manipulate `JourneyStep` or `JourneyUniqueID`, potentially leading to race conditions.

---

## 5. Recommendations for Refactoring
- **Defensive Checks**: Consider adding checks on data types for critical variables (`journey_step`, `journey_step_cp`, etc.) to ensure they are as expected.
- **Modularization**: Separating the logic for checking duplicates into helper functions may enhance readability and maintainability.
- **Improve Documentation**: Inline comments and documentation blocks can provide clarity on function purpose and expected input/output, aiding future developers.

---

## 6. Maintenance & Further Notes
- **Ownership**: Assign ownership to a specific team or individual for ongoing maintenance, ensuring they are familiar with both the functionality and the context in which the extension operates.
- **Testing Guidelines**: Establish a set of test cases that cover normal, edge, and error scenarios as part of the QA process when changes are made.
- **Version Control**: Keep track of changes in a version control system, ensuring updates are well-documented and changes in logic or functionality are clear to all stakeholders.

--- 

This documentation template can be used as a basis for sharing information about the extension among developers and stakeholders, ensuring clarity on functionality, usage, and maintenance.