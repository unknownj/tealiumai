# Tealium iQ Extension Documentation: Sampled Mappings of Foreign Keys

## 1. Extension Overview

- **Name**: Sampled Mappings of Foreign Keys
- **ID**: 1557
- **Type**: Advanced Javascript Code
- **Scope**: 928
- **Execution Frequency**: 1/100 (1% sample rate)

### Summary
This extension is designed to map specific properties in the Tealium `u.map` object based on a sampling mechanism. The extension collects data at a ratio of 1 in every 100 events (1%). If the sampling condition is met, it assigns pre-defined property values, effectively controlling which data gets sent to various reporting tools. This helps in optimising data ingestion and reducing unnecessary traffic during high-frequency events.

## 2. Code Explanation

### Key Variables
- **u**: Represents the Tealium global object which contains the `map` property used to store data that will be sent to various tags.
- **eventType**: The type of event that triggered the extension (passed as the first argument).
- **eventPayload**: The data associated with the event (passed as the second argument).
- **tagObject**: The object representing the tag context that can be used in extensions (passed as the third argument).

### Logic Flow
1. The extension begins by executing an anonymous function that accepts three parameters: `eventType`, `eventPayload`, and `tagObject`.
2. It generates a random number between 0 and 99 using `Math.floor(100 * Math.random())`. 
3. If the generated number equals 0 (which occurs approximately 1% of the time), the extension executes the following assignments:
   - Sets `u.map.SectionID` to "prop46"
   - Sets `u.map.TargetProperty` to "prop47"
   - (Commented Out) Sets `u.map.PegasusTagName` to "prop48"
   - Sets `u.map.GA360Page` to "prop49"
   
### Dependencies
This extension relies on the global object `u`, which is part of the Tealium library. There are no external libraries or dependencies involved.

## 3. Usage Examples

### Normal Conditions
- When the event is triggered about 100 times, this extension will assign values to the `u.map` properties in only one of those instances. Assuming the event is called once a second, only once per minute will the properties `SectionID`, `TargetProperty`, and `GA360Page` be set.

### Edge Conditions
- If for any reason the function does not encounter the random condition (e.g., if the random number generator failed), the `u.map` properties will not be set, which might lead to partial data being sent to any analytics tools that rely on those mappings.
- In scenarios where events occur in quick succession, it is possible that no data gets sampled, resulting in no valuable `u.map` entries.

## 4. Known Limitations & Gotchas

- **Sampling Limitation**: At a 1% sampling rate, there is a chance that critical events may not be captured, potentially skewing data if the sample size is too small.
- **Commented-out Code**: The line that assigns `u.map.PegasusTagName` is commented out. If needed, this line will need to be uncommented and maintained separately.
- **Potential Conflicts**: Other extensions modifying the `u.map` object might overwrite these values if not properly structured, leading to unintended data loss or overrides.

## 5. Recommendations for Refactoring

- **Modularisation**: Consider separating the sampling logic into its own function to enhance readability and testing capabilities.
- **Error Handling**: Introduce checks to ensure that the properties being set in the `u.map` are valid and do not inadvertently overwrite critical mappings from other extensions.
- **Maintainability**: Document the purpose of each mapping being set in the `u.map` for future reference, making it easier for other developers to understand the code's intent.

## 6. Maintenance & Further Notes

- **Ownership**: Designate a developer or team responsible for this extension's upkeep, ensuring they regularly review the mappings for relevancy based on analytics needs.
- **Testing Guidelines**: Regularly test the extension in a staging environment to confirm that sampling behaves as expected and that the mappings are correctly set in different scenarios.
- **Deployment**: Use version control for tracking changes and updates to the extension. Document each change made in this extension for easier rollbacks if issues arise.

By following these guidelines, you can ensure that the "Sampled Mappings of Foreign Keys" extension remains effective, reliable, and maintainable over its lifecycle.