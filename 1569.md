# Tealium iQ Extension Documentation: Set Eloqua Eligibility

## 1. Extension Overview

- **Name**: Set Eloqua eligibility  
- **ID**: 1569  
- **Type**: Advanced Javascript Code  
- **Scope**: Before Load Rules  
- **Execution Frequency**: Run Always  

### Summary
The "Set Eloqua eligibility" extension is designed to determine the eligibility of users for tracking their email visits through Eloqua by setting a specific cookie based on the current URL parameters. If the URL contains the parameter `elqtrack`, it sets a cookie to facilitate tracking; if the cookie is already set, it ensures that tracking continues.

---

## 2. Code Explanation

### Key Variables
- `a` and `b`: Input parameters, where `a` represents eventType, and `b` is the eventPayload object that will be modified based on the extension's logic.

### Logic Flow
1. The extension checks the current URL for the presence of the `elqtrack` parameter.
    - If found:
        - It sets a cookie named `AddEloqua` with the value `true`, accessible across the entire website (`path=/`).
        - It also modifies the `TrackEmailVisit` property in the `eventPayload` object to `1`.
2. If the parameter is not found, it checks whether the `AddEloqua` cookie already exists.
    - If the cookie exists:
        - It again sets the `TrackEmailVisit` property in the `eventPayload` object to `1`.

### Dependencies
The code depends on:
- The global objects `window` and `document`, which are standard in web browsers.

---

## 3. Usage Examples

### Normal Conditions
- **Scenario 1: User visits with Eloqua tracking** (URL contains `elqtrack`):
  - **Input**: URL = `http://example.com/page?elqtrack=1`
  - **Output**: Cookie `AddEloqua` is set to `true`, and `eventPayload.TrackEmailVisit` is `1`.

### Edge Conditions
- **Scenario 2: User visits without tracking and has the cookie set**:
  - **Input**: URL = `http://example.com/page`
  - **Existing Cookie**: `AddEloqua=true`
  - **Output**: `eventPayload.TrackEmailVisit` is set to `1`.

- **Scenario 3: User visits without tracking and without the cookie**:
  - **Input**: URL = `http://example.com/page`
  - **Existing Cookie**: `None`
  - **Output**: `eventPayload.TrackEmailVisit` remains unchanged.

---

## 4. Known Limitations & Gotchas

- The cookie `AddEloqua` might conflict with other applications or scripts that use the same cookie name, leading to unexpected behaviour.
- The extension expects that tracking only occurs when cookies are enabled in the user's browser.
- If any external scripts modify or delete cookies, the behaviour of this extension may be affected.
- The use of `document.cookie` may not be compatible with privacy-focused browser settings or extensions that block tracking technologies.

---

## 5. Recommendations for Refactoring

- **Defensive Checks**: Introduce checks to ensure that cookies can be set successfully, as well as validating cookie properties.
- **Code Style**: Consistently use `===` for strict equality checks instead of `>=`.
- **Modularisation**: Consider breaking out the functionality into smaller functions for clarity. For instance, one function to handle setting cookies and another to manage the tracking logic, aiding in readability and testing.
- Document additional expected behaviours and edge cases for clarity to other developers who may modify or maintain this code in the future.

---

## 6. Maintenance & Further Notes

- **Ownership**: It is advised that the marketing or analytics team oversees the maintenance of this extension, given its direct relationship with Eloqua tracking.
- **Testing Guidelines**: Ensure thorough testing in various browsers and environments to confirm compatibility and consistent behaviour. This includes testing with different user scenarios to verify the correct setting of cookies and event payloads.
- **Ongoing Maintenance**: Regularly check for updates or changes in external tracking requirements and adjust the logic of this extension accordingly to maintain performance and accuracy.

--- 

This documentation serves as a comprehensive guide for understanding, utilizing, and maintaining the "Set Eloqua eligibility" extension within Tealium iQ.