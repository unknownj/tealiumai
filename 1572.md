# Tealium iQ Extension Documentation: Clean up upgrade link account nicknames

## 1. Extension Overview

- **Name**: Clean up upgrade link account nicknames
- **ID**: 100040
- **Type**: Advanced Javascript Code
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension is designed to modify specific account link values before they are sent to the server. It specifically targets account link strings that include the phrase ",upgrade account". The purpose of this cleanup is to standardise these links by ensuring they consistently follow a specific format that includes a prefix of "/CHQ."

## 2. Code Explanation

### Key Variables
- `a`: Represents the event type (not explicitly used within the function).
- `b`: Represents the event payload object containing the key-value pairs that need processing.

### Logic Flow
1. The function checks if the property `LinkValue` on the event payload (object `b`) is a string and contains the phrase ",upgrade account".
   - If true, the string is split by the "/" delimiter.
   - The first two segments of the split array are retained, and then a new string is constructed by appending "/CHQ,upgrade account".
  
2. A similar process is repeated for another property `WTP:WT.ac`, if it is also a string containing the same phrase.

### Dependencies
- The extension relies on the global context, specifically the `eventPayload` object (denoted as `b`). 
- It assumes that `eventPayload` will always contain the fields `LinkValue` and `WTP:WT.ac`, as guaranteed.

## 3. Usage Examples

### Normal Operations
- **Incoming Data**:
  - `LinkValue`: "/account/123,upgrade account"
  - `WTP:WT.ac`: "/service/456,upgrade account"

- **Processing Result**:
  - Modified `LinkValue`: "/account/123/CHQ,upgrade account"
  - Modified `WTP:WT.ac`: "/service/456/CHQ,upgrade account"

### Edge Cases
- **Scenario**: Incoming with no specified upgrade account.
  - `LinkValue`: "/account/123"
  - Result: Remains unchanged.

- **Scenario**: Incoming with slightly different casing or format.
  - `LinkValue`: "/account/123,Upgrade Account"
  - Result: Still modified to "/account/123/CHQ,upgrade account".

- **Scenario**: Malformed or unexpected data.
  - `LinkValue`: ""
  - Result: Remains unchanged as no processing occurs.

## 4. Known Limitations & Gotchas

- **String Format**: Assumes that the `LinkValue` and `WTP:WT.ac` are always strings. If these properties are not available or are in a different format, the logic will not apply.
- **Global Scope Dependency**: If other extensions modify the `eventPayload` object before this extension executes, it may lead to unexpected results.
- **Multiple Occurrences**: If the extension runs multiple times, duplicated modifications may occur if the incoming data is not sanitised beforehand.

## 5. Recommendations for Refactoring

- **Code Style**: Consider improving readability by adding descriptive comments for each block of logic.
- **Modularisation**: Extract the string processing into a separate function to adhere to the single responsibility principle. Example:

    ```javascript
    function cleanupLink(link) {
        return link.split("/").splice(0, 2).join("/") + "/CHQ,upgrade account";
    }
    ```

- **Logging**: Implement simple logging for debugging purposes, so that if the behaviour is unexpected, the logs can help identify issues.

## 6. Maintenance & Further Notes

- **Ongoing Maintenance**: Regularly review for updates to related extensions that may impact this one. The Tealium environment can experience changes, so alignment with best practices should be an ongoing process.
- **Ownership**: Assign a developer responsible for monitoring and testing this extension.
- **Testing Guidelines**: Ensure thorough testing is performed after each deployment, especially after code changes or updates to the environment. Unit tests may be considered for internal verification of functionality.

---

This documentation enables easy understanding and sharing of the extensionâ€™s purpose, functionality, and maintenance considerations for any developer or stakeholder within the project.