# GA360 : XD : Handle Cross-Track Params : Receiving Pages

## 1. Extension Overview

- **Name**: GA360 : XD : Handle cross-track params : receiving pages
- **ID**: 1584
- **Type**: Advanced JavaScript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
This Tealium iQ extension is designed to capture Google Analytics Client ID (_ga) and the associated _gid parameter from the URL, either from the fragment, query string, or persisted values in the data layer. The captured values are then set within the `udo` (User-Defined Object) for use in tracking user sessions and interactions accurately. This is particularly useful for cross-domain tracking scenarios to ensure continuity in analytics data.

## 2. Code Explanation

### Key Variables
- `passed_ga_cid`: Captured Google Analytics Client ID from the URL.
- `passed_gid`: Captured Google Analytics Session ID (_gid) from the URL.
- `persisted_ga_cid`: Persisted Google Analytics Client ID from previous tracking.
- `persisted_gid`: Persisted Google Analytics Session ID (_gid) from previous tracking.
- `google_cookie_ids`: An array holding the captured Client ID and Session ID.

### Logic Flow
1. The function `capture_ga_cid_and_gid_from_url(dl)` checks for the availability of the _ga or _gid values in the data layer's URL components.
2. It first checks if the _ga value is present in the fragment:
   - If present, it splits the string to retrieve the Client ID and _gid, logging this information in development mode.
3. If not found in the fragment, it checks the query string for _ga.
4. Next, it looks up persisted IDs saved in the data layer (`cp.utag_main_xd_cid` and `cp.utag_main_xd_gid`).
5. It will then check cookies if neither the fragment nor query string has the values:
   - It retrieves existing Client ID and _gid values if they are available.
6. Finally, the values are set in the `udo` under `GA360ClientID` and `GA360gid` using the function `set_google_cookies_in_udo(dl)`.

### Dependencies
- This extension relies on the following global data layer properties:
  - `dl.dom.hash`: To extract the fragment.
  - `dl.qp._ga`: To extract the query string.
  - `dl.cp.utag_main_xd_cid` and `dl.cp.utag_main_xd_gid`: For previously persisted values.
  
Additionally, it checks the `ut.env` property to determine if it is running in a development environment for logging purposes.

## 3. Usage Examples

### Scenario 1: Standard Flow
- **URL Fragment**: `https://example.com/#_ga=GA1.2.123456789.987654321`
  - **Behaviour**: The Client ID `123456789` and _gid are logged and set in the data layer.
  
### Scenario 2: Query String
- **URL**: `https://example.com/?_ga=GA1.2.987654321.123456789`
  - **Behaviour**: The extension captures the Client ID from the query string and populates `GA360ClientID` and `GA360gid`.

### Scenario 3: Persisted Value
- **Condition**: The URL does not have _ga or _gid, but the values are saved within the data layer from previous interactions.
  - **Behaviour**: It retrieves the persisted values and assigns them to `GA360ClientID` and `GA360gid`.

### Edge Case: No Available Identifiers
- If no _ga or _gid values are available in any source, the function logs "No _ga available".

## 4. Known Limitations & Gotchas
- **Missing _ga or _gid**: If both parameters are absent, it will return false, which may lead to failure in analytics tracking.
- **Development Logging**: Console logs are enabled for development mode, which may clutter the console if not managed.
- **Overlapping Data**: If multiple extensions attempt to manipulate or fetch the same identifiers concurrently, conflicts may arise.

## 5. Recommendations for Refactoring
- **Modularisation**: Consider breaking down large functions into smaller units for improved readability and maintainability.
- **Error Handling**: Implement checks for expected structures within the data layer to prevent runtime errors.
- **Documentation**: Improve in-line comments to clarify logic steps and the purpose of each section of code.
  
For defensive coding, ensure that each split operation has a corresponding structure check to avoid unexpected results.

## 6. Maintenance & Further Notes
- **Ownership**: Assign ownership of this extension to a team member familiar with analytics data structures.
- **Testing**: Regular checks should be performed during development cycles, especially when updates are made to related tracking mechanisms.
- **Version Control**: Keep a versioning system in place to track changes and updates to the extension over time.

This structured documentation aims to facilitate understanding, usage, and future enhancements of the extension, ensuring its effective integration within the landscape of analytics tracking.