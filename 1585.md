# Tealium iQ Extension Documentation

## 1. Extension Overview

- **Name:** GA360 : XD : Persist xd_gid
- **ID:** 1588
- **Type:** Persist Data Value
- **Scope:** After Load Rules
- **Execution Frequency:** Run Always

### Summary
This extension serves to ensure that the `xd_gid` value, used for cross-domain tracking in Google Analytics 360 (GA360), is persisted correctly across different domains of related brands. It dynamically generates an array of cross-track domains based on the brand specified in the data layer (`dl.Brand`). This capability is essential for seamless tracking of user interactions across multiple sub-domains or associated domains, critical for accurate analytics and user behaviour analysis.

---

## 2. Code Explanation

### Key Variables
- **`brand`**: A variable derived from the `dl.Brand`, indicating the current brand context.
- **`domains`**: An array holding the list of domains associated with the given brand.

### Logic Flow
1. The function `set_cross_track_domains(dl)` is invoked, passing the entire data layer object (`dl`).
2. The code checks the value of `dl.Brand`:
   - If it matches "Halifax", it assigns Halifax-related domains to the `domains` variable.
   - If it matches "Lloyds", it assigns Lloyds-related domains.
   - If it matches "BOS", it assigns Bank of Scotland domains.
3. The generated domains are then assigned to the `cross_track_domains` property of the global object `b`.

### Dependencies
- The extension relies on the global data layer object represented as `dl`.
- It utilizes `b`, which is typically used in Tealium for managing data values and configurations.

---

## 3. Usage Examples

### Normal Condition
If the data layer is structured as follows:
```javascript
var dl = { Brand: "Halifax" };
```
When `set_cross_track_domains(dl)` is executed, the `cross_track_domains` property in `b` would be set to `["halifax.co.uk", "halifax-online.co.uk", "halifaxsharedealing-online.co.uk"]`.

### Edge Condition
If the `Brand` in the data layer is set to a value not matched in the function (e.g., `dl.Brand: "UnknownBrand"`), the function will return `undefined`. As a result, `b.cross_track_domains` remains unchanged or could lead to unexpected behaviour if other parts of the code depend on this property being defined.

---

## 4. Known Limitations & Gotchas

- **Undefined Behaviour**: If the brand is not among the predefined cases ("Halifax", "Lloyds", "BOS"), the `cross_track_domains` will not be set, which may lead to undefined behaviour or incorrect tracking.
- **Hardcoded Values**: The domains are hardcoded; any updates to domain lists will require a code update and deployment.
- **Dependencies on Global State**: The extension relies on the presence of the `dl` structure and the existence of `b`. Any changes in the order of execution could impact the extension negatively.
  
Potential conflicts may arise if other extensions modify the `cross_track_domains` at the same execution stage.

---

## 5. Recommendations for Refactoring

- **Input Validation**: While no defensive checks are required, consider implementing logging for unexpected brands to facilitate troubleshooting in production.
- **Modularisation**: Break down the `set_cross_track_domains` logic into smaller, testable functions, especially if new brands are expected in the future.
- **Code Comments**: Enhance inline comments to clarify the purpose of each block of code, improving readability and maintainability.
- **Avoiding Duplication**: If the brand logic extends further, consider using an object literal for brand mappings to eliminate repetitive code.

---

## 6. Maintenance & Further Notes

### Ongoing Maintenance
- Frequently review and update domain lists as brand strategies evolve.
- Consider setting up monitoring to detect cases where `cross_track_domains` remains undefined to capture any anomalies in data tracking.

### Ownership
- Assign a team or individual to be responsible for the oversight of this extension, ensuring it aligns with business needs and analytics strategies.

### Testing Guidelines
- Conduct regression testing whenever the extension is modified.
- Simulate various scenarios in a testing environment to check how data is persisted under different brand conditions.

By maintaining thorough documentation and following best practices, this extension can continue to serve its purpose effectively within the Tealium iQ ecosystem.