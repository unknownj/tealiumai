# Tealium iQ Extension Documentation - Adobe Virtual Pageviews

## 1. Extension Overview
- **Name**: Adobe Virtual Pageviews
- **ID**: 100040
- **Type**: Advanced Javascript Code
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
The Adobe Virtual Pageviews extension is designed to integrate with Adobe Target, enabling the tracking of virtual page views within a web application. This functionality is particularly useful for tracking user interactions on single-page applications (SPAs) or other dynamic pages where traditional page views cannot be captured. By triggering Adobe Target's `triggerView` method, the extension allows marketers and analysts to track user engagement and improve the personalisation of web experiences.

## 2. Code Explanation

### Key Variables
- **LBGAnalytics.triggerView**: An object that encapsulates all methods related to triggering Adobe Target views, including enabling/disabling view tracking, invoking views, and managing event history.
- **eventType**: Represents the type of event that has occurred (passed to the IIFE).
- **eventPayload**: Contains additional information regarding the event, including JourneyName and JourneyStepName.

### Logic Flow
1. **Initialization**: The extension checks if the `triggerViewAvailable` method can access `adobe.target.triggerView`. If not, it will try to handle cookies directly using `document.cookie`.
 
2. **Cookie Management**: Functions are defined to enable or disable tracking based on cookie settings. If cookies are disabled, the extension attempts to manage cookies through `document.cookie`.

3. **Event Invocation**:
    - Uses the `invoke` method to trigger an Adobe Target view when certain conditions based on `eventType` and the journey name are met.
    - Checks for duplicate invocations to avoid sending the same view name multiple times in succession.
    - Uses `setTimeout` for delayed triggering of views to ensure they occur in the right sequence based on user interactions.

### Dependencies
- The extension depends on the global `LBGAnalytics` object for cookies management.
- Requires the Adobe Target library to be available for functionality.

## 3. Usage Examples

### Normal Conditions
- If an event of type "view" occurs and provides a `JourneyName` and `JourneyStepName`, the extension will invoke the Adobe Target view corresponding to that journey.
  
  **Example**:
  ```javascript
  eventType = "view";
  eventPayload = { JourneyName: "UserJourney", JourneyStepName: "Step1" };
  // Result: Adobe Target triggers a view named "UserJourney.Step1".
  ```

### Edge Conditions
- If the `JourneyName` or `JourneyStepName` is absent during a "view" event, the invocation will not occur.
  
  **Example**:
  ```javascript
  eventType = "view";
  eventPayload = {}; // No Journey details provided
  // Result: No Adobe Target view will be triggered.
  ```

- If the user has cookies disabled or the `triggerViewDisabled` cookie exists, the extension will skip invoking the Adobe Target view even if the conditions are met.

## 4. Known Limitations & Gotchas
- The extension relies on the presence of the `LBGAnalytics` object and Adobe Target's `triggerView` method. If either is not available, the extension will not operate as intended.
- The cookie settings may clash with other scripts managing user consent, leading to potential failures in tracking if not correctly aligned.
- Frequent triggering of views in quick succession may lead to duplicates being pushed to the event history, unless handled (which is currently managed by the `forceDuplicate` parameter).
  
## 5. Recommendations for Refactoring
- **Defensive Checks**: Although the presence of `eventType` and `eventPayload` is guaranteed, additional checks for the structure of `eventPayload` could help avoid potential runtime issues.
  
- **Code Style**: Standardise the use of single quotes throughout the codebase for consistency.
  
- **Modularization**: Consider breaking down larger functions (like `invoke`) into smaller, single responsibility functions, making the code more readable and easier to test.

- **Error Handling**: Introduce try-catch blocks around segments calling external libraries (like Adobe Target) to gracefully handle errors rather than failing silently.

## 6. Maintenance & Further Notes
- **Ownership**: The responsible team for maintaining this extension should be composed of individuals familiar with JavaScript and Adobe Target.
- **Testing Guidelines**: Regular testing should occur alongside Adobe Target updates to ensure compatibility.
  
- **Documentation Updates**: Keep this documentation updated with any changes to the extension or its usage based on feedback from developers or changes in dependencies.

---

This documentation aims to assist developers in understanding the Adobe Virtual Pageviews extension's functionality and encourage best practices for usage and maintenance.