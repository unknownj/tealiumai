# Tealium iQ Extension Documentation

## 1. Extension Overview

- **Name:** Event Stream Data Mappings
- **ID:** 1609
- **Type:** JavaScript Code
- **Scope:** 1459
- **Execution Frequency:** On every event triggering

### Summary
The "Event Stream Data Mappings" extension processes and maps specific variables from a given payload to enable streamlined data flow into EventStream. It ensures only relevant data is sent based on variable names and marketing consent, facilitating better data governance and compliance with privacy regulations.

---

## 2. Code Explanation

### Key Variables
- **eventStreamVariables:** An array of variables that the code ensures will always be included in the EventStream mapping.
- **eventStreamVariablePrefixes:** An array of prefixes; if a variable name starts with any of these prefixes, it will be included in the mapping.
- **eventStreamCMVariableRemoves:** An array of variables that will be removed from the payload if marketing consent is not present.

### Logic Flow
1. **Initial Variable Setup:** Three arrays (for mandatory variables, prefixes, and consent-based removals) are defined.
2. **Adobe Analytics Variables:** The code attempts to push any variables defined in the Adobe Analytics tag (if it exists) into the `eventStreamVariables` array.
3. **Prefix-Based Mapping:** The code checks the incoming payload for variable names that match any of the defined prefixes and adds them to `eventStreamVariables`.
4. **Payload Cleaning:** It iterates through the incoming `eventPayload` and deletes any variables not present in the `eventStreamVariables`.
5. **Consent Mode Handling:** If the user has not provided marketing consent, any variables listed in `eventStreamCMVariableRemoves` will be deleted from the payload.
6. **Presentation Family Setting:** It sets a default value for `b.PresentationFamily` if it is not already defined.

### Dependencies
The code relies on the global `utag` object, specifically `utag.sender[928].map`, for accessing Adobe Analytics variables.

---

## 3. Usage Examples

### Normal Operation
When a typical event payload is received, the extension processes the incoming data, retains defined variables, and removes any not specified. 

**Input Payload Example:**
```json
{
  "click_id": "abc123",
  "source": "Google",
  "AccountID": "12345"
}
```

**Output Payload After Processing:**
```json
{
  "click_id": "abc123",
  "source": "Google"
}
```

### Edge Condition: No Marketing Consent
If the user does not provide marketing consent, sensitive information will be removed.

**Input Payload Example:**
```json
{
  "click_id": "abc123",
  "source": "Google",
  "AccountID": "12345"
}
```

**Consent Not Provided (b["CookiesTargeting"] is false):**
**Output Payload:**
```json
{
  "click_id": "abc123",
  "source": "Google"
}
```

### Edge Condition: Adobe Analytics Tag Missing
If the Adobe Analytics tag is not present, the extension will still function, and the event mappings will not include variables from it.

---

## 4. Known Limitations & Gotchas

- If the Adobe Analytics tag (`utag.sender[928]`) is not present, any attempt to access properties under it will result in an error, which is currently caught but not logged. 
- The processing could be hindered by payloads with a large number of variables, potentially leading to performance issues.
- Conflicts may arise if other extensions modify payload structure moments before this code executes, as this extension assumes it is the last to process the payload.

---

## 5. Recommendations for Refactoring

1. **Defensive Checks:** Consider adding logging for key catch blocks to assist in troubleshooting potential errors silently.
2. **Code Style:** For readability, consider adopting a consistent indentation style (2 spaces is common in JavaScript) to enhance clarity.
3. **Modularization:** Separate the consent logic and variable collection into separate functions for improved maintainability and testing.
4. **Commenting:** Ensure that comments provide not only functional descriptions but also context for why certain decisions were made, enhancing the understanding for future developers.

---

## 6. Maintenance & Further Notes

- **Ownership:** Assign a single developer or team responsible for overseeing the extension's lifecycle.
- **Testing:** Implement a robust testing framework, including unit tests for key functions to ensure accuracy in mappings. Simulate various payload scenarios to assess behaviour under differing conditions.
- **Ongoing Review:** Regularly review and update the extension to align with current data governance policies and integration with other tools.

---

This documentation serves as a comprehensive guide for understanding, using, and maintaining the "Event Stream Data Mappings" extension within Tealium iQ. Please ensure to share this with your team for consistent knowledge sharing and operational continuity.