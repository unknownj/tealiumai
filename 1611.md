# Tealium iQ Extension Documentation: Application State Events

## 1. Extension Overview

- **Name**: Application State Events
- **ID**: 1611
- **Type**: Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
The `Application State Events` extension monitors application state changes and triggers analytics events for various states. By capturing these application's states (e.g., "Application", "Offered", "Fulfilled", etc.), it enables more granular analytics and tracking, which can be crucial for understanding user journeys and conversion events in digital applications. The extension prevents duplicate entries by maintaining an array of already encountered states, ensuring that analytics events are dispatched appropriately.

## 2. Code Explanation

### Key Variables
- **`aState`**: Represents the current application state pulled from the `b.ApplicationState` object.
- **`LBGAnalytics.asTracker`**: An array that tracks unique application states.

### Logic Flow
1. **Initialization**: The code checks whether `LBGAnalytics.asTracker` exists and whether `aState` is defined.
2. **First Time State Check**:
   - If `asTracker` doesn't exist, it is initialized with the current `aState`.
3. **Subsequent State Check**:
   - If `asTracker` exists:
     - The code checks if `aState` is already in `asTracker`.
     - If not present, it adds `aState` to `asTracker`.
     - If `b.JourneyUniqueID` is not present, specific generic events are triggered based on the value of `aState`.
     - Finally, a catch-all event (ID: `407`) is dispatched, indicating a new application state was tracked.

### Dependencies
- **Global Objects**: 
  - `LBGAnalytics`: Expected to be an existing global object that includes methods for event tracking.
  - `eventType` and `eventPayload`: Expected to be declared and passed correctly into the function as per the Tealium setup.

## 3. Usage Examples

### Scenario 1: Normal Application State Transition
- **Input**: `b.ApplicationState` is set to "Application".
- **Behaviour**: 
  - The application state "Application" will be added to `LBGAnalytics.asTracker`.
  - If `b.JourneyUniqueID` is absent, `LBGAnalytics.events.genericEvent(28)` will trigger.
  - The catch-all event `407` is also dispatched.

### Scenario 2: Duplicate State
- **Input**: Subsequent call with `b.ApplicationState` set to "Application".
- **Behaviour**: 
  - The state is already in `asTracker`, so no action is taken on the unique event triggers.

### Scenario 3: New State, Unique
- **Input**: `b.ApplicationState` is now "Offered".
- **Behaviour**: 
  - "Offered" is added to `asTracker`.
  - If no `b.JourneyUniqueID`, `LBGAnalytics.events.genericEvent(29)` triggers.
  - Event `407` will also be dispatched.

### Edge Condition
- **Input**: `b.ApplicationState` set to `null` or an unrecognised value.
- **Behaviour**: 
  - The extension exits without triggering any events as it relies on valid states.

## 4. Known Limitations & Gotchas
- **No Duplication Handling**: The extension does not manage cases where application states might need to be reset or re-evaluated upon specific user actions or page reloads.
- **Library Dependency**: If `LBGAnalytics` is not correctly initialised or not available on the page, the extension will fail silently without any error logging.
- **Event ID Management**: The hard-coded event IDs (28-32, 407) limit extensibility; changes to event tracking would require updates within the extension directly.

## 5. Recommendations for Refactoring
- **Error Handling**: Introduce logging functionality to highlight when states are not valid or when an expected object is missing. While defensive coding was excluded, consider simple logging for debugging.
- **Modularisation**: Break the function down into smaller, named functions for improved readability and maintainability. For example, separate methods for adding to `asTracker` and firing events could enhance clarity.
- **Constant Definition**: Consider defining constants for event IDs at the top of the code, making the purpose of each ID clearer and easier to manage.
  
## 6. Maintenance & Further Notes
- **Ownership**: Assign a specific owner for this extension who is responsible for updates and tracking any analytics-related changes.
- **Testing Guidelines**: Regularly test the extension in various environments (staging and production) following major updates to ensure compatibility and desired behaviour.
- **Documentation Maintenance**: Keep this documentation up-to-date with any changes made to functionality, dependencies, or usage scenarios.

By adhering to the suggestions outlined, this extension can remain robust and effective in supporting tracking application state transitions in a dynamic environment.