# Tealium iQ Extension Documentation: Travel Money Preference Rates

## 1. Extension Overview
- **Name**: Travel money pref rates
- **ID**: 100036
- **Type**: Javascript Code
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
The "Travel money pref rates" extension detects user interactions during the "Buy Travel Money" journey and determines if a preferential rate is offered. By evaluating the current journey step and the presence of a preferential rate indicator in the DOM, it assigns user attributes accordingly. This functionality helps in personalising user experiences and tracking customer segments more accurately.

---

## 2. Code Explanation

### Key Variables
- **`a`**: Represents the event type (e.g., "view").
- **`b`**: Represents the event payload containing relevant journey information such as `JourneyName` and `JourneyStep`.
- **`prefRates`**: A DOM element collection containing elements with the class `get-a-quote-page__pref-rate-icon`, which signifies the presence of preferential rates.

### Logic Flow
1. **Timeout Function**: The code waits for 3000 milliseconds (or 3 seconds) before executing the logic to allow the page to load completely.
2. **Journey Detection**: It checks if the `JourneyName` in the payload is "BuyTravelMoney".
3. **Step Validation**: It evaluates whether the `JourneyStep` is either "2" (string) or `2` (number).
4. **Attribute Assignment**: If the event type is "view", it checks for the presence of preferential rates in the DOM:
   - If `prefRates` exists, the customer is tagged with "Preferential rate".
   - If not, the customer is tagged with "Standard rate".
5. The values are then sent to the `LBGAnalytics` for further processing.

### Dependencies
- The code relies on the `LBGAnalytics` global object for tracking customer segments and sending event data.

---

## 3. Usage Examples

### Scenario 1: Normal Behaviour
1. A user lands on the "Buy Travel Money" page and the journey step is "2".
2. The extension waits for 3 seconds for the page to fully load.
3. If the preferential rate icon is found in the DOM, it assigns the "Preferential rate" segment to the user.

### Scenario 2: Edge Condition (No Preferential Rate)
1. A user lands on the same page; however, no preferential rate indicators exist.
2. After the 3-second delay, the extension assigns the "Standard rate" segment to the user since `prefRates` returns an empty collection.

### Data Flow
- Input: Event type and payload containing journey information.
- Output: Customer attribute as either "Preferential rate" or "Standard rate", sent to `LBGAnalytics`.

---

## 4. Known Limitations & Gotchas
- **DOM Dependency**: The extension relies on class names being accurate and present in the DOM. If the website's structure changes, the extension might fail to detect the preferential rate.
- **Event Timing**: The 3-second delay may not always be appropriate depending on the page load speed; users with slower connections might experience delayed attribute assignment.
- **Conflicts**: If other scripts manipulate the DOM elements or event tracking simultaneously, there could be potential conflicts leading to inaccurate data capture.

---

## 5. Recommendations for Refactoring
- **Defensive Checks**: Although not required, consider adding checks to ensure `prefRates` is defined before accessing its length to prevent potential errors in future updates.
- **Code Style**: Maintain consistent formatting, such as proper indentation and spacing for readability.
- **Modularisation**: Break the inline function into smaller functions if possible to enhance maintainability and testability.

---

## 6. Maintenance & Further Notes
- **Ownership**: Assign ownership to a developer familiar with the user journey associated with this extension for ongoing updates.
- **Testing Guidelines**: Every time there is an update to the underlying website structure or the `LBGAnalytics` library, conduct comprehensive regression testing to ensure the extension operates as expected.
- **Documentation Updates**: Ensure that any changes in functionality, dependencies, or behaviour are reflected in this documentation for clarity and future maintainability.

--- 

This documentation has been formatted to be easily shareable and comprehensible to both developers and stakeholders, capturing all relevant details for efficient understanding and ongoing management of the Tealium iQ extension.