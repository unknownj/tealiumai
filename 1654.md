# Tealium iQ Extension Documentation

## 1. Extension Overview
- **Name**: Tealium Event Definitions
- **ID**: 1654
- **Type**: Javascript Code
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
This Tealium iQ extension is designed to define custom Tealium events based on the application state and user interactions within an application flow. Specifically, it evaluates user actions as they navigate through a web application, determining related events for tracking user journeys. This helps in capturing meaningful engagement data required for analytics and reporting.

## 2. Code Explanation

### Key Variables
- **a**: Represents the event type (string), such as "view".
- **b**: Represents the event payload (object), which includes various attributes related to the application state, product group, and user journey.

### Logic Flow
1. **Event Cleanup**: If the incoming event is of type "view", it deletes any existing `tealium_event` to avoid confusion with previous events.
  
2. **Application State Checks**: The extension assesses the application's state:
   - If the state is "Fulfilled", "Offered", "Application", or "Declined" along with valid `ProductGroup` and `JourneyName`, it assigns a corresponding `tealium_event` (e.g., "journey_completion", "journey_summary").

3. **Caching Logic**: It utilises an array `tescache` to avoid redundant tracking of the same `tealium_event` within a single page load session.

4. **Logon and Registration Events**: The extension checks the current pageâ€™s pathname to assign specific events (e.g., "logon" or "online_registration") when users reach designated logon or registration pages.

5. **Fallback Event Assignments**: If no `tealium_event` has been defined through the prior checks, it defaults to categorise the interaction as "journey_interaction" or "brochureware_view".

### Dependencies
- The extension relies on the global javascript object `LBGAnalytics` to store a cache of previously seen events. It assumes this object is defined and accessible in the global context.

## 3. Usage Examples

### Scenario 1: User completes a journey
- **Input**: 
  - `eventType`: "view"
  - `eventPayload`: `{ ApplicationState: "Fulfilled", ProductGroup: "Home Loans", JourneyName: "Loan Application" }`
- **Output**: `b.tealium_event` is set to `"journey_completion"`.

### Scenario 2: User views brochureware
- **Input**: 
  - `eventType`: "view"
  - `eventPayload`: `{ ProductGroup: "Insurance", PageRole: "Brochureware" }`
- **Output**: `b.tealium_event` is set to `"brochureware_view"`.

### Edge Condition: Redundant Event
- **Input**: 
  - First application state event is handled, and `LBGAnalytics.tescache` contains `"journey_start"`.
- **Output**: If another occurrence of `"journey_start"` is detected, it will be discarded.

## 4. Known Limitations & Gotchas
- **Application State Dependency**: The extension relies heavily on the attributes `ProductGroup`, `JourneyName`, and `ApplicationState`. Missing these can lead to no `tealium_event` being assigned.
- **Cache Limitations**: The caching mechanism (`tescache`) accumulates events throughout the session which might unintentionally suppress tracking of subsequent events.
- **Filter Overlap**: If multiple elements of the code set a `tealium_event`, the last one to execute will prevail, potentially leading to unintended event definitions.

## 5. Recommendations for Refactoring
- **Defensive Coding**: Consider adding checks for the existence of critical properties (`ApplicationState`, `ProductGroup`, `JourneyName`) before evaluating them.
- **Modularity**: Group similar event assignment logic into separate functions to improve readability and maintenance.
  ```javascript
  function assignJourneyEvent(appState, productGroup, journeyName) {
      // Logic here to assign event
  }
  ```
- **Commenting**: Increase inline comments to clarify the logic for new developers unfamiliar with the system. 

## 6. Maintenance & Further Notes
- **Ownership**: Designate a developer or team responsible for reviewing and updating the extension.
- **Testing Guidelines**: Run unit tests every time changes are made to the extension to ensure that existing functionality remains intact.
- **Documentation Updates**: Regularly update the documentation to reflect changes in logic or functionality, especially after significant updates or bug fixes.

By following the above documentation and recommendations, developers can ensure that the extension functions correctly while being easy to understand and maintain.