# Tealium iQ Extension Documentation: Adobe Track Callbacks

## 1. Extension Overview
- **Name**: Adobe Track Callbacks
- **ID**: 1655
- **Type**: Javascript Code
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension is designed to manage and log analytics events sent to Adobe's tracking system. It captures both pre and post tracking callback events, ensuring that specific parameters are tracked during different stages of the tracking process. The primary purpose is to store these URLs for logging while enabling subscriber functions to process successful events collectively. This supports robust event logging and enhances visibility into analytics flow.

## 2. Code Explanation
### Key Variables
- **LBGAnalytics.analyticsBeaconLog**: An array to store the URLs of analytics events sent.
- **LBGAnalytics.prop4log**: An object that maintains the state of specific property logs (identified by `c4`)
  
### Logic Flow
1. **Initial Setup**: The extension first checks if `LBGAnalytics.analyticsBeaconLog` is defined. If it isn't, it initializes the log array and registers a post-track callback.
   
2. **Post-Track Callback**: Whenever an event is sent via Adobeâ€™s tracking system, the registered callback logs the URL and notifies any subscribers about the updated status of unique URLs. It also provides console output indicating an analytics event has been sent.

3. **Pre and Post Tracking Handling**: It checks for the presence of `LBGAnalytics.prop4log`:
   - **Pre-Tracking**: A callback is registered to handle pre-track events. It extracts parameter values from the request URL that begin with `c4=`.
   - **Post-Tracking**: A similar callback registers post-track events, marking tracked URLs in the `LBGAnalytics.prop4log`.

4. **Failed Events Logging**: An object property `FailedEvents` is populated with c4 keys that did not end with a post callback, allowing for easy identification of any events that hit process failures.

### Dependencies
- The extension relies on the global object `LBGAnalytics` being available prior to its execution.
- It assumes that the `s` variable, which refers to the tracking object (such as `s` in Adobe's AppMeasurement), is accessible and properly set up in the environment.

## 3. Usage Examples
### Normal Operation
1. **Event Trigger**: When an event that includes `c4=<value>` is tracked:
   - The corresponding pre and post track callbacks execute, updating `LBGAnalytics.prop4log` for that event.

2. **Logging Events**: Subscribed functions receive notifications whenever an URL is logged, allowing for further processing.

### Edge Conditions
1. **Missing c4 Parameter**: If an event is triggered without a valid `c4` parameter:
   - The extension will not log it in `LBGAnalytics.prop4log`, and as a result, this will be reflected in the `FailedEvents` string.

2. **Multiple Event Submissions**: If events with the same `c4` value are sent:
   - The logging mechanism will ensure that duplicates are filtered out, preventing redundancy in analytics reporting.

## 4. Known Limitations & Gotchas
- **Subsequent Calls**: If `LBGAnalytics` is reconstructed or reset after the initial setup of this extension, prior setups will be lost. Care should be taken to ensure that this extension is executed in the correct order relative to others.
  
- **Sequential Calls**: Depending on the timing of events being pushed to Adobe's system, there may be race conditions that could miss callbacks if not properly sequenced with respect to Adobe's processing.

- **Browser Compatibility**: Ensure that the use of JavaScript (especially callback and higher-order functions like `forEach`, `map`, and `filter`) is supported across all target browsers, considering ES5 compliance.

## 5. Recommendations for Refactoring
- **Modularisation**: Consider encapsulating the callback registration logic into separate functions to improve readability and maintainability. This can be done by creating methods like `registerPreTrackCallback` and `registerPostTrackCallback`.

- **Error Handling**: While there are no defensive coding recommendations for `eventType` and `eventPayload`, consider implementing error tracking inside the callbacks to log unexpected failures during execution.

- **Code Style**: Maintain consistency in naming conventions for better readability. Consider commenting significant blocks to clarify their purpose for future developers.

## 6. Maintenance & Further Notes
- **Ownership**: Assign a team member to oversee the extension's updates and overall functionality, ensuring it aligns with evolving analytics needs.

- **Testing Guidelines**: Regularly test the extension after any change to the related Tealium setup or Adobe implementation, focusing on checking the integrity of the `analyticsBeaconLog` and the `FailedEvents` logs.

- **Documentation Updates**: Keep the documentation up-to-date with any changes made to the logic, especially if new requirements are introduced regarding logging or data handling.