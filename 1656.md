# Tealium iQ Extension Documentation

## 1. Extension Overview

- **Name**: Custom CCC QueryString override  
- **ID**: 100036  
- **Type**: Javascript Code  
- **Scope**: After Load Rules  
- **Execution Frequency**: Run Always  

### Summary
This extension is designed to capture specific query string parameters from the URL when the user accesses a path containing `/ccc/`. If parameters such as `pnic`, `aggso`, or `so` are found, they are used to define the `CustomerSegment` property in the `eventPayload` object. This allows for enhanced segmentation capabilities in tracking by leveraging query string data.

## 2. Code Explanation

### Key Variables
- **a**: Represents `eventType`, which is a string indicating the type of event being processed.
- **b**: Represents `eventPayload`, which is an object containing data relevant to the event.

### Logic Flow
1. A self-invoking function is defined, taking `eventType` and `eventPayload` as parameters.
2. It checks if the `CustomerSegment` property on the `eventPayload` object (`b`) is not already defined and whether the current URL path contains `/ccc/`.
3. If both conditions are met, the function retrieves and processes the query string from the URL using the following steps:
   - Converts the query string to lower case.
   - Splits it into separate key-value pairs.
   - Reduces the pairs into an object where keys are the query parameter names and values are the decoded values.
4. If `pnic`, `aggso`, or `so` parameters are present in the query string, `CustomerSegment` is set to respective values, prefixed with "PNIC:", "AGGSO:", or "SO:" as appropriate.

### Global Dependencies
- The extension relies on the global `window` object to access the URL and its query parameters. 
- It also assumes that the `eventPayload` object contains a `CustomerSegment` property which is initially undefined.

## 3. Usage Examples

### Normal Conditions
- **Scenario**: A user visits `https://www.example.com/ccc/?pnic=123&aggso=456`.
  - **Outcome**: 
    - The `CustomerSegment` is set to "PNIC:123".
    - The `eventPayload` after execution: 
      ```javascript
      {
          CustomerSegment: "PNIC:123"
      }
      ```
  
### Edge Conditions
- **Scenario**: A user accesses `https://www.example.com/ccc/?so=ABC`.
  - **Outcome**: 
    - The `CustomerSegment` is set to "SO:ABC".
    - The `eventPayload` after execution: 
      ```javascript
      {
          CustomerSegment: "SO:ABC"
      }
      ```

- **Scenario**: A user visits `https://www.example.com/other-path/?pnic=789`.
  - **Outcome**: 
    - The extension does not execute as the path does not contain `/ccc/`.
    - The `eventPayload` remains unchanged.

- **Scenario**: A user visits `https://www.example.com/ccc/?pnic=123&aggso=456&so=ABC`.
  - **Outcome**: 
    - Only the first parameter found (in this case, `pnic`) is used for `CustomerSegment`. 
    - The `eventPayload` after execution would be: 
      ```javascript
      {
          CustomerSegment: "PNIC:123"
      }
      ```

## 4. Known Limitations & Gotchas

- **Condition Check**: The extension only executes when the path contains `/ccc/` and the `CustomerSegment` is undefined. If there are multiple accesses to this path with the same query parameters, the `CustomerSegment` will not be updated.
- **Parameter Overlap**: When multiple relevant query parameters are present, only the first defined parameter (`pnic`) is considered, while others are ignored. This could lead to unintended customer segmentation if not properly managed externally.
- **External Interference**: Additional scripts on the page that manipulate the `eventPayload` object could potentially conflict with this extension’s intended operation.

## 5. Recommendations for Refactoring

- **Code Style**: Ensure consistent spacing and indentation for better readability.
- **Defensive Checks**: While you do not need to implement checks for the existence of `eventType` and `eventPayload`, consider adding checks for the query parameters—e.g., if `qs` object is empty, it might not be necessary to proceed.
- **Modularity**: Consider extracting the query string processing logic into a separate function for improved readability and reuse.
- **Commenting**: Add inline comments to clarify the role of each section of code for future maintainers.

## 6. Maintenance & Further Notes

### Ongoing Maintenance
- Regularly review the extension to ensure it operates correctly under different query string conditions and user scenarios.
- Be attentive to changes in URL structure or patterns of usage that may impact query string relevance.

### Ownership
- Designate a developer or a team responsible for the ongoing management of this extension. Ensure they keep abreast of updates to Tealium iQ and its integration capabilities.

### Testing Guidelines
- Implement thorough testing for various scenarios, such as:
  - No query parameters.
  - Multiple parameters present.
  - Accessing URLs outside of the target path.
  
Documenting test cases will facilitate future regression testing and identify if the extension behaves as expected after any changes.

---

Make this documentation accessible to all relevant stakeholders to ensure a shared understanding of the extension's functionality and standards for future development.