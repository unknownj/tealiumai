# Tealium iQ Extension Documentation

## 1. Extension Overview

- **Name**: Event Stream Data Source
- **ID**: 1659
- **Type**: JavaScript Code
- **Scope**: 1459
- **Execution Frequency**: On every data layer event trigger

### Summary
The **Event Stream Data Source** extension determines the appropriate data source for events based on specific conditions concerning environment (development, QA, or production) and brand. It is designed to provide distinct data source identifiers to facilitate tracking and event management for different environments and brands, ensuring accurate data collection and reporting.

---

## 2. Code Explanation

### Key Variables
- **`a`**: Represents `eventType`, the type of the event being processed.
- **`b`**: Represents `eventPayload`, an object containing additional data about the event.
- **`u`**: Represents `tagObject`, inferred from the execution context.

### Logic Flow
1. The function begins by checking if the `ut.env` property in the `eventPayload` is set to either "dev" or "qa". If this condition is met, it assigns the `tealium_datasource` property to `"i19fjp"` for testing.
   
2. If the environment is not "dev" or "qa", it checks if a web view is detected through the `WebviewDetected` property in the `eventPayload`.

   - If no web view is detected, it assigns specific `tealium_datasource` values based on the `Brand` property, mapping each brand to a unique data source identifier:
     - **Lloyds**: "9jlcvk"
     - **Halifax**: "ggb62r"
     - **BOS**: "x5ubve"
     - **MBNA**: "1x364w"
     - **Scottish Brands**: "3u9wrh" (matched using a partial string check)

   - If a web view is detected, it similarly assigns different `tealium_datasource` values for the corresponding brands:
     - **Lloyds**: "wbwgsq"
     - **Halifax**: "l3ngc9"
     - **BOS**: "3r7dyw"
     - **MBNA**: "uvbir8"
     - **Scottish Brands**: "4abplt" (matched using a partial string check)

### Dependencies
- The extension relies on specific properties in the `eventPayload` object (`ut.env`, `WebviewDetected`, and `Brand`) to determine which data source to assign.
- No external libraries are referenced in the current implementation.

---

## 3. Usage Examples

### Normal Conditions
- If the environment is set to "dev" and the brand is "Lloyds":
  ```javascript
  b["ut.env"] = "dev";
  b["Brand"] = "Lloyds";
  // Result: b.tealium_datasource will be set to "i19fjp"
  ```

### Edge Conditions
- If the `Brand` is "BOS" and `WebviewDetected` is false in a production environment:
  ```javascript
  b["ut.env"] = "prod";
  b["Brand"] = "BOS";
  b["WebviewDetected"] = false;
  // Result: b.tealium_datasource will be set to "x5ubve"
  ```

- If the `Brand` contains the term "Scottish" and `WebviewDetected` is true:
  ```javascript
  b["ut.env"] = "prod";
  b["Brand"] = "Scottish Widows";
  b["WebviewDetected"] = true;
  // Result: b.tealium_datasource will be set to "4abplt"
  ```

---

## 4. Known Limitations & Gotchas

- The extension does not handle situations where `Brand` is undefined, which could lead to the `tealium_datasource` property remaining unset.
- Care must be taken to ensure that the property checks (`WebviewDetected` and `Brand`) align correctly with the expected data in all environments.
- Conflicts could arise if other extensions manipulate the same `b.tealium_datasource` property post this extension execution.

---

## 5. Recommendations for Refactoring

- **Defensive Coding**: Introduce checks to ensure relevant properties exist within `eventPayload` before accessing them.
- **Code Style**: Consider standardizing the condition checks using a dictionary approach to eliminate repetitive code, such as:
  ```javascript
  var dataSources = {
      "Lloyds": {"dev": "i19fjp", "qa": "i19fjp", "default": "9jlcvk"},
      // Add other brands here
  };
  ```
- **Modularization**: Extract the logic for assigning `tealium_datasource` into smaller helper functions to enhance readability and maintainability.
  
---

## 6. Maintenance & Further Notes

### Ongoing Maintenance
- Regularly review the mappings for `tealium_datasource` values to ensure they remain current as business needs evolve.
- Test the extension thoroughly in each environment (development, QA, production) to validate that the logic functions as intended.

### Ownership
- Assign a primary owner responsible for maintaining the extension, ensuring that changes in branding or environment settings are promptly reflected in the code.

### Testing Guidelines
- Implement a suite of unit tests that validate the functionality across various conditions and edge cases to ensure robustness of the extension.

--- 

This comprehensive documentation should assist developers and stakeholders in understanding, using, and maintaining the **Event Stream Data Source** extension effectively.