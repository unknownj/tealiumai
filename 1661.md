# Tealium iQ Extension Documentation: ContentSquare Custom Variables

## 1. Extension Overview

- **Name:** ContentSquare Custom Variables
- **ID:** 1661
- **Type:** JavaScript Code
- **Scope:** 1471
- **Execution Frequency:** On page view (indicated by the condition `if(a === "view")`)

### Summary
This extension is designed to facilitate the collection of custom variables for the ContentSquare analytics platform. It extracts relevant values from the event payload (`eventPayload`) based on predefined mappings, formats them appropriately, and assigns them to the `_uxa` array for use in ContentSquare tracking. This allows for enriched data collection regarding user interactions and page elements, which aids in analytics reporting.

---

## 2. Code Explanation

### Key Variables

- **`csDefinitions`**: An object mapping ContentSquare variable names to their corresponding values in the `eventPayload`. This structure defines the variables that will be processed.
  
- **`csVariables`**: A new object created by reducing over `csDefinitions`. This object will hold formatted strings of variables derived from the mapping.

- **`csVariableIDs`**: An array containing IDs of variables to be set as custom variables on the `_uxa` object.

### Logic Flow
1. **Mapping Definitions**:
   - Utilises `csDefinitions` to define the relationships between ContentSquare variables and corresponding data in the `eventPayload`.
   
2. **Variable Extraction**:
   - Uses `Object.keys()` and `reduce()` to iterate through each key in `csDefinitions`, pulling values from `eventPayload` and formatting them into a string separated by " > ".
   
3. **Adobe Match Key Handling**:
   - Attempts to extract the `AdobeMatchKey` from the `eventPayload` using string manipulation. If successful, it adds this key to the `csVariables`. If it fails (due to the absence of the expected data format), it silently catches and ignores the error.
   
4. **Data Pushing**:
   - If the `eventType` is `"view"`, the extension pushes custom variable data to the `window._uxa` array, with each variable associated with a corresponding index (1-based).

### Dependencies
- **Global Objects**:
  - `window._uxa`: Expected to be an existing array that will be extended with custom variables.
- **Library**: No external libraries are required; it leverages standard JavaScript functionalities.

---

## 3. Usage Examples

### Scenario 1: Normal Data Flow
When the `eventType` is `"view"` and the `eventPayload` contains valid properties, the following might occur:
- `eventPayload` contains:
  ```json
  {
    "PageRoleFamily": "Homepage",
    "ProductFamily": "Clothing",
    "Brand": "Nike",
    "CanonicalDomainProd": "example.com",
    "cp.AMCV_230D643E5A2550980A495DB6%40AdobeOrg": "MCMID|123|"
  }
  ```
- The resulting `window._uxa` may look like:
  ```javascript
  window._uxa = [
    ['setCustomVariable', 1, 'Brand', 'Nike'],
    ['setCustomVariable', 2, 'Channel', 'DivisionValue'],
    // ... other variables
    ['setCustomVariable', 10, 'AdobeMatchKey', '123']
  ];
  ```

### Scenario 2: Edge Condition
If `cp.AMCV_230D643E5A2550980A495DB6%40AdobeOrg` does not follow the expected format, or is absent:
- The extension catches the error silently, and `AdobeMatchKey` will not be present in the `csVariables` object, preventing an addition to `_uxa` and leaving it unaffected by potential errors.

---

## 4. Known Limitations & Gotchas

- **Error Handling**: The current implementation fails silently on any error during the extraction of `AdobeMatchKey`. It may be beneficial to log or handle such errors more transparently.
- **Dependency on Naming**: The extension is explicitly dependent on property names remaining consistent within the payload. Any change in these names will result in missing variables.
- **Global State**: Since it modifies the `window._uxa`, ensure that other scripts do not conflict through variable overwrites or modifications.

---

## 5. Recommendations for Refactoring

- **Defensive Checks**: Consider implementing checks for the existence of required properties in the `eventPayload` before attempting to access them, to enhance robustness.
  
- **Function Modularization**: Break down the logic into smaller functions (e.g., a function to extract variables, a function to format them, and another to handle error logging).
  
- **Consistent Naming**: Standardise property names within the code and documentation to avoid potential confusion.

- **Enhanced Error Logging**: Introduce logging for caught errors, providing visibility into issues during data processing.

---

## 6. Maintenance & Further Notes

- **Ownership**: Assign a dedicated team or individual responsible for updates and modifications to ensure this extension keeps pace with business needs and any external requirements.
  
- **Testing Guidelines**:
  - Regularly validate the functionality of the extension with different payloads to ensure that all expected conditions are covered.
  - Incorporate unit tests for each modular function to catch potential regressions during updates.

- **Documentation**: Update documentation with any changes made to the extension logic promptly, ensuring that all stakeholders remain informed.

--- 

This structured documentation should assist you in effectively communicating the purpose, usage, and maintenance of the ContentSquare Custom Variables extension to developers and stakeholders alike.