# ContentSquare Custom Variables Extension Documentation

This document provides a comprehensive overview and explanation of the "ContentSquare Custom Variables" Tealium iQ extension. It details the extension's purpose, code logic, usage examples, known limitations, recommendations for refactoring, and guidelines for maintenance.

---

## 1. Extension Overview

- **Name:** ContentSquare Custom Variables  
- **Extension ID:** 1661  
- **Extension Type:** Javascript Code  
- **Scope:** 1471  
- **Execution Frequency:**  
  - Runs on every page view in which the eventType is "view".  
  - Executed during the mapping of Tealium data layer values (i.e. eventPayload) to ContentSquare custom variables.

**Summary:**  
This extension aggregates various data layer values defined in the Tealium tag map and maps them to the ContentSquare custom variables. Specifically, it consolidates multiple data points by:
  
- Grouping related fields from the data layer (using the predefined `csDefinitions` object).
- Concatenating non-empty values using a delimiter (" > ").
- Pushing these mapped custom variables to the global ContentSquare queue (`window._uxa`) so that ContentSquare can record them.  
- Attempting an additional extraction of an Adobe-related variable (`AdobeMatchKey`) via parsing of a data layer variable.

The extension is designed to seamlessly convert Tealium tag object properties into a format consumable by ContentSquare for analytics tracking.

---

## 2. Code Explanation

### Key Variables

- **csDefinitions:**  
  An object that defines mapping keys (e.g. "PageRole", "ProductGroup") where each key corresponds to an array of potential Tealium data layer property names.  
  - Example: `"PageRole": ["PageRoleFamily", "PageRole"]`

- **csVariables:**  
  A new object generated by iterating over `csDefinitions`. For each key in `csDefinitions`, the code:
  - Maps over the array of possible Tealium property names.
  - Extracts the corresponding values from the `tagObject` (second parameter `b` in the IIFE).
  - Filters out any falsy values.
  - Joins the resulting non-empty values with the separator " > ".  
  This creates a string representation for each custom variable.

- **csVariableIDs:**  
  An array defining the order and keys of the custom variables that will be sent to ContentSquare. Important for ensuring correct ordering when calling the ContentSquare API method `setCustomVariable`.

- **AdobeMatchKey Extraction:**  
  The `try` block attempts to extract a value from a Tealium data layer property (with a key resembling `cp.AMCV_230D643E5A2550980A495DB6%40AdobeOrg`):
  - It splits on "MCMID|" and "|" to extract a match identifier.
  - On failure during extraction, the error is silently caught.

### Logic Flow

1. **Data Mapping:**  
   - The extension begins by building the `csVariables` object.  
   - It loops over the keys in `csDefinitions`, maps corresponding data layer values from the `tagObject` (variable `b`), and joins them if available.

2. **AdobeMatchKey Handling:**  
   - An attempt is made to parse a specific Adobe variable:
     - If successful, the parsed value is stored in `csVariables.AdobeMatchKey`.
     - If the extraction fails, the error is caught silently without interrupting execution.

3. **Setting Custom Variables:**  
   - The extension defines an array `csVariableIDs` to set the order in which custom variables should be pushed.  
   - It initializes the global ContentSquare array (`window._uxa`) if not already present.
   - For each custom variable identifier in `csVariableIDs`, if the `eventType` equals "view", it pushes an array (which represents the ContentSquare `setCustomVariable` call) containing:
     - A custom variable index (starting from 1).
     - The custom variable key.
     - The corresponding value from `csVariables`.

4. **Global Object Dependencies:**  
   - The code depends on the global variable `window._uxa`, a ContentSquare queue that records custom variable assignments.  
   - It uses the `tagObject` (passed as parameter `b`) to access various data values.
   - The parameters `eventType` and `eventPayload` are assumed to be available as guaranteed inputs from Tealium.

### Dependencies

- Relies on the presence of the global `window` object and specifically `window._uxa`.
- Requires a pre-configured Tealium data layer with properties as specified in `csDefinitions` and the Adobe property.
- No external library dependencies are used in this code; it is written in plain ES5-compatible JavaScript.

---

## 3. Usage Examples

### Normal Conditions

- **Scenario:** A basic page view where all the expected data layer fields are populated.
  - For example, `tagObject` contains values for "PageRoleFamily", "ProductFamily", "Brand", etc.
  - The extension will:
    - Map and join the values as per the definitions.
    - Push a series of `setCustomVariable` commands into `window._uxa` for ContentSquare.
  - **Flow:**  
    1. `csDefinitions` is processed â€“ non-empty values are concatenated using " > ".
    2. Example: For "ProductGroup", if "ProductFamily", "ProductGroup", and "ProductSubGroup" are present, the value might become "Electronics > Mobile Devices > Smartphones".
    3. AdobeMatchKey is also parsed from the Adobe property if available.
    4. `window._uxa` receives pushes such as `[ 'setCustomVariable', 1, 'Brand', 'Sony' ]`.

### Edge Conditions

- **Scenario:** Missing Data Layer Values
  - If none of the defined keys for a particular custom variable are present in the `tagObject`, then:
    - The concatenation will result in an empty string (or a falsey value which may be filtered out).
    - The extension still pushes a custom variable, but its value is an empty string.
- **Scenario:** AdobeMatchKey Parsing Failure
  - If the Adobe variable is not present or incorrectly formatted:
    - The `try` block catches the error silently.
    - `csVariables.AdobeMatchKey` remains undefined.
    - The custom variable for AdobeMatchKey might then be either not set properly or remain as an empty string when consumed by ContentSquare.
- **Scenario:** Execution on Non-View Events
  - The loop that pushes the custom variable setting commands only runs if the event is a page view (i.e. eventType equals "view"). For other event types, no custom variables are pushed.

---

## 4. Known Limitations & Gotchas

- **AdobeMatchKey Extraction:**
  - The extraction logic assumes a very specific format for the Adobe property. If the format changes even slightly, the extraction may fail silently due to the catch block.
  
- **Data Layer Dependency:**
  - The extension depends on consistent naming in the Tealium data layer. If any data layer field names change, the logic mapping may not reflect the correct values.
  
- **Silent Failure:**
  - The code uses a try-catch block for AdobeMatchKey extraction that does not log errors. This can make debugging harder when Adobe data is missing or unexpectedly formatted.
  
- **Order Dependency:**
  - The order of custom variables is defined by the `csVariableIDs` array. Any changes here must be carefully managed to ensure that ContentSquare receives the expected variable order.

- **Global Object Conflicts:**
  - Since the extension directly pushes into `window._uxa`, any other script modifying `_uxa` concurrently or prior may lead to conflicting values or unintended overwrites.

---

## 5. Recommendations for Refactoring

- **Defensive Checks and Logging:**
  - While defensive coding for the availability of `eventType` and `eventPayload` is not required, consider:
    - Adding logging (console logging or error tracking) within the catch block for AdobeMatchKey extraction to aid in debugging.
  
- **Modularisation:**
  - Consider refactoring the transformation logic into well-named helper functions to improve readability:
    - A function to map `csDefinitions` to `csVariables`.
    - A separate function to handle AdobeMatchKey extraction.
  
- **Code Comments:**
  - Increase inline documentation to clarify the purpose of each major code block, particularly around the mapping and joining logic.
  
- **Handling Undefined Values:**
  - Even though the code filters out falsy values before joining, explicitly handling undefined or null values might provide clearer debugging information.
  
- **Error Handling:**
  - Instead of a silent catch, consider logging a warning if AdobeMatchKey extraction fails. This may help track issues without impacting processing if the expected property is missing.

- **Maintain ES5 Compatibility:**
  - Ensure that all refactored code continues to use ES5 syntax, avoiding ES2015/ES6 features such as arrow functions, const/let, or template literals.

---

## 6. Maintenance & Further Notes

- **Ongoing Maintenance:**
  - Regularly review and test the extension when changes to the Tealium data layer occur.
  - Monitor ContentSquare integration to ensure that custom variable mappings continue to meet analytics requirements.
  
- **Ownership:**
  - Assign a developer or team responsible for tracking changes in both the data layer schema and ContentSquare reporting requirements.
  
- **Testing Guidelines:**
  - Validate the output by verifying the contents of `window._uxa` during development and QA processes.
  - Create test cases for:
    - Complete data mapping scenarios with all fields present.
    - Partial data scenarios where some values are missing.
    - Malformed AdobeMatchKey values.
  - Confirm that the ordering and content of custom variables match the expectations as per ContentSquare documentation.
  
- **Documentation Updates:**
  - Maintain this document alongside the source code. Update version numbers, change logs, and any modifications to custom data mappings or processing logic as they occur.
  
- **Integration Checks:**
  - Consider automated integration tests with ContentSquare to verify that changes in data mapping do not affect the analytics results.

---

This document should serve as a complete reference for developers and stakeholders looking to understand, maintain, or modify the ContentSquare Custom Variables extension in Tealium iQ.