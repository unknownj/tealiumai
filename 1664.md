# Tealium iQ Extension Documentation: ContentSquare Self Hosting Code

## 1. Extension Overview
- **Name**: ContentSquare Self Hosting Code
- **ID**: 1664
- **Type**: Javascript Code
- **Scope**: 1471
- **Execution Frequency**: Active

### Summary
The "ContentSquare Self Hosting Code" extension is designed to facilitate the dynamic loading of ContentSquare analytic scripts based on a flag present in the input data (eventPayload). If the flag `EnableCSNext` is true, it loads one version of the script; otherwise, it defaults to another version. This extension enhances the analytics capabilities by allowing for selective loading of scripts, thereby optimising performance based on user settings.

---

## 2. Code Explanation
### Key Variables
- **LBGAnalytics.cs**: An object used to hold analytics data. It's initialised if it doesn't exist.
- **tagId**: A variable that determines which script to load based on the `EnableCSNext` flag.
- **u.data.base_url**: The URL that constructs the endpoint for loading the specific ContentSquare JavaScript file.

### Logic Flow
1. The function takes three parameters: `eventType`, `eventPayload`, and `tagObject`.
2. It checks if the `LBGAnalytics.cs` object has already been loaded to prevent duplicate loading.
3. Based on the value of the `EnableCSNext` flag found in `eventPayload`, it assigns an appropriate `tagId`.
4. If the script has not been loaded, it sets `loaded` to true and constructs the base URL for the ContentSquare script, ensuring that the script is fetched with the correct user tracking ID (`utid`).

### Dependencies
This extension relies on:
- The existence of a global object `LBGAnalytics` for storing analytics format.
- The `utag` global function to fetch the correct user tracking ID (`utid`) as part of the script URL.

---

## 3. Usage Examples
### Normal Operation
In a standard scenario, users trigger the event that populates `eventType` with a string and `eventPayload` with the following structure:
```json
{
  "EnableCSNext": true // or false
}
```
- If `EnableCSNext` is true: The URL resolves to `https://tags.tiqcdn.com/utag/lbg/main/dev/utag.1649.js?{utid}`.
- If `EnableCSNext` is false: The URL resolves to `https://tags.tiqcdn.com/utag/lbg/main/dev/utag.1474.js?{utid}`.

### Edge Conditions
- If the `EnableCSNext` property is missing from `eventPayload`, the script will use the default tag ID (1474).
- Re-triggering the same event will not load the script multiple times due to the `loaded` flag, preventing redundant network requests.

---

## 4. Known Limitations & Gotchas
- The extension solely depends on the value of the `EnableCSNext` property. If the property is accidentally omitted or incorrectly set, it defaults to using the script with ID `1474`.
- Conflicts may occur if other extensions attempt to modify or overwrite `LBGAnalytics.cs` or the global `u` object they both operate on.
- The script is not designed to handle versions or arguments for different environments (development, staging, etc.), limiting flexibility in deployment.

---

## 5. Recommendations for Refactoring
- **Defensive Checks**: While we do not need to handle the presence of `eventType` and `eventPayload`, it might improve readability to logically separate data checks and script loading mechanisms.
- **Code Style**: Consider making use of descriptive variable names for better clarity. For instance, renaming `b` to `eventPayload` directly in code enhances readability for future developers.
- **Modularization**: Although ES5 is required, consider breaking the loading logic into a separate function for clarity.

Example of improved structure:
```javascript
function loadScript(tagId) {
  u.data.base_url = "https://tags.tiqcdn.com/utag/lbg/main/dev/utag." + tagId + ".js?" + utag.cfg.utid;
}

if (!LBGAnalytics.cs.loaded) {
  LBGAnalytics.cs.loaded = true;
  loadScript(tagId);
}
```

---

## 6. Maintenance & Further Notes
- **Ongoing Maintenance**: Review the extension regularly for compatibility with any updates to the Tealium iQ or ContentSquare platforms.
- **Ownership**: Designate a primary owner to oversee updates and troubleshoot any issues that arise with implementation.
- **Testing Guidelines**: Implement testing procedures prior to deployment, focusing on both the `EnableCSNext` toggle and the loading prevention mechanism to ensure intended functionality.

By carefully documenting this extension, we facilitate better understanding and ease future development efforts surrounding the use of ContentSquare analytic tools within Tealium.