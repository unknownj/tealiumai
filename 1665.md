# Tealium iQ Extension Documentation: Contentsquare Load Rule

## 1. Extension Overview
- **Name:** Contentsquare Load Rule
- **ID:** 1665
- **Type:** Javascript Code
- **Scope:** Before Load Rules
- **Execution Frequency:** Run Always

### Summary
The Contentsquare Load Rule extension is designed to manage and conditionally enable or disable the Contentsquare tracking service based on specific URL parameters, feature flags, and environmental conditions. It helps ensure that Contentsquare analytics are only loaded under appropriate circumstances, optimising performance and complying with privacy regulations.

---

## 2. Code Explanation

### Key Variables
- **`b.EnableCS`:** A boolean indicating whether Contentsquare tracking is enabled.
- **`LBGAnalytics.featureFlags`:** An object used to manage various feature flags relevant to Contentsquare.
- **`brandToProject`:** A mapping of brand names to their corresponding Contentsquare project IDs.
- **`brandToInfrastructure`:** A mapping of brand names to their respective infrastructure providers (AWS or Azure).
- **`thisBrand`:** The currently processed brand, adjusted for pre-production if applicable.

### Logic Flow
1. **Path Checks:** 
   - The extension begins by checking the URL path to conditionally disable Contentsquare tracking on specific pages (e.g., paths containing "savingsidc" or "/idv/").

2. **Feature Flags:** 
   - Checks if the Contentsquare feature is enabled or explicitly disabled through `LBGAnalytics.featureFlags`.

3. **Hostname Validations:** 
   - The extension verifies the page's hostname against a list of valid hostnames and performs further checks on the URL path to determine if tracking should be enabled.

4. **Environmental Checks:** 
   - Additional checks are performed to enable tracking if the hostname indicates a staging or development environment (e.g., `nft0`, `sit0`).

5. **Configuration Setup:** 
   - When tracking is enabled, the `window.CS_CONF` object is constructed, which contains numerous configuration parameters for the Contentsquare service, including appropriate project IDs, domains, and feature flags.

### Dependencies
- The extension relies on the presence of the `LBGAnalytics` global object to manage feature flags.
- It uses various `document` and `window` properties to access relevant page information (e.g., URL path and hostname).

---

## 3. Usage Examples

### Normal Conditions
1. **Enabling Tracking:**
   - When a user visits the homepage of a valid brand (e.g., `www.lloydsbank.com`), the extension checks the hostname and sets `b.EnableCS` to `true`, enabling Contentsquare tracking.

2. **Disabling Tracking:**
   - When a user navigates to a savings ID page (`/savingsidc`), the extension sets `b.EnableCS` to `false`, preventing Contentsquare from tracking this page.

### Edge Cases
1. **Feature Flag Off:**
   - If `LBGAnalytics.featureFlags.Contentsquare` is set to `false`, tracking will be disabled regardless of the URL conditions.

2. **Development Environment:**
   - If a user is in a testing environment (e.g., `nft0`), the extension enables tracking to assist developers in analytics testing.

---

## 4. Known Limitations & Gotchas

- **Hostname Dependency:** The extension strictly relies on exact matches against a predefined list of hostnames. Any changes in the production structure or domain names will require updates to the extension configuration.
  
- **CSP Restrictions:** Certain hostnames are commented out due to Content Security Policy (CSP) restrictions, which may limit the extensionâ€™s flexibility in those contexts.

- **Error Handling:** The catch blocks silently ignore errors, making it harder to debug issues that may arise during execution. 

- **Performance:** The extensive if-else structures could lead to performance issues if URLs with high complexity are processed.

---

## 5. Recommendations for Refactoring

- **Defensive Checks:** Currently, error handling is too simplistic. Introduce console logging within the catch blocks for easier debugging without impacting production performance.

- **Modularisation:** Consider breaking the extension into smaller, self-contained functions (e.g., for pathname checks, hostname checks), which will improve readability and maintainability.

- **Configuration Management:** The project ID and infrastructure mappings could be externalised to a configuration object at the beginning of the script, making it easier to manage.

---

## 6. Maintenance & Further Notes

- **Owner Appointment:** Designate a primary owner for the extension to ensure consistent updates and monitoring.

- **Testing Guidelines:** Regularly test the extension in both production and staging environments to verify functionality with varying conditions. Consider implementing automated tests if feasible.

- **Documentation Updates:** Maintain updated documentation reflecting any changes made to the extension, particularly when introducing new brands or altering the behaviour of existing feature flags.

This documentation serves as a living document and should be reviewed periodically to capture any new insights, extensions, or adjustments in business requirements.