# Tealium iQ Extension Documentation

## 1. Extension Overview
- **Name:** Analytics CNAME Switch
- **ID:** 1666
- **Type:** Javascript Code
- **Scope:** 928
- **Execution Frequency:** Active

### Summary
The Analytics CNAME Switch extension is designed to dynamically configure the tracking server for analytics based on specific conditions related to the userâ€™s hostname and system. This is particularly useful for organisations that need to route analytics data securely through a CNAME to prevent issues related to cookie domain mismatches and enhance privacy compliance.

## 2. Code Explanation

### Key Variables
- `enableCNAME`: A function that sets the tracking servers (both secure and non-secure) to a specific CNAME (`analytics.data.lloydsbankinggroup.com`). It also updates the `TaggingMechanics` to include "CNAME".

### Logic Flow
1. The extension immediately defines the `enableCNAME` function which updates the tracking server URLs and modifies the `TaggingMechanics`.
2. It checks if the global object `LBGAnalytics.featureFlags` is defined and if the `analyticsCNAME` feature flag is enabled.
3. Conditional checks are performed based on the hostname and system:
   - If the hostname is `www.lloydsbank.com` and `utag_data.System` equals "SCEP", `enableCNAME` is invoked.
   - If the hostname is `secure.lloydsbank.co.uk` and the pathname includes ".jsp", `enableCNAME` is also invoked.
   - If the hostname is `www.halifax.co.uk` and `utag_data.System` equals "SCEP", `enableCNAME` is invoked.

### Dependencies
- Utilises the global object `LBGAnalytics` to manage feature flags.
- Relies on the global object `utag_data` for session and system information.
- Assumes that global variables (e.g., `eventType`, `eventPayload`, `tagObject`) are available during execution.

## 3. Usage Examples

### Normal Conditions
- When a user visits `www.lloydsbank.com` with `utag_data.System` set to "SCEP": The tracking server will be set to `analytics.data.lloydsbankinggroup.com`.

### Edge Conditions
- If a user navigates to `secure.lloydsbank.co.uk` and accesses a JSP page (URL contains `.jsp`): The tracking server will similarly be set to `analytics.data.lloydsbankinggroup.com`.
- In cases where a user is on `www.halifax.co.uk` and the system is "SCEP", the same server configuration will apply.

### Malfunction Scenarios
- If `utag_data.System` is not defined, the checks in the conditional logic won't execute, leading to potential misconfigured tracking.

## 4. Known Limitations & Gotchas
- The extension relies heavily on the correct setup of `utag_data` and `LBGAnalytics` to function properly. Any issues with these could prevent the extension from executing as expected.
- There might be conflicts with other extensions that modify `trackingServer` or `trackingServerSecure`. Careful review is needed when adding new extensions.

## 5. Recommendations for Refactoring
- **Defensive Checks:** While not explicitly required, it may be beneficial to add checks to ensure `utag_data.System` is a valid string to prevent potential runtime errors.
- **Code Style:** Consistently use semicolons to avoid any potential issues with automatic semicolon insertion, which could lead to unexpected behaviour in certain scenarios.
- **Modularisation:** Consider breaking down the functionality into smaller, reusable functions for better readability and maintainability, such as separating the logic for hostname checks from the CNAME setup.

## 6. Maintenance & Further Notes
- **Ownership:** Assign a specific team member or group to be responsible for the oversight and updates of this extension.
- **Testing Guidelines:** Ensure rigorous testing is performed in various environments (development, staging, production) to validate that the CNAME configuration is working as intended across all scenarios.
- Document any changes made to the extension against version history to maintain clarity on modifications over time.

--- 

This documentation serves as a comprehensive guide for understanding, using, and maintaining the Analytics CNAME Switch extension within Tealium iQ.