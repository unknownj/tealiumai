# Tealium iQ Extension Documentation: Facebook Pixel Event Type (MC)

## 1. Extension Overview

- **Name**: Facebook Pixel Event Type (MC)
- **ID**: 1670
- **Type**: Lookup Table
- **Scope**: 1559
- **Execution Frequency**: On every relevant event trigger

### Summary
The **Facebook Pixel Event Type (MC)** extension serves to construct a canonical path based on the domain name and specific journey information derived from user interactions. This path is then utilized by the Facebook Pixel to accurately track user events on specified qualifying domains, optimising the overall measurement of the advertising campaigns.

---

## 2. Code Explanation

### Key Variables
- **qualifyingDomains**: An array of domain names that the extension applies to. This array ensures that the extension only runs on specific sites as defined.
- **CanonicalPath**: A string that holds the constructed path based on user journey information.

### Logic Flow
1. The function checks if the current hostname (i.e., the current web page's domain) is present in the `qualifyingDomains` array and if the `CanonicalPath` is equal to the root path ("/").
2. If both conditions are satisfied, it combines `JourneyName` and `JourneyStepName` from the `eventPayload` to create a new `CanonicalPath`.
3. The new `CanonicalPath` is formatted:
   - Non-empty journey components are transformed to lowercase.
   - Spaces are replaced with dashes.
   - Components are joined with a "/" as a separator.
4. The formatted `CanonicalPath` is then prefixed with "/_/".

### Dependencies
- The extension relies on global objects `window` (to access `location.hostname`) and potentially others (e.g., `eventType` and `eventPayload`), which must have been set before this code runs.
- No external libraries are used.

---

## 3. Usage Examples

### Normal Condition
1. User navigates to `calculator.lloydsbank.co.uk`.
2. If the URL is `/` and the user has invoked a journey, the `CanonicalPath` constructed may look like:
   ```
   /_/purchase/step-1
   ```

### Edge Condition
1. User navigates to `non-qualifying.domain.com`.
2. As the domain is not in the `qualifyingDomains` array, the code does not execute any changes to the `CanonicalPath`.

---

## 4. Known Limitations & Gotchas

- **Domain Filtering**: If the domain name is not included in the `qualifyingDomains` list, the extension will not run, leading to no modifications to the `CanonicalPath`.
- **Path Formatting**: Spaces in `JourneyName` or `JourneyStepName` are replaced with dashes, which might lead to confusion if original phrases are essential.
- **CanonicalPath Overwrite**: If the `CanonicalPath` is pre-set, this extension will overwrite it without warning.

Potential conflicts may arise if other extensions attempt to set or modify the `CanonicalPath` after this extension has executed.

---

## 5. Recommendations for Refactoring

- **Defensive Checks**: It is advisable to validate the presence of properties like `JourneyName` and `JourneyStepName` before use. This could prevent errors due to undefined values.
- **Modularisation**: Consider splitting the path construction logic into a standalone function for clarity and potential reuse:
    ```javascript
    function formatCanonicalPath(journeyDetails) {
        return "/_/" + journeyDetails
            .filter(function(a){
                return !!a;
            })
            .map(function(a){
                return a.toString().toLowerCase().split(" ").join("-");
            })
            .join("/");
    }
    ```
- **Code Style**: Ensure consistent use of semicolons and indentation to enhance code readability.

---

## 6. Maintenance & Further Notes

### Ongoing Maintenance
- Regularly update the list of `qualifyingDomains` to ensure compatibility with current marketing strategies and campaigns.
- Test the extension after each deployment to verify that the desired `CanonicalPath` is generated accurately across different journeys.

### Ownership
- Assign a dedicated developer for the oversight and documentation of changes to the extension.

### Testing Guidelines
- Create test cases for both qualifying and non-qualifying domains to ensure that the extension behaves correctly under different conditions.
- Consider running performance tests to measure any impacts on page load times, especially if the extension will manage a large number of paths.

--- 

This comprehensive documentation serves as a guide for developers and stakeholders involved in maintaining or extending the functionality of the Facebook Pixel Event Type (MC) extension. It details its operation, considerations for enhancements, and the context within which it operates.