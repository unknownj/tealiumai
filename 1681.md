# Tealium iQ Extension Documentation: Extension Handler 2022

## 1. Extension Overview

- **Name**: Extension Handler 2022
- **ID**: 1681
- **Type**: Advanced Javascript Code
- **Scope**: Pre Loader
- **Execution Frequency**: Run Once

### Summary
The **Extension Handler 2022** extension is designed to manage the lifecycle of custom extensions within the LBGAnalytics framework. It provides functionalities for logging, pushing new extensions, and executing them based on specific conditions. This extension is crucial for ensuring that various analytical capabilities can interact effectively with the incoming data while adhering to defined scopes and limits.

## 2. Code Explanation

### Key Variables
- **`extensionList`**: An array that holds all registered extensions.
- **`log`**: A logging function that records log entries and allows for subsequent retrieval and clearing of logged data.
- **`runlimit`**: A restriction applied to an extension to limit the number of times it can be executed within its lifecycle.
- **`inputs` / `outputs`**: Arrays that define which variables an extension can read from or write to from the provided payload.

### Logic Flow
1. **Extension Registration**: Through the `push` method, each extension is validated before being added to the `extensionList`. An extension can only be added if it is an object, enabled, and in scope.
  
2. **Running Extensions**: The `run` method filters the `extensionList` to find extensions that match the provided scope. For each qualifying extension:
   - It checks the `runlimit` to prevent execution if the limit is reached.
   - It processes the `payload` to only include the specified `inputs` where applicable.
   - Executes the extension’s code with the payload and logs the outcome and history.

3. **Logging**: The logging functionality stores entries throughout the execution cycle, providing valuable debugging information.

### Dependencies
- **Global Objects**: The extension relies on:
  - `window.LBGAnalytics`: Which serves as the primary analytics framework.
  - `window.LBGAnalytics.$`: A jQuery reference assumed to be part of the LBGAnalytics object.
  - `window.LBGAnalytics.datalayer`: Assumed to be available for data layer interactions.
  - `window.utag`: A Tag Management System reference, which may be overridden or absent.

## 3. Usage Examples

### Normal Scenario
- **Event Trigger**: A user navigates to a new page, triggering a "view" event.
- **Payload Input**: The payload contains user information and page details.
- **Extension Execution**: The extension processes this data, modifies the payload (if needed based on defined `inputs`/`outputs`), and performs its logic.

### Edge Condition Example
- **Running Beyond Limit**: If an extension has a `runlimit` of 5 and is invoked for the sixth time, it should log a "Run limit reached" message and halt further execution for that extension.

```javascript
LBGAnalytics.extensions.run("view", { user: "JohnDoe", page: "Home" }, "Pre Loader");
```

In this case, the output would indicate that various extensions have been processed, or if limits were reached, what was the outcome.

## 4. Known Limitations & Gotchas

- **Scope Constraints**: Extensions may not execute if the scope doesn't match, requiring careful management of scope definitions.
- **State Management**: If extensions modify shared state (e.g., global variables), this can lead to unpredictable behaviour across multiple executions.
- **Error Handling**: While errors are caught within the extension’s execution, there may be a lack of clarity on what specific parts caused the failure in complex extensions.

## 5. Recommendations for Refactoring

- **Defensive Checks**: While it is safe to assume `eventType` and `payload` are provided, additional checks within the extension logic can prevent runtime errors.
- **Logging Enhancement**: The extensibility of the logging function could be improved by allowing for different log levels (info, warn, error) instead of using a single log function.
- **Code Modularity**: Considering splitting the logic into smaller helper functions or modules for tasks like payload preparation and logging to improve readability and maintainability.

## 6. Maintenance & Further Notes

- **Ongoing Maintenance**: Regularly review the extension's performance and log output to identify potential improvements or issues.
- **Ownership**: Assign ownership of the extension to a designated team member for accountability.
- **Testing Guidelines**: Conduct thorough testing, especially when modifications are made, to ensure that the extensions function correctly with various payload scenarios.

--- 

This documentation should be shared with all developers working with Tealium iQ extensions and can serve as a reference for future integration or debugging efforts.