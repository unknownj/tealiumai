# Tealium iQ Extension Documentation: Appstore Redirect

## 1. Extension Overview

- **Name**: Appstore Redirect
- **ID**: 100036
- **Type**: Javascript Code
- **Scope**: After Tag Extensions
- **Execution Frequency**: Run Once

### Summary
The Appstore Redirect extension is designed to enhance user experience by redirecting users to the appropriate app store (Google Play or Apple App Store) based on their device type (Android or iOS). The primary purpose is to ensure that users accessing specific URLs are directed to the correct application download page with enriched URL parameters.

## 2. Code Explanation

### Key Variables

- **testLogging**: A boolean variable for toggling logging/debugging alerts, useful during development.

- **appStoreDomains**: An object mapping app store brands to their respective domains. 
  - Example: 
    ```javascript
    {
      google: "play.google.com",
      apple: "apps.apple.com"
    }
    ```

- **immutableParameters**: An array of query parameters that should remain unchanged during redirection. 
  - Example: 
    ```javascript
    ["id", "mt"]
    ```

### Logic Flow

1. **Device Detection**: The `getBrand` method detects the type of device (Android or iOS) based on the user agent string or URL parameters.
  
2. **Link Extraction**: The `getLinks` method retrieves links associated with the detected brand by querying for specific anchor tags that contain the app store domain in their href attributes.

3. **URL Deconstruction**: The `deconstructUrl` method parses a URL into its components (protocol, hostname, pathname, query parameters) to facilitate manipulation and enrichment.

4. **Link Enrichment**: The `getEnrichedLink` method uses the previously collected information to generate a new URL that retains certain immutable parameters while substituting others based on the current page's URL parameters.

5. **Redirection**: The `doRedirect` method checks the necessary conditions and performs the redirection if a valid enriched link is available.

### Global Dependencies

- **window**: The code heavily relies on global objects like `window` for accessing URL information and `navigator` for device type detection.

## 3. Usage Examples

### Normal Condition

When a user visits `https://example.com/our-app/download.html`, the extension will:
1. Detect the user's device (e.g., an iPhone).
2. Gather existing links to the Apple App Store from the page.
3. Enrich the first link with necessary query parameters.
4. Redirect the user to the enriched link.

### Edge Conditions

- If no valid links are found for the detected brand, the extension will not perform any redirection.
- If the user agent does not match any known criteria (for example, it is not Android or iOS), the redirection will not occur.

## 4. Known Limitations & Gotchas

- **URL Manipulation**: If a URL does not contain the expected parameters or is malformed, the redirection might fail and return an undefined link.
- **Fallback Behavior**: The extension does not handle fallback to alternative brands if detection fails. For instance, if the user agent cannot be determined, no action is taken.
- **Query Parameter Handling**: Special cases where immutable parameters may conflict with existing parameters are not managed comprehensively, potentially leading to unexpected redirects.
- **Conflicts**: The extension may conflict with other scripts that manipulate anchor tags in the DOM or modify window location via redirection. Coordination with other extensions is recommended.

## 5. Recommendations for Refactoring

- **Modularization**: Break the extension into smaller, reusable functions to enhance maintainability. For example, separate device detection can be independent of link extraction.
- **Error Handling**: Implement checks for the existence of expected selectors before accessing attributes to avoid runtime errors.
- **Parameter Validation**: Introduce checks for necessary parameters prior to deconstruction, ensuring a more robust handling of URLs.
- **Logging**: Maintain toggle logging for production environments but ensure alerts do not disrupt user experience.
- **Code Style**: Consistently apply the standard JavaScript coding conventions for better readability, such as using early returns to reduce nesting.

## 6. Maintenance & Further Notes

- **Ownership**: Assign a specific team or individual as the owner of this extension for any future modifications or updates.
- **Testing Guidelines**: Perform thorough testing across different devices and browsers to ensure consistent behaviour. Focus on cases where the user agent can mislead detection.
- **Performance Monitoring**: Regularly check the performance of redirects to avoid negatively impacting site loading times.
- **Documentation Updates**: Ensure that any changes to the extension are reflected in the documentation to keep the information current.

--- 

This documentation serves as a comprehensive overview, ensuring that other developers and stakeholders can effectively understand and maintain the Appstore Redirect extension in Tealium iQ.