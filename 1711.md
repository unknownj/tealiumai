# Tealium iQ Extension Documentation: Media Queries Preferences

## 1. Extension Overview

- **Name**: Media Queries Preferences
- **ID**: 1711
- **Type**: Javascript Code
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
The Media Queries Preferences extension enhances user experience by detecting and storing the user's media preferences based on CSS media queries. It evaluates several predefined media queries, such as color scheme, motion preferences, and display modes, and updates the `TaggingMechanics` variable to include these preferences. This information can then be utilised for targeted tagging and analytics.

---

## 2. Code Explanation

### Key Variables
- **mediaQueries**: An array of media attribute queries, each consisting of a unique identifier and the relevant media feature and its value. For example, `["pcs_d", "prefers-color-scheme", "dark"]` indicates that if the user's preference for colour scheme is dark, it will be included with the identifier `pcs_d`.
- **tm**: This variable captures the current value of the global `TaggingMechanics` string and parses it into an array.

### Logic Flow
1. **Initial Media Queries Declaration**: An array of key-value pairs is declared to represent various media queries.
2. **Tagging Mechanics Extraction**: The code splits the existing `TaggingMechanics` string into an array.
3. **Mapping Media Queries**:
   - It iterates over each media query, invoking `window.matchMedia` to check if the condition is met for the user's device.
   - Valid matches are then pushed into the `tm` array with their respective identifiers.
4. **CSS Support Check**: The code checks if the browser supports the CSS selector for nesting. If supported, it adds `"css_nest"` to the `tm` array.
5. **Updating Tagging Mechanics**: Finally, the `tm` array is joined back into a string and re-assigned to the `TaggingMechanics` global variable.

### Dependencies
The extension relies on the following:
- **Global Objects**: 
  - `window.matchMedia()`: Checks CSS media queries in the user's environment.
  - `CSS.supports()`: Determines if the browser supports specific CSS features.
- **Tags**: The global variable `TaggingMechanics` must be defined prior to this extension running to avoid reference errors.

---

## 3. Usage Examples

### Normal Conditions
- When a user accesses the site with their browser in dark mode, the `TaggingMechanics` will update to include `pcs_d`, indicating the preference for a dark colour scheme.

### Edge Conditions
- If a browser does not support `matchMedia()`, the extension will fail silently due to the catch block in place.
- If none of the media queries match, the `TaggingMechanics` will retain its existing value without any changes.

**Example Flow**:
1. User's device has a light mode setup.
2. The extension evaluates and finds that the light mode is active.
3. `TaggingMechanics` updates to include `pcs_l`, making it available for tagging.

---

## 4. Known Limitations & Gotchas

- **Browser Compatibility**: This extension relies on the `matchMedia` and `supports` methods which may not function correctly in older browsers.
  
- **Silent Failures**: The use of empty catch blocks means that exceptions are ignored, which may lead to unexpected behaviour without clear error reporting.

- **Potential Conflicts**: If there are other extensions manipulating `TaggingMechanics`, there may be unexpected results depending on the order of execution.

---

## 5. Recommendations for Refactoring

- **Code Modularity**: Consider separating the media queries setup, checking logic, and the updating of `TaggingMechanics` into discrete functions to improve readability and maintainability.

- **Error Handling**: While catch blocks are in place, consider logging exceptions so that issues during execution can be identified and addressed in debugging sessions.

- **Clear Comments**: Adding more detailed comments to sections of code to describe the intent and expected outcomes will assist future developers in understanding the logic applied.

- **Avoiding Duplicate Entries**: A check to ensure that media queries do not get added again to `TaggingMechanics` if they already exist could be beneficial.

---

## 6. Maintenance & Further Notes

- **Ownership**: Assign a primary developer for ongoing maintenance, ensuring they understand the implications of media queries in analytics.

- **Testing Guidelines**: Regularly verify the extension's behaviour across various devices and browsers. Create a testing checklist that covers each media query.

- **Documentation Updates**: As new media features arise, keep this documentation updated to reflect changes or enhancements to the media queries being used.

This documentation can be shared with other developers or stakeholders for understanding and collaborating on the Media Queries Preferences extension effectively.