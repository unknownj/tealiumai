# Tealium iQ Extension Documentation - CSP Fill

## 1. Extension Overview

- **Name**: CSP Fill
- **ID**: 1718
- **Type**: JavaScript Code
- **Scope**: Pre Loader
- **Execution Frequency**: Run Once

### Summary
The "CSP Fill" extension is designed to implement a Content Security Policy (CSP) in the browser to prevent a range of web security issues, including cross-site scripting (XSS) and data injection attacks. By controlling which resources can be loaded on the page, it improves the site's security posture and ensures that only allowed content is executed. This extension dynamically generates a CSP meta tag based on defined profiles and conditions to suit various Business Logic needs.

## 2. Code Explanation

### Key Variables
- `window.LBGCSP`: A global object created to encapsulate the functionalities of this extension.
- `target`: A reference to `window.LBGCSP`.
- `config`: An object that holds the CSP configurations for different profiles.
- `CSPEnablement`: An object that manages the enablement of CSP based on the current hostname.
  
### Logic Flow
1. **Initialisation**: The CSP Fill extension checks if `window.LBGCSP` exists. If not, it initializes this object with relevant properties and methods.
2. **Parent Domain Calculation**: The code determines the parent domain from the current URL to trust its subdomains.
3. **Profile Configuration**: It allows defining different security policies based on profiles (core, marketing, media, service), controlling sources for scripts, images, styles, etc.
4. **CSP Application**: Depending on the profiles defined, it creates a CSP string based on a filter mechanism, and adds this CSP as a meta tag to the document's `<head>` section.
5. **Violation Handling**: The code listens for security policy violations and logs these events for analytics.
6. **CSP Enablement**: The script checks specific hostnames to determine if default CSP should be applied.
  
### Dependencies
- Relies on global objects such as `window`, `document`, and `window.LBGAnalytics` for tracking and CSP application.
- Utilizes standard JavaScript methods for manipulating cookies, DOM, and event listeners.

## 3. Usage Examples

### Normal Condition
1. **Initial Load**: When a page loads, the CSP Fill extension initializes and checks if CSP should be applied based on the current hostname. If matched with the allowed list, it adds a CSP meta tag.
2. **CSP Applied**: The CSP restricts resource loading to predefined domains, enhancing site security.

### Edge Conditions
1. **Subdomain Access**: If the page is loaded from a subdomain (e.g., `subdomain.bankofscotland.co.uk`), it automatically trusts the parent domain, thereby enabling functionality without disrupting user experience.
2. **Violation Events**: If a blocked resource is requested, the violation handler records the event, which can be send to `window.LBGAnalytics` for monitoring.

## 4. Known Limitations & Gotchas

- **CSP Restrictions**: The CSP may inadvertently block resources from domains not included in the configuration, impacting functionality (e.g., third-party analytics scripts).
- **Browser Compatibility**: While most modern browsers support CSP, older browser versions may not support all features.
- **Potential Conflicts**: CSP policies may interfere with other scripts or extensions running on the page, especially if they dynamically manipulate the DOM or alter CSP policies.
- **Error Handling**: The extension fails silently in cases of error (e.g., bad configuration), which may complicate debugging efforts.

## 5. Recommendations for Refactoring

- **Modular Structure**: Consider breaking the logic into smaller, reusable functions for readability and maintainability. For example, separate domain handling from policy definition.
- **Defensive Checks**: Although it is noted that `eventType` and `eventPayload` will always be present, any further validations on the values of these objects might be beneficial to ensure expected behaviour.
- **Commenting and Documentation**: Enhance inline comments and method documentation to clarify how specific sections of the code contribute to overall functionality.
- **Error Logging**: Implement more robust error logging to capture and track issues during execution, improving the debugging process.

## 6. Maintenance & Further Notes

- **Ownership**: Assign a dedicated developer or team for ongoing support and updates of the extension. Assign responsibilities clearly to ensure accountability.
- **Testing Guidelines**: Regularly test the extension in various environments (staging and production) to confirm that it behaves as expected. Testing should cover normal flows, edge cases, and invalid configurations.
- **Documentation Updates**: Keep the documentation up to date with any code changes or new requirements. This will facilitate easier onboarding for new developers and ensure continued consistency in code maintenance.

> _By adhering to these guidelines, the Tealium iQ CSP Fill extension can maintain a robust security policy while providing clear and manageable code._