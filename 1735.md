# Global Virtual Assistant Controller Extension Documentation

## 1. Extension Overview

- **Name**: Global Virtual Assistant Controller  
- **ID**: 1735  
- **Type**: JavaScript Code  
- **Scope**: Before Load Rules  
- **Execution Frequency**: Run Always  

### Summary
The Global Virtual Assistant Controller is a Tealium iQ extension designed to manage and configure virtual assistants based on the page context of the user. This extension evaluates the user's location (domain and path) to determine which virtual assistant configuration should be applied, enhancing the user experience by providing relevant assistance depending on the pages being accessed.

---

## 2. Code Explanation

### Key Variables
- `assistants`: An array containing configurations for different virtual assistants. Each entry includes:
  - `name`: A descriptive name for the assistant.
  - `config`: A configuration string that specifies the virtual assistant to be used.
  - `criteria`: A function that determines if the assistant should be activated based on the current page's hostname and pathname.

### Logic Flow
1. **Domain and Path Check**: 
   - For each assistant, the `criteria` function checks if the current domain matches the permitted domains and if the current pathname matches specific exact paths or path stems.
  
2. **Configuration Setting**: 
   - If the criteria are met, the corresponding configuration string and assistant name are assigned to the global variables `b.VirtualAssistantConfig` and `b.VirtualAssistantName`, respectively.

### Global Dependencies
The extension relies on the `window` global object to access the current `hostname` and `pathname`, which are essential for determining the context of the user's request.

---

## 3. Usage Examples

### Normal Conditions
- **Scenario**: User accesses the page `https://www.lloydsbank.com/business/help.html`.
  - Expected Outcome: The "Lloyds Business" assistant is activated, setting:
    ```javascript
    b.VirtualAssistantConfig = "lloydsbank:lbg_biz";
    b.VirtualAssistantName = "Lloyds Business";
    ```

### Edge Conditions
- **Scenario**: User accesses a page not in the array, such as `https://www.lloydsbank.com/business/faq.html`.
  - Expected Outcome: No assistant is activated, and `b.VirtualAssistantConfig` and `b.VirtualAssistantName` remain undefined.

### Additional Example
- **Scenario**: User accesses the homepage of the Halifax Intermediaries site.
  - URL: `https://halifax-intermediaries.co.uk/`
  - Expected Outcome: The "Intermediaries" assistant is activated:
    ```javascript
    b.VirtualAssistantConfig = "askus.halifax-intermediaries.co.uk:halifaxintermediairies_live_emb";
    b.VirtualAssistantName = "Intermediaries";
    ```

---

## 4. Known Limitations & Gotchas

- The extension currently does not handle subdomains other than those explicitly defined, leading to potential issues if a new subdomain is introduced.
- The criteria checks are strict; any slight changes in the page structure or URL paths can render the extension ineffective.
- There is no functionality for logging or feedback. In case of failure, it is difficult to diagnose which assistant should have been activated.
- Conflicts can occur if multiple extensions modify the global variables `b.VirtualAssistantConfig` and `b.VirtualAssistantName` unpredictably.

---

## 5. Recommendations for Refactoring

- **Modularization**: Consider breaking the `criteria` functions into separate modular functions for better readability and maintainability. Each assistant's logic could be encapsulated in its own function.
  
- **Defensive Checks**: While the availability of `eventType` and `eventPayload` is guaranteed, further checks could enhance resilience. For instance, ensuring that `window.location.hostname` and `window.location.pathname` are valid before processing.

- **Logging**: Implement logging for each step of the criteria evaluation to aid in troubleshooting. This could be useful for monitoring which assistants were (or weren't) activated.

- **Dynamic Configuration**: Instead of hardcoding domain and path criteria, consider loading these criteria from a configuration object. This would allow for more flexibility and easier updates without touching the codebase.

---

## 6. Maintenance & Further Notes

- **Ownership**: This extension should be monitored by a dedicated team member responsible for ongoing support and improvements.
  
- **Testing Guidelines**: Regularly test the extension against changes in website structure, domain configurations, and new virtual assistant requirements. Unit tests can be beneficial to ensure that existing functionality is not broken by changes.

- **Documentation Updates**: As the site evolves or business requirements change, keep this documentation and the extension itself up to date to ensure that all developers have access to the latest information.

- **Version Control**: Maintain proper version control for any changes made to this extension, ensuring that rollback is possible in case of issues in production.

--- 

This documentation provides a thorough examination of the Global Virtual Assistant Controller and should be useful for any developer revisiting, maintaining, or improving the extension.