# Yext Search Analytics Extension Documentation

## 1. Extension Overview

- **Name**: Yext Search Analytics
- **ID**: 100036
- **Type**: Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
The Yext Search Analytics extension captures and tracks various user interactions and content impressions on pages related to Yext searches. It primarily focuses on gathering data around search terms, vertical navigation, FAQs, tools, products, case studies, help articles, and locations displayed on the page. This information is critical for understanding user engagements, improving the user experience, and optimising content delivery.

## 2. Code Explanation

### Key Variables
- `verticalContext`: A variable that tracks the current vertical context, defaulting to "None".
- `verticalImpression`: An array that holds the impressions of the verticals displayed on the page.
- `contentImpression`: An array that maintains impressions of various content types such as FAQs, tools, products, etc.
- `searchTerm`: A string that captures the search query entered by the user in the search bar.

### Logic Flow
1. The code begins by checking if the hostname contains `.pagescdn.com` or starts with `answers.`.
2. The script attempts to extract the current search term from the input box within the search bar.
3. It then checks the active tab in the navigation menu to determine which vertical is currently displayed. It processes data based on whether the "All" tab is active or a specific vertical tab.
4. Impressions of content types such as FAQs, tools, products, case studies, help articles, and locations are collected through individual sections of the DOM.
5. Each content type's text is cleaned and added to the `contentImpression` array, while also being categorised accordingly.
6. Finally, a payload is created, which includes details on the user journey, search terms, vertical impressions, and processed contents.
7. This payload is merged with the incoming `eventPayload` to ensure the relevant data is captured for tracking.

### Dependencies
- The script heavily relies on the DOM to fetch elements using methods such as `querySelector` and `querySelectorAll`.
- It does not depend on any external libraries but assumes that the relevant DOM structure and classes are present.

## 3. Usage Examples

### Normal Conditions
- When a user searches for "best restaurants" on a Yext page, the extension captures:
  - The search term "best restaurants".
  - The vertical context if the active tab corresponds to a category (e.g., "Restaurants").
  - Impressions of the first five FAQs, tools, products, case studies, help articles, and locations displayed on the page.

### Edge Conditions
- If no results are returned, the extension appropriately tracks that the "NO_RESULTS" message is displayed.
- If the DOM structure changes (e.g., a new HTML class for FAQs is introduced), the extension may fail to retrieve the correct information unless adjusted accordingly.

## 4. Known Limitations & Gotchas

- **Dependency on DOM Structure**: The extension is highly dependent on the existing DOM structure. Any changes in class names or element hierarchy may break functionality.
- **No Fallback for Missing Data**: The extension does not provide a fallback or warning for missing expected elements.
- **Performance Concerns**: Multiple try-catch blocks are used, which can affect performance if many exceptions are thrown.
- **Global Object Usage**: The script presumes `eventType` and `eventPayload` are present, which could lead to errors if this condition is not met in future implementations.

## 5. Recommendations for Refactoring

- **Improvement on Error Handling**: While current implementations use try-catch blocks, introducing logging of errors could facilitate debugging.
- **Defensive Coding for Element Existence**: Before calling methods like `textContent`, check the existence of elements to prevent potential runtime errors.
- **Code Modularity**: Consider breaking down larger functions into smaller, reusable ones to improve readability and maintenance.
- **Use of More Descriptive Variable Names**: Enhancing variable names to be more descriptive can improve code clarity.
- **Comments for Code Clarity**: While the code has some comments, additional context around complex sections would assist other developers.

## 6. Maintenance & Further Notes

- **Ongoing Maintenance**: Regular checks should be performed to ensure the extension functions correctly when the website structure is updated.
- **Ownership**: Designate a developer as the primary owner to oversee changes and updates to the extension.
- **Testing Guidelines**: Establish a testing protocol to ensure that new updates do not break existing functionalities. Implement automated tests where feasible.
- **Documentation Updates**: This documentation should be routinely updated to reflect any changes in the code or functionality.

By following this organised documentation, developers and stakeholders can better understand the Yext Search Analytics extension and its intended use, maintainability, and potential improvements.