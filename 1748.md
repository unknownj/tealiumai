# Tealium iQ Extension: Qualtrics Load Rules

## 1. Extension Overview

- **Name**: Qualtrics load rules (monz woz ere)
- **ID**: 1748
- **Type**: Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension implements load rules for different domains and paths relevant to the Qualtrics integration. It determines the appropriate Qualtrics Zone ID based on the current page's URL and path, enabling targeted analytics tracking. The rules are designed to streamline the setup of analytics by managing which scripts or tracking mechanisms are loaded based on matching criteria.

---

## 2. Code Explanation

### Key Variables
- **loadRules**: An array containing objects that define each load rule. Each rule object contains:
  - `name`: A descriptive identifier for the load rule.
  - `urls`: An array of domains where the rule applies.
  - `paths`: An optional array of additional paths that must match for the rule to be applicable.
  - `ZoneID`: The ID for the Qualtrics zone.
  - `ignore`: An optional array that specifies paths to ignore.

- **eligibleRules**: A filtered array derived from `loadRules` that contains only the rules satisfying certain conditions.

### Logic Flow
1. **Load Rule Filtering**:
   - Each rule is checked for a `ZoneID`. If absent, the rule is discarded.
   - If a rule has an `ignore` block and the current path matches any ignored paths, it is discarded.
   - If paths are defined, the rule checks if the current path (`CanonicalPath`) starts with any of these paths and if the domain matches the URL criteria.
   - If no paths are defined, it only checks for the domain.

2. **Setting Qualtrics Variables**:
   - If eligible rules exist after filtering, the first valid rule's `ZoneID` and `name` are assigned to `b.QualtricsZoneID` and `b.QualtricsZoneName` respectively for further processing.

### Dependencies
- The extension depends on the global object `LBGAnalytics` for querying which URLs match the current context (`LBGAnalytics.Q`). Ensure this object is properly loaded in the environment executing this extension.

---

## 3. Usage Examples

### Normal Conditions
- **Scenario**: A user navigates to `www.lloydsbank.com/business`.
  - The extension matches the URL and the path against the rules, specifically the rule for 'QAL : BOSLYD : Business Banking Public 2', which returns a valid `ZoneID`.

### Edge Conditions
- **Scenario**: A user navigates to `www.iweb-sharedealing.co.uk/unknown-page`.
  - No rules match this path because it does not fit any of the criteria set out in the `loadRules`. Consequently, no `ZoneID` will be set.

### Ignored Paths
- **Scenario**: A user accesses `www.lloydsbank.com/business`.
  - The rule for 'QAL : Core Brands : Public & onlines excl some Business' has an ignore rule that excludes any path starting with `/business`, causing it to bypass this rule.

---

## 4. Known Limitations & Gotchas

- **Path Ignoring**:
  - Rules that include an `ignore` property can lead to unexpected exclusions if paths overlap with ignored items.
  
- **Dependency on CanonicalPath**:
  - If `CanonicalPath` is not defined in the context, the path matching logic will fail.

- **Rule Order**:
  - The first eligible rule takes precedence, which may lead to missing appropriate rules if not ordered correctly.

- **Conflict with Other Extensions**:
  - If other extensions manipulate the `b` object, there may be conflicts in setting `QualtricsZoneID` and `QualtricsZoneName`.

---

## 5. Recommendations for Refactoring

- **Guard Clauses**: 
  - Consider adding guard clauses to centralize and clarify filtering logic, thus improving readability.

- **Modularisation**:
  - Break down the logic into smaller functions for better code management and readability.

- **Comments**:
  - Enhance inline comments to clarify complex operations, especially around path matching and domain checks.

- **Array Methods**: 
  - Avoid chaining array methods without intermediate checks, as it can lead to reduced readability and potential hidden errors.

---

## 6. Maintenance & Further Notes

- **Testing Guidelines**:
  - Regularly test extensions in staging to ensure compatibility with newly added domains or paths.

- **Ownership**:
  - Assign ownership of this extension to a designated developer responsible for updates and documentation.

- **Continuous Improvement**:
  - Review and update the `loadRules` periodically to reflect changes in domain structures or analytics strategies. Make a note of significant framework or business changes that could affect data collection.

Maintain this documentation page for all developers and stakeholders to ensure comprehensive understanding and usage of the Qualtrics load rules extension within Tealium iQ.