# Tealium iQ Extension Documentation: Client Hints

## 1. Extension Overview
- **Name**: Client Hints
- **ID**: 100036
- **Type**: JavaScript Code
- **Scope**: Pre Loader
- **Execution Frequency**: Run Once

### Summary
The "Client Hints" extension is designed to gather detailed user agent information from the user's browser. It leverages the `navigator.userAgentData` API to retrieve high-entropy values, such as device brand, model, platform, and platform version. The extension then processes this data and sets it in the LBGAnalytics data layer for further use in analytics and targeting. By utilising client hints, this extension enhances the capability of capturing nuanced information about user devices, allowing for improved user experience and data-driven decisions.

---

## 2. Code Explanation

### Key Variables
- **clientHints**: An array containing the keys of the client attributes to be retrieved: `["brands", "mobile", "model", "platform", "platformVersion"]`.

### Logic Flow
1. **Retrieving Client Hints**:
    - The extension attempts to access the `navigator.userAgentData.getHighEntropyValues()` method with the `clientHints` array.
    - It then processes the returned user agent information within a promise.

2. **Setting Data Layer Values**:
    - For each property in the retrieved object (`ua`):
        - If the value is a *string* and not empty, a corresponding entry is set in the data layer.
        - If the value is a *number* or a *boolean*, it is also set appropriately, with booleans mapped to "Y" or "N".
        - If the value is an *object*, it is stringified and stored in the data layer.

3. **Data Layer Computed Values**:
    - The extension then defines computed properties for:
        - `ClientHintPlatform`: Concatenates the platform and platform version.
        - `ClientHintBrands`: Parses the brands JSON and formats it into a readable string.
        - `ClientHintMobile`: Simply retrieves the mobile data.

4. **Cleaning Up Data Layer**:
    - The extension listens for a "get" event, and upon triggering, it deletes any entries that start with "ClientHint_" from the data layer.

### Dependencies
- **LBGAnalytics**: This object is expected to be globally available and is used to set values in the data layer.

---

## 3. Usage Examples

### Normal Conditions
- When the extension is executed, it retrieves the following data:
  - Brands: `[{"brand":"Google","version":"Pixel"}]`
  - Mobile: `true`
  - Platform: `"Windows"`
  - Platform Version: `"10"`
  
The data layer will have entries like:
```json
{
  "ClientHint_brands": "[{\"brand\":\"Google\",\"version\":\"Pixel\"}]",
  "ClientHint_mobile": "Y",
  "ClientHint_platform": "Windows",
  "ClientHint_platformVersion": "10"
}
```
And the computed values:
```json
{
  "ClientHintPlatform": "Windows 10",
  "ClientHintBrands": "Google Pixel",
  "ClientHintMobile": "true"
}
```

### Edge Conditions
- If `userAgentData` is not supported:
  - The `try-catch` blocks ensure that the extension fails gracefully, but no data will be set in the data layer.
  
- If the `brands` data cannot be parsed:
  - The `ClientHintBrands` will return `undefined`.

---

## 4. Known Limitations & Gotchas
- **Browser Compatibility**: The `navigator.userAgentData` API is not fully supported in all browsers. This may result in no data being collected in environments (e.g., older versions of browsers).
- **Asynchronous Behaviour**: The asynchronous nature of `getHighEntropyValues()` may result in data layer updates occurring at unexpected times if other extensions are relying on this data.
- **Global Dependency**: Any alterations to the `LBGAnalytics` object by other scripts might interfere with this extension's functionality.

---

## 5. Recommendations for Refactoring
- **Error Logging**: Consider adding console logs or error handling to capture and understand any failures during data retrieval and processing.
- **Code Style**: Consistent indentation and use of whitespace would improve readability.
- **Modularisation**: Splitting this code into smaller functions could enhance maintainability and facilitate testing.
- **Defensive Checks**: While it is presumed `eventType` and `eventPayload` are present, additional checks or constraints could improve robustness.

---

## 6. Maintenance & Further Notes
- **Ownership**: Identify a designated team member responsible for maintaining the extension and overseeing updates or changes.
- **Testing Guidelines**:
  - Regularly test the extension across various browsers to ensure consistent performance and behaviour.
  - Employ monitoring metrics for the data layer to confirm values are being set as expected.
- **Future Scalability**: Maintain flexibility for potential future updates, especially as browser capabilities evolve regarding user agent data.

---

Ensure constant communication among team members when making adjustments to this extension or if any issues arise, to maintain alignment and effectiveness in data capture strategies.