```markdown
# Tealium iQ Extension Documentation: Pegasus Tag Abort Rules

## 1. Extension Overview
- **Name**: Pegasus tag abort rules
- **ID**: 100036
- **Type**: JavaScript Code
- **Scope**: 1521
- **Execution Frequency**: Active

### Summary
This extension manages the execution of Pegasus-related tags based on specific conditions set by the userâ€™s journey. It determines whether to proceed with or abort the tag firing based on the user's current state in the application journey, effectively preventing multiple or unwanted tag executions.

---

## 2. Code Explanation

### Key Variables
- **b**: Refers to the event payload object containing various properties related to the user journey.
- **pegasusAbortFlg**: A flag used to indicate whether the Pegasus tag should be aborted ('Y' for Yes, 'N' for No, and an empty string for undefined).
- **sessionStorage**: Used to maintain state across page reloads, specifically logging the Pegasus tag name fired during the session.

### Logic Flow
1. The execution begins by checking if the user's brand matches a predefined set of brands (LLOYDS, HALIFAX, BOS, MBNA).
2. It resets the `pegasusAbortFlg` to ensure any previous state does not influence the new execution.
3. Several conditional checks determine the user's current journey and application state, allowing the code to:
   - Set the abort flag (`setAbort`) based on specific conditions for various journey names and steps.
   - Use `sessionStorage` to track if the Pegasus tag has already been fired in the current session.
4. Finally, if the tag is called again in the session with the same name, it prevents it from firing again.

### Global Object Dependencies
- **utag**: Refers to the Tealium Universal Tag object which is used to send data back to Tealium.
- **clova3**: Likely refers to a specific data layer handling library that manages the setting of flags.

---

## 3. Usage Examples

### Normal Conditions
- When a user navigates through an application and completes a step that meets the criteria of `ApplicationState` and `JourneyName`, the corresponding Pegasus tag related to that journey will fire if the conditions for the abort flag are not met.

### Edge Conditions
- If a user navigates back to a previous journey step that has already triggered the Pegasus tag, the tag will check the `sessionStorage` and, if the tag name matches, will automatically abort the firing of the tag.

For example:
- **Scenario**: User completes 'Apply for a Loan' and moves to 'Application' state but then attempts to revisit a non-allowed step.
- **Result**: The extension sets `pegasusAbortFlg` to 'Y', preventing the tag from firing again.

---

## 4. Known Limitations & Gotchas
- If the user has browser settings that prevent the use of `sessionStorage`, the extension may not function as intended, allowing multiple tag firings for the same Pegasus tag name.
- The logic relies on correct naming conventions across journeys and states (e.g., 'ApplyLoan', 'ApplyPCA'). Any deviation might lead to unexpected behaviour.
- It is critical to ensure that this extension does not conflict with other extensions targeting the same journey, particularly those that also manipulate the `pegasusAbortFlg` or handle the same tag names.

---

## 5. Recommendations for Refactoring
- **Modularisation**: Consider breaking down the checks for each journey into separate functions. This will enhance readability and maintainability.
- **Consistent Naming**: Use constants for journey and application state names to avoid hardcoding strings throughout the code.
- **Improved Logging**: Integrate logging during the abort process to help in troubleshooting and understanding the flow during tag firing decisions.
- **Edge Case Handling**: Include checks for undefined or unexpected `JourneyName` and `JourneyStepName` values to gracefully handle potential errors rather than failing silently.

---

## 6. Maintenance & Further Notes
- Assign a dedicated team member to monitor the effectiveness of the extension as new journeys and application states are implemented.
- Regularly perform testing using various user journeys to ensure that the extension behaves as expected and to capture edge cases.
- Keep track of any known issues in a shared document to assist other developers who might encounter similar situations when working with the Pegasus tag functionality.
```
