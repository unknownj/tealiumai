# Tealium iQ Extension Documentation: Calculate Interest Income for Floodlight

## Extension Overview
- **Name**: Calculate interest income for floodlight
- **ID**: 1757
- **Type**: Javascript Code
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension calculates the interest income based on user-defined loan parameters. It processes data for floodlight tagging in marketing campaigns, enhancing the ability to track financial metrics by evaluating the loan amount, interest rate, and loan term. This calculation allows for informed marketing choices and performance tracking of financial products.

---

## Code Explanation

### Key Variables
- `term`: This represents the loan term, parsed as an integer from `JourneyTerm`.
- `amount`: The principal loan amount, parsed as an integer from `JourneyAmount`.
- `mi`: The monthly interest rate, calculated as `JourneyRate / 1200`.
- `MonthlyPayment`: The calculated monthly payment amount based on the loan parameters.
- `Income`: The total interest income calculated over the loan term.

### Logic Flow
1. The script checks for the existence of `JourneyAmount`, `JourneyRate`, and `JourneyTerm` to ensure all necessary data is present.
2. If `JourneyIncome` is not defined or is less than or equal to zero, the script proceeds to calculate the monthly payment using the formula for the annuity payment:
   \[
   \text{MonthlyPayment} = \left( \frac{\text{amount} \times \text{mi}}{1 - \left(\frac{1}{{(1+\text{mi})^\text{term}}}\right)} \right)
   \]
3. The total income is calculated as:
   \[
   \text{Income} = \text{MonthlyPayment} \times \text{term} - \text{amount}
   \]
4. The calculated interest income is then assigned to `utag.data.JourneyIncome`, passed to `clova3.datalayer`, and saved into the `b` object for further tracking.

### Dependencies
- This extension relies on the `utag` global object for data handling and the `clova3` object for interacting with the data layer.

---

## Usage Examples

### Normal Condition
- **Input**:
    - `JourneyAmount`: 10000
    - `JourneyRate`: 5
    - `JourneyTerm`: 24
- **Output**:
    - `JourneyIncome` calculates an income value based on the loan, returning the correct total interest to be tracked.

### Edge Conditions
1. If any of `JourneyAmount`, `JourneyRate`, or `JourneyTerm` are undefined, the extension will not execute the income calculation.
2. If `JourneyIncome` is already defined and greater than zero, the extension will not overwrite it.

For example:
- **Input**:
    - Missing or invalid values for `JourneyTerm`: 
        - Input: `JourneyAmount`: 10000, `JourneyRate`: 5, `JourneyTerm`: undefined
    - **Output**: No changes to `JourneyIncome`.

---

## Known Limitations & Gotchas
- The extension does not handle cases where the interest rate (`JourneyRate`) is negative or where `JourneyTerm` is non-numeric. Such inputs can lead to unexpected outcomes.
- Conflicts may arise if other extensions are manipulating the same `utag.data` properties without appropriate management strategies.

---

## Recommendations for Refactoring
1. **Defensive Checks**: Although eventType and eventPayload are guaranteed, additional checks for the validity of loan values should be included to prevent runtime errors.
2. **Code Style**: Ensure consistent indentation and spacing for better readability.
3. **Modularization**: Consider breaking down long calculations into smaller helper functions to enhance readability and maintainability, especially if further functionalities are added in the future.
  
For example, separate functions for calculating monthly payment and total income could clarify intent and isolate logic.

---

## Maintenance & Further Notes
- It is advisable to routinely test the extension with varying inputs to ensure it handles all calculated paths correctly.
- Document ownership for periodic reviews and maintenance updates.
- Consider implementing unit tests where possible to facilitate automated testing of the extension's logic.

### Testing Guidelines
- Always validate the inputs before invoking the calculation.
- Verify that the output aligns with expected results across a broad range of test cases, particularly with edge conditions.

--- 

This documentation serves as a comprehensive guide for understanding, using, and maintaining the Tealium iQ extension for calculating interest income. Please ensure this document is reviewed periodically and updated as necessary to reflect any changes in functionality or additional learnings.