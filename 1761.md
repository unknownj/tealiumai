# Tealium iQ Extension Documentation: AEM Fragment Code

## 1. Extension Overview

- **Name**: AEM Fragment Code
- **ID**: 100036
- **Type**: JavaScript Code
- **Scope**: DOM Ready
- **Execution Frequency**: Run Once

### Summary
The AEM Fragment Code extension is designed to track user interactions within the Secure AEM Hub. It specifically identifies clicks on a button with the ID `showresult` and initiates the process of gathering relevant form data. The collected data is then packaged and sent to the Celebrus tracking system, allowing detailed analysis of user behaviour and engagement with forms across the platform.

---

## 2. Code Explanation

### Key Variables
- **`celebrusTagObject`**: An object that holds the necessary parameters for sending data to Celebrus. Consent must come from the correct index (1222) in `utag.sender`.
- **`fields`**: An array capturing the names and values of the form input fields and their equivalent sections.
- **`ocisID`, `brandName`**: Variables holding specific identifiers retrieved from the data layer for tracking purposes.

### Logic Flow
1. The extension listens for clicks on the document body.
2. It checks if the click event target is the `showresult` button or a parent element containing that ID.
3. Upon a valid click, it initializes and populates the `celebrusTagObject` with:
   - `CelebrusFormID` from the query string.
   - `CelebrusJourneyID` generated as a UUID.
   - Incremental tracking via `CelebrusSendIndex`.
   - Names and values from input fields.
4. It then sends the data to the Celebrus system using `window.utag.track`.
5. Optionally, it populates Adobe Analytics' properties (`s.prop61`, `s.prop62`, etc.) with the same form data.

### Global Dependencies
- **`utag`**: Tealium's globally accessible object used for tracking.
- **`document`**: The browser's Document Object Model (DOM) for HTML manipulation.
- **`LBGAnalytics`**: Presumed global object for accessing the data layer, specifically `LBGAnalytics.datalayer.get()`.

---

## 3. Usage Examples

### Normal Condition
1. A user clicks the "show result" button on a form within the Secure AEM Hub.
2. The event triggers the collection of input field data.
3. `celebrusTagObject` is populated and the data is sent to Celebrus, logging the necessary fields.

### Edge Condition
- If no data is available in input fields, the system produces an empty payload but still executes the tracking event.
- If an event is triggered but elements are absent, the code gracefully handles the scenario without throwing additional errors, resulting in console logging.

---

## 4. Known Limitations & Gotchas
- The extension is primarily tied to the specific structure of the DOM. If the structure changes, it could break the functionality.
- There is no extensive error handling beyond console logging, which could lead to untracked events if unforeseen errors occur.
- Dependencies on the structure of the input fields (`.scep-input`) and visible areas (`div.section > div.section-wrapper`) mean modifications to these classes or IDs in the DOM may lead to incomplete tracking.
- The referenced `utag.sender[1222]` must exist for successful data transmission; otherwise, the extension will exit early.

---

## 5. Recommendations for Refactoring
- **Modularize Functions**: Break down the code into smaller, reusable functions for readability and maintainability. For instance, user input collection could be a separate function.
- **Defensive Checks**: Although eventType and eventPayload are guaranteed, adding more checks for field existence before processing could prevent potential issues.
- **Error Handling**: Consider implementing a more robust error-handling method instead of simply logging to the console, potentially alerting developers during testing phases.
- **Commenting**: Maintain clear, consistent comments throughout the code, particularly on complex logic segments or where assumptions are made.

---

## 6. Maintenance & Further Notes
- **Ownership**: Assign a maintainer responsible for oversight and updates to ensure ongoing functionality with platform changes.
- **Testing Guidelines**: Regularly test the extension in various browsers and devices to ensure consistent behaviour. Automated testing for critical paths could enhance reliability.
- **Documentation Updates**: As changes are made to the extension, ensure all documentation is kept up to date to reflect the current state of the code and its capabilities.

By adhering to these structured guidelines, developers and stakeholders may find it easier to manage, maintain, and understand the AEM Fragment Code extension's functionality within the Tealium iQ ecosystem.