# Tealium iQ Extension Documentation

## 1. Extension Overview
- **Name**: CM GDC : TAG : Set : Payload : Source, Type and Category Variables
- **ID**: 1764
- **Type**: JavaScript Code
- **Scope**: 1516, 1518
- **Execution Frequency**: On tag firing

### Summary
This extension is mapped to all Google DoubleClick tags. Its primary functionalities include:
1. Validating whether `DC_target` has been populated. If not, the execution is aborted to prevent the tag from firing.
2. Unpacking the `DC_target` variable by splitting its string representation, and subsequently assigning the split values to `DC_src`, `DC_type`, and `DC_cat`. If `DC_src` is not populated, only `DC_type` and `DC_cat` are assigned.

---

## 2. Code Explanation

### Key Variables
- **a**, **b**, **u**: The parameters passed into the self-executing function where:
  - `a` is the event type.
  - `b` is the event payload object, which contains the key-value pairs.
  - `u` is the object containing utility functions and extensions loaded in Tealium.

- **active**: A flag to check if the current extension is actively processing.
- **dcObject**: An object that stores the mapped values for `DC_src`, `DC_type`, and `DC_cat`.

### Logic Flow
1. The extension begins processing by checking the order of extensions to ensure that it runs when `DC_target` is available.
2. The function `checkDcTarget` checks if `DC_target` is defined and non-zero.
3. If `DC_target` is not populated, the function returns `false`, halting further processing and ensuring the tag does not fire.
4. If populated, `DC_target` is passed to the `unpackDc` function, splitting its string values into an array.
5. The length of the resulting array determines how the values are mapped into the `dcObject`:
   - **2 values**: Calls `createDefaultObj`.
   - **3 values**: Calls `createSrcObj`.
   - **5 values**: Calls `createGADObj`.
6. The values in `dcObject` are then merged back into the event payload object `b`.
7. Finally, if appropriate, a formatted string for Google Ads is constructed.

### Dependencies
- The extension relies on the following global objects:
  - `utag`: Specific to Tealium, enabling logging and extension management.
  - `gtagobj`: A variable defined at the end, expected to be used in conjunction with Google Ads tracking.

---

## 3. Usage Examples

### Normal Flow
1. If `DC_target` is defined as "srcValue!typeValue!catValue":
   - The extension would return `true`, mapping `srcValue`, `typeValue`, and `catValue` into corresponding keys in the payload.

### Edge Conditions
- **Scenario 1**: If `DC_target` is `0` or `undefined`:
  - The extension aborts execution, returning `false`.
  
- **Scenario 2**: If `DC_target` is "typeValue!catValue" (with `DC_src` absent):
  - The extension maps only `typeValue` and `catValue` into the payload.

- **Scenario 3**: If `DC_target` is configured with additional Google Ads elements, such as "srcValue!typeValue!catValue!conversionId!conversionLabel":
  - The extension will map all five values appropriately.

---

## 4. Known Limitations & Gotchas
- If `DC_target` is not formatted as expected (different delimiters or incorrect string lengths), the mapping may not occur properly.
- Conflicts may arise with other extensions that manipulate the payload before this extension executes. Ensure `DC_target` is defined before loading this extension.
- If other scripts depend on the same `DC_target`, be cautious of unexpected overwrites in the event payload.

---

## 5. Recommendations for Refactoring
- **Defensive Checks**: Consider adding checks to validate the structure of `DC_target` before processing to handle erroneous formats gracefully.
- **Code Style**: Maintain consistent indentation and spacing for improved readability.
- **Modularization**: Break down the large functions into smaller, reusable ones. For example, the merging of values into `b` could be encapsulated in its own function.
- **Documentation**: Comment on critical code sections for clarity, especially regarding data structure assumptions.

---

## 6. Maintenance & Further Notes
- Regularly review and test the extension with various formats of `DC_target` to ensure robustness.
- Documentation should be kept up-to-date with any changes or additions to the mapping logic.
- Ownership should be assigned to a specific developer for ongoing maintenance and updates.
- Test the extension alongside integrated Google Ads and DoubleClick tags to confirm seamless operation in the analytics pipeline. 

--- 

This documentation serves as a comprehensive guide to understanding, implementing, and maintaining the Tealium iQ extension for managing Google DoubleClick tags and associated variables.