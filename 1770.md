# Tealium iQ Extension Documentation

## 1. Extension Overview

- **Name**: CM : TAG : Set : Mappings : Source, Type and Category Variables
- **ID**: 1770
- **Type**: Javascript Code
- **Scope**: 1518
- **Execution Frequency**: Active

### Summary
This Tealium iQ extension is designed to manage mappings for Google DoubleClick tags. It efficiently injects a mapping object (`u.map`) into all relevant tags, allowing for simplified updates across multiple tags from a single point. This means any changes to the mapping can be handled in one place, ensuring consistent data flow without the need to modify each tag individually.

---

## 2. Code Explanation

### Key Variables

- **`u.map`**: An object containing key-value pairs for various identifiers required by Google DoubleClick tags, including type, category, source, and journey metrics.
- **`b`**: Represents the global object (usually the `window` object) where additional parameters and identifiers are set.
- **`DC_src`**: Set to `DCSrcLkp` when `DC_target` does not exist, ensuring that the source is linked to the correct advertiser.

### Logic Flow
1. **Mapping Object Injection**:
   - The code starts by checking if `b.DC_target` is undefined. If so, it assigns `b.DC_src` a value from `b.DCSrcLkp`.
   - It then creates the `u.map` object, which maps various identifiers to respective values.

2. **PII Scrubbing**:
   - The code iterates through the `b` object and checks for any string values containing "@" or "%40", which are indicative of personal identifiable information (PII). If found, these values are cleared to prevent PII leakage.

3. **Consent Management**:
   - The extension checks the consent status using `LBGAnalytics.privacy.decodeCookie().statusCode`. If the status does not indicate a valid consent state ("y" or "t"), certain identifiers (`paid_order_id`, `FirstPartyCookie`, `applicationID`, `MobileAdvertiserID`) are removed from `u.map` to comply with consent regulations.

### Dependencies
- **Global Objects**: The extension relies on the global `LBGAnalytics` object for consent checks.
- **Event Handling**: The parameters `eventType` and `eventPayload` are passed into the function, indicating the context of the event triggering the extension.

---

## 3. Usage Examples

### Scenario 1: Normal Operation
- When a page loads that requires Google DoubleClick tags, the extension runs and injects the mappings into the `u.map` object. For instance, if the page type is a product page, the key `DC_type` would be set to "product".

### Scenario 2: PII Detection
- If a user visits a page where their email address is captured in the `b` object, the extension will scrub this information and clear it before it is passed to DoubleClick tags. As a result, there won't be any PII sent inadvertently.

### Scenario 3: Consent Scenario
- If user consent is not granted (indicated by the absence of required status codes), the specific identifiers in `u.map` will be removed. For instance, `MobileAdvertiserID` will not be included in the mapping if consent is lacking, ensuring compliance with privacy regulations.

---

## 4. Known Limitations & Gotchas

- **Performance Concerns**: Since the extension scrubs each key in the `b` object for PII, this could lead to performance issues if the object is particularly large or if this extension is used in combination with numerous other intensive scripts.
- **Scope Limitations**: The mapping logic is primarily scoped to Google DoubleClick tags. If other tag types require similar mappings, this extension may not apply and those tags would need additional handling.
- **Global Dependency**: The reliance on `LBGAnalytics` means that if this object is modified or removed in future updates, the extension may fail, necessitating close monitoring of changes in analytics configurations.

---

## 5. Recommendations for Refactoring

- **Defensive Checks**: Although we do not need to account for the presence of `eventType` or `eventPayload`, initial checks could be implemented for the existence of `b` or `u` to enhance robustness.
- **Code Style**: Maintaining consistent variable naming conventions helps readability. Consider ensuring the naming of keys in `u.map` aligns with established standards.
- **Modularisation**: Consider breaking down the logic for PII scrubbing and consent checks into reusable functions. This would not only improve readability but aid in testing and maintenance.

---

## 6. Maintenance & Further Notes

- **Ownership**: This extension should be owned by the analytics team, ensuring that any changes to the mapping are communicated across relevant teams.
- **Testing Guidelines**: Each update or change to the mapping logic should be tested in a staging environment before deployment. Testing should include scenarios for PII leakage and consent checks.
- **Documentation Updates**: Ensure that any changes in mapping, logic flow, or dependencies are documented promptly to keep this extensionâ€™s documentation accurate and useful.

By following this structured approach, the extension can be effectively maintained and adapted to changing requirements while ensuring compliance with privacy standards.