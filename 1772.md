# Tealium iQ Extension Documentation: CM test : Halifax_Pegasus_Counters_Tealium_Lookup

## 1. Extension Overview

- **Name**: CM test : Halifax_Pegasus_Counters_Tealium_Lookup
- **ID**: 1773
- **Type**: Lookup Table
- **Scope**: 1516, 1518
- **Execution Frequency**: Active

### Summary
This extension maps specific conversion identifiers and journey variables for Google AdWords through a hardcoded JavaScript object. By centralising the mapping in one place, it ensures uniformity across all Google AdWords tags, allowing for easy maintenance by only updating a single location if changes to the mapping variables are necessary. The extension also considers user consent, removing certain identifiers if consent is not granted, thus ensuring compliance with privacy regulations.

---

## 2. Code Explanation

### Key Variables
- **`u.map`**: An object that holds the mapping between Google AdWords identifiers and custom variables. This includes properties like "ConversionID", "JourneyName", and "paid_order_id".
    - Example:
        ```javascript
        "JourneyName": "custom.journey_name"
        ```

### Logic Flow
1. The extension first assigns a mapping object to `u.map` containing key-value pairs of identifiers.
2. It checks for user consent through a function `LBGAnalytics.privacy.decodeCookie()`. If consent is not granted (i.e., the status code is not "y" or "t"), it deletes the `paid_order_id` and `ApplicationID` from the mapping to prevent sending user identifiers without consent.
3. The outer function wraps the logic to ensure that the mapping and consent management only execute in the context of the specific event and payload provided.

### Dependencies
- **Global Objects**: This extension relies on a global consent management library `LBGAnalytics` and its method `decodeCookie()`. If this function is not defined, the extension will not execute consent checks correctly.
- **Tealium Environment**: The extension is designed specifically to work with Google AdWords and may require that the respective tags are present and correctly configured.

---

## 3. Usage Examples

### Scenario 1: Normal Flow
- **Input**:
    - `eventType`: "track"
    - `eventPayload`: {"conversion_id": "12345", "conversion_label": "abcd", "user_status": "consented"}

- **Output**:
    The mapping is retained, meaning all identifiers, including "paid_order_id" and "ApplicationID", are sent to Google AdWords since user consent is granted.

### Scenario 2: No Consent
- **Input**:
    - `eventType`: "track"
    - `eventPayload`: {"user_status": "not_consented"}

- **Output**:
    The identifiers `paid_order_id` and `ApplicationID` are removed from `u.map`, thus ensuring that no identifiable information is sent to Google AdWords.

### Edge Condition
- If the `LBGAnalytics.privacy.decodeCookie()` method fails or returns an unexpected status, the identifiers remain in `u.map`, potentially compromising user privacy.

---

## 4. Known Limitations & Gotchas

- **Consent Management Dependency**: The functionality is heavily reliant on the existence and performance of the `LBGAnalytics.privacy.decodeCookie()` function. If this is altered or removed, the extension will not behave as intended.
  
- **Data Integrity**: If mappings are altered after they are set, inconsistencies might occur across different Google AdWords tags unless thoroughly tested with all scenarios.

- **Variable Scopes**: Ensure that `eventType` and `eventPayload` are appropriately defined in the context where this extension is executed; otherwise, it would throw an undefined error.

- **Compatibility**: The scope limitation means this extension will not function if executed outside of the specified tags (1516, 1518).

---

## 5. Recommendations for Refactoring

- **Modularization**: Isolate the mapping object construction and the consent checking into separate functions for better readability and maintenance. This will also benefit unit testing.
  
    ```javascript
    function createMapping() {
        return {
            "ConversionID": "conversion_id",
            ...
        };
    }

    function checkConsent() {
        return (["y", "t"]).indexOf(LBGAnalytics.privacy.decodeCookie().statusCode) >= 0;
    }
    ```

- **Code Comments**: While there are existing comments, consider adding more specific inline comments explaining the purpose and expected values of each key in the mapping object for thorough understanding.

- **Defensive Checks**: While this is not required, consider adding logging or deferring the deletion of IDs to easily track if consent checks fail.

---

## 6. Maintenance & Further Notes

- **Ownership**: Assign a specific team member responsible for maintaining this extension to ensure updates are made as needed, especially regarding mapping changes and compliance requirements.

- **Testing Guidelines**: Continuously test the extension under varied scenarios, specifically focusing on consent states. Utilise sandbox environments to ensure that updates do not introduce bugs.

- **Documentation Updates**: Keep documentation and comments within the code up-to-date after any change to ensure clarity for future developers.

- **Version Control**: Use version control practices to manage changes in the extension to facilitate rollback if any issues arise.

By following these guidelines, the extension can be successfully maintained and extended over time without losing functional integrity or compliance with user privacy regulations.