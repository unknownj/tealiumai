# Tealium iQ Extension Documentation: Set Click IDs for Event Stream

## 1. Extension Overview

- **Name**: Set click IDs for event stream
- **ID**: 100036
- **Type**: Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
This Tealium iQ extension is designed to capture various click identifiers (Click IDs) from UTM parameters, specific cookies, and other sources in order to attribute user engagement accurately to marketing campaigns. It checks for each identifier systematically and logs it into the `clova3.datalayer`. This functionality is crucial for businesses that rely on digital marketing analytics to assess campaign performance.

## 2. Code Explanation

### Key Variables
- `click_id`: A special identifier that tracks where the user clicked before arriving at the site.
- `clova3.datalayer`: An object responsible for managing the data layer where various campaign-related data metrics are stored.

### Logic Flow
1. **Click ID Assignment**:
   - The extension first checks if `click_id` is already set in `clova3.datalayer`.
   - If not set, it tries to extract `facebook` and `google` identifiers from the `utag.data` object:
     - If `cp._fbc` is available, it sets it as `click_id` and logs the source as `facebook`.
     - If `qp.gclid` is available, it sets it as `click_id` and logs the source as `google`.

2. **Logging Other Identifiers**:
   - The extension proceeds to check for several other parameters: 
     - `gbraid`, `wbraid`, `dclid`, `gclid`, `fbclid`, and `ttclid`.
   - Each found identifier is set in `clova3.datalayer` with logging for analytics.

### Dependencies
- `utag`: A global Tealium object that contains various data points.
- `clova3`: A custom global object where the Datalayer information is stored.
- `LBGAnalytics`: An optional global object for logging analytics. Its presence is checked before any logging occurs to avoid runtime errors.

## 3. Usage Examples

### Normal Flow
- A user clicks a link from a Facebook ad with the `fbclid` parameter. This parameter is parsed and stored as `click_id` in the datalayer. A data layer structure may look like this:
    ```javascript
    {
      "click_id": "fb_content_id_123",
      "click_source": "facebook"
    }
    ```

### Edge Condition
- If a user arrives with both `fbclid` and `gclid`, the code ensures only one of these is set as `click_id`, priority being given to `cp._fbc`. The other parameter will still be collected and stored in the datalayer without overwriting the `click_id`.

## 4. Known Limitations & Gotchas

- **Overwriting Click IDs**: If both `fbclid` and `gclid` are present, only the Facebook click ID will be recorded, which may not be desirable for certain users coming from Google Ads.
- **Dependence on Other Data**: The logic relies on external data from both cookies and UTM parameters. If parameters change on the source side, adjustments to the extension may be necessary.
- **Performance Impact**: The current structure of multiple conditional checks may affect performance if there are a large number of load rules.

## 5. Recommendations for Refactoring

- **Code Style**: Consistency in logging and variable naming could improve readability. Aim for clear naming conventions for all parameters being set in the datalayer.
- **Modularization**: Consider breaking down the extension into smaller functions. For instance, create helper functions to handle the extraction and setting of each type of identifier.
  
Example functionization:
```javascript
function setClickId(paramName, source) {
    if (typeof utag.data[paramName] !== 'undefined') {
        clova3.datalayer.set(paramName, utag.data[paramName], true);
        if (LBGAnalytics && LBGAnalytics.analyticsLog) {
            LBGAnalytics.analyticsLog(source + " > datalayer");
        }
    }
}
```
- **Defensive Checks**: Although eventType and eventPayload are guaranteed, other critical aspects within the extension can be safeguarded by checking for their existence before performing actions.

## 6. Maintenance & Further Notes

- **Ongoing Maintenance**: Regularly review the logic to ensure it aligns with the evolving UTM naming conventions. Update any deprecated parameter names as necessary (e.g., rename `facebook_customer_id`).
- **Ownership**: Assign a team member to monitor the performance and accuracy of data captured by this extension actively.
- **Testing Guidelines**: Conduct regression tests whenever changes are made, especially if there are updates to UTM structures or the addition of new traffic sources.

---

### Additional Resources
Please refer to the internal documentation on UTM parameters and campaign tracking for further understanding of the data being handled by this extension.