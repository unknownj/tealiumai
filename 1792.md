# Tealium iQ Extension Documentation: Firestore DCsrc and DC Activity Lookup

## 1. Extension Overview

- **Name**: Firestore DCsrc and DC activity lookup
- **ID**: 1797
- **Type**: Lookup Table
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension is designed to override the default Webchat platform settings based on specific conditions related to the domain and path of the web page. It examines the canonical domain, user agent, and the current URL path to determine the appropriate value for `WebchatPlatformOverride`. This ensures that users receive a tailored experience based on where they are on the site or the browser they are using.

---

## 2. Code Explanation

### Key Variables
- **b.WebchatPlatformOverride**: A property within the `eventPayload` object that is modified to reflect the appropriate platform override based on various conditions.
- **window.top**: Utilised to check if the script is running in the top-level window.

### Logic Flow
1. **Domain Checks**: The extension first checks if the canonical domain includes specific identifiers (`cbonline`, `cbsecure`, or `clublloyds.com`). If found, it sets `b.WebchatPlatformOverride` to "Other".
2. **Path Check**: It checks if the current URL pathname contains `/mortgages/landing/`, setting the override to "Other" if true.
3. **User Agent Check**: It inspects the user agent string to detect Internet Explorer 11 (Trident/7). If detected, it sets the override to "IE11".
4. **Edge Cases**: Enclosing the user agent check in a try-catch block ensures that the script does not break execution if an error occurs.

### Dependencies
This extension relies on the global object `window`, specifically:
- `window.navigator` for accessing the user agent.
- `window.location` for obtaining the current URL path.
- `window.top` to ascertain the window context (if it's the top-level frame).

---

## 3. Usage Examples

### Sample Scenario 1: Normal Operation
- **Conditions met**: User is on `https://www.cbonline.com/homepage`.
- **Expected Behaviour**: The script will set `b.WebchatPlatformOverride` to "Other" since the canonical domain includes "cbonline".

### Sample Scenario 2: User Agent Detection
- **Conditions met**: User accesses the site using Internet Explorer 11.
- **Expected Behaviour**: The script detects `"trident/7"` in the user agent and sets `b.WebchatPlatformOverride` to "IE11".

### Edge Condition: No Matches
- **Conditions met**: User is on `https://www.example.com`, using a non-IE browser.
- **Expected Behaviour**: The extension will not modify `b.WebchatPlatformOverride`, resulting in its value remaining unchanged unless set elsewhere in the system.

---

## 4. Known Limitations & Gotchas

- **Browser Compatibility**: The extension specifically checks for IE11 but may not handle other versions of Internet Explorer or other legacy browsers.
- **Dependency on `window.top`**: If the script runs in an iframe and a condition matches, there may be unexpected behaviour. It should be ensured that these domains are intended to provide overrides when in nested contexts.
- **Potential Conflicts**: If other extensions modify `b.WebchatPlatformOverride` post-execution of this script, it may overwrite the desired values.
- **No Fallback**: If none of the conditions are met, there is no fallback strategy which means the variable may remain undefined or have unwanted values.

---

## 5. Recommendations for Refactoring

- **Modularisation**: Consider segmenting the checks into separate functions for clarity. This would improve readability and maintainability.
- **Consistent Style**: Maintain consistent code formatting (e.g., spacing, indentation) for improved readability.
- **Defensive Checks**: Although the guidelines state not to implement checks for the availability of `eventType` or `eventPayload`, consider logging the state of these objects on execution for easier debugging and monitoring.
- **Commenting**: Add comments to complex logic blocks to explain what each section is doing for future developers.
- **Remove Duplicates**: The wrapping of the main function is redundant and can be simplified; consider removing one of the wrapping functions.

---

## 6. Maintenance & Further Notes

- **Ownership**: Assign a dedicated owner for this extension who will be responsible for updates and improvements.
- **Testing Guidelines**: Develop testing scenarios that cover all conditional branches, including edge cases, to validate the desired functionality upon changes.
- **Change Log**: Maintain a changelog for any modifications made to the script for clarity among the team.
- **Documentation Updates**: Ensure this documentation is reviewed and updated following any changes to the code or functionality to keep it relevant.

---

This documentation is essential for providing clarity and enhancing future collaboration among developers within the Tealium iQ ecosystem.