# Tealium iQ Extension Documentation

## 1. Extension Overview

- **Name**: Firestore ID lookup payload unpack
- **ID**: 1798
- **Type**: Javascript Code
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension is designed to enhance the functionality of Google DoubleClick tags within the Tealium iQ environment. It performs two primary tasks:
1. Validates whether the `DC_target` datalayer variable is populated. If it is not populated, the extension halts the firing of the associated tags.
2. Unpacks the `DC_target` data by splitting it based on the delimiter `!`, effectively segregating and storing its components into separate datalayer variables: `DC_src`, `DC_type`, and `DC_cat`.

## 2. Code Explanation

### Key Variables
- **`a`**: Represents the event type parameter passed to the function (not used in the code).
- **`b`**: Represents the event payload object that contains the data variables.
- **`dcObject`**: An object that will hold the mapped values from the unpacked `DC_target`.
- **`flag`**: A boolean flag indicating the presence of `DC_IDs`.

### Logic Flow
1. **Check for `DC_IDs` Presence**: The function `checkDcIDs` checks if `b.DC_IDs` is defined and not zero. If not, it returns false and prevents further execution.
2. **Unpacking Data**: If `DC_IDs` is present, the `unpackDc` function splits its value into an array based on the delimiter `!`.
3. **Object Creation**: The `createActObj` function takes the unpacked array and maps it into an object with `DC_src` and `DC_act` as properties.
4. **Merging Values**: The values from `dcObject` are merged into the `b` object for event payload.
5. **Data Layer Assignment**: Finally, the processed `DC_act` and `DC_src` are stored in both Tealium's `utag.data` and an external data layer (`clova3.datalayer`).

### Dependencies
- Global objects `utag` and `clova3.datalayer` are used for storing values in the respective data layers.

## 3. Usage Examples

### Normal Case
- If `b.DC_IDs` is `"srcValue!typeValue"`, the extension will:
  - Create an object: `{ DC_src: "srcValue", DC_act: "typeValue" }`.
  - Store `DC_src` and `DC_act` in both Tealium and the external data layer.

### Edge Case
- If `b.DC_IDs` is an empty string or `undefined`, the extension:
  - Will return `false`, preventing the associated Google DoubleClick tags from firing.
- If `b.DC_IDs` is incorrectly formatted, e.g., `"srcValue!"`, the extension will end up with an object containing only the `DC_src`.

## 4. Known Limitations & Gotchas

- The extension currently assumes that `DC_IDs` will always be string-type. If passed an unexpected type (like an object or array), it may cause the unpacking logic to fail silently.
- There might be conflicts if another extension manipulates the same datalayer variables (`DC_src` or `DC_act`) before this extension runs.
- Improper formatting of the `DC_target` string (e.g., missing `!` delimiter) can lead to unexpected results, which this extension does not handle explicitly.

## 5. Recommendations for Refactoring

- **Defensive Checks**: Add explicit checks to ensure that the `DC_IDs` being passed is a string before attempting to unpack it.
- **Code Modularity**: Consider breaking down the logic into smaller functions with clear responsibilities, which promotes reusability.
- **Error Handling**: Implement error logging for easier troubleshooting if unexpected values are passed.

### Style Suggestions
- Consistent naming conventions for functions and variables to enhance code readability and maintainability.

## 6. Maintenance & Further Notes

- **Maintenance Responsibility**: Assign a specific team or individual for ongoing oversight of this extension, ensuring they are familiar with both Tealium and JavaScript.
- **Testing Guidelines**: Conduct unit tests whenever changes are made to the extension to verify both normal and edge-case behaviours.
- **Documentation Updates**: Keep this documentation up-to-date with any changes to the extension logic or purpose. Regular reviews should be scheduled to ensure it remains relevant.

--- 

This comprehensive documentation captures the essential details of the Tealium iQ extension, aimed at helping other developers and stakeholders understand its purpose, functionality, and management.