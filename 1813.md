# Tealium iQ Extension Documentation: Sustainability Metrics

## 1. Extension Overview

- **Name**: Sustainability Metrics
- **ID**: 100036
- **Type**: Javascript Code
- **Scope**: DOM Ready
- **Execution Frequency**: Run Once

### Summary
The "Sustainability Metrics" extension is designed to collect various performance metrics related to the web page's elements and body size. It captures critical data such as the number of elements on the page, the size of the body content, and various performance metrics from the browser's navigation timing API. This data is sent to LBGAnalytics only under specific conditions (with a very low random probability of occurrence). The purpose of this extension is to gather insights into page performance, which can inform optimisations for sustainability and user experience.

---

## 2. Code Explanation

### Key Variables
- **sustainabilityMetrics**: An object where certain key metrics will be stored:
  - `elementsOnPage`: The total number of HTML elements found on the page.
  - `bodySize`: The total number of characters in the bodyâ€™s HTML.
  - `transferSize`: The size of the resource transferred from the server.
  - `decodedBodySize`: The size of the body after decoding.
  - `encodedBodySize`: The size of the body as it was sent over the network.

### Logic Flow
1. The extension executes only once on DOM Ready.
2. A random number between 0 and 1 is generated and checked to be less than 0.001. If true, the following steps are executed:
   - An object `sustainabilityMetrics` is created to store performance data.
   - Various metrics are collected using:
     - `document.querySelectorAll("*")` for the number of elements.
     - `document.body.innerHTML.length` for the body size.
     - `window.performance.getEntriesByType("navigation")` to obtain performance metrics.
   - A check (`dataIsBroken`) is performed to ensure collected metrics are valid and within a reasonable range.
   - If valid, the data is sent to the LBGAnalytics using several generic event calls.
3. If a JavaScript error occurs during execution, it is caught silently (with no action taken).

### Dependencies
- **Global Objects**:
  - `document`: Used to access the DOM and count elements.
  - `window.performance`: Used to obtain performance metrics about the page load.
  - `LBGAnalytics`: Assumed to be a global analytics library that handles event logging.

---

## 3. Usage Examples

### Normal Condition
When the page is fully loaded, and the random condition passes (i.e., `Math.random() < 0.001`):
- The extension collects performance data and checks its validity.
- If data is valid, it pushes data regarding the number of elements, body size, and performance metrics to LBGAnalytics.

### Edge Condition
If the number of elements or body size is outside the range of 0 and 10,000,000, the `dataIsBroken` flag will be set to true, and no event data will be sent, thereby avoiding erroneous data submission.

### Error Handling Scenario
In the event of a JavaScript error during metric collection, the error is caught, and the extension will fail silently. No data will be sent, but no errors will be reported, which means there may be lost metrics without notification.

---

## 4. Known Limitations & Gotchas

- **Randomisation**: The low probability condition (0.1%) means that the data may not be collected consistently, making it hard to gather comprehensive metrics frequently.
- **Error Handling**: Errors are caught silently, which could mask underlying issues. Debugging can become challenging if performance metrics do not appear as expected since no feedback is provided.
- **Performance Impact**: Using `document.querySelectorAll("*")` can be performance-intensive and may slow down the page if executed on complex documents.
- **Library Dependencies**: Assumes that the `LBGAnalytics` object is available and properly configured; otherwise, it will fail to log metrics.

---

## 5. Recommendations for Refactoring

- **Validating Performance Metric Collection**: Instead of silently catching errors, consider logging an error message to the console for easier debugging when issues occur.
- **Improve Performance**: Limit the scope of `document.querySelectorAll()` to a smaller section of the DOM if possible, rather than querying all elements. This can enhance performance.
- **Extract Reusable Functions**: The collection of sustainability metrics could benefit from being encapsulated in a function to improve modularity and readability.
- **Use of Variables**: Consider using variables explicitly for the values fetched from the `window.performance` methods to enhance clarity, e.g.:
  ```javascript
  var navigationEntries = window.performance.getEntriesByType("navigation")[0];
  ```

---

## 6. Maintenance & Further Notes

- **Ownership**: Assign a specific owner for ongoing maintenance of the extension to ensure updates, debugging, and performance tuning are handled timely.
- **Testing Guidelines**:
  - Routine testing should be conducted to verify that the metrics collected appear as expected.
  - Use tools like Chrome DevTools for performance analysis to observe any adverse effects.
  - Consider A/B testing the extension to validate if the collected metrics change significantly based on randomised frequencies.

- **Documentation Updates**: Regular updates should be made as the extension evolves or if new metrics are introduced, ensuring all stakeholders are informed of changes.