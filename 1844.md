# Tealium iQ Extension Documentation: Nav Tracking 2023

## 1. Extension Overview

- **Name:** Nav Tracking 2023
- **ID:** 1844
- **Type:** JavaScript Code
- **Scope:** Pre Loader
- **Execution Frequency:** Run Once

### Summary
The "Nav Tracking 2023" extension is designed to track user interactions with navigation links on a webpage. It collects data on various categories of navigation elements—including progressive navigation, mega navigation (versions 2 and 3), and promotional boxes—by capturing the link path and visibility state of each interacted element. This data is intended to enhance the analytics capabilities related to user navigation and improve overall site navigation strategies.

---

## 2. Code Explanation

### Key Variables
- `SELECTOR_PROGRESSIVE`: Selector for progressive navigation links.
- `SELECTOR_MEGAV2`: Selector for version 2 mega navigation links.
- `SELECTOR_MEGAV3`: Selector for version 3 mega navigation links.
- `SELECTOR_PROMO`: Selector for promotional box links.
- `LINK_DELIMITER`: Character used to delimit link path segments.
- `STORAGE_KEY`: The key used to store cached payload in `sessionStorage`.

### Logic Flow
1. **Tracking Initialization**:
   - An anonymous function is immediately invoked to encapsulate the script logic.
   
2. **Tracking Links**:
   - The `trackLink` function adds a click event listener on specified elements. When a click occurs, it stores relevant link data in `sessionStorage`.
   
3. **Retrieving Previous Link**:
   - The `getTrackedLink` function retrieves data from `sessionStorage`. It checks for the freshness of the cached data (within 30 seconds), removes it afterwards, and returns the link path if valid.

4. **Setting Navigation Path**:
   - If a tracked link exists, it sets the navigation path in a global analytics object (`window.LBGAnalytics.datalayer`).

5. **Navigating Elements**:
   - The `trackNavLinks` function iterates over groups of navigation elements based on their defined selectors, processes visibility, and creates structured link path data, using nested functions to capture additional contextual information.

### Dependencies
- The extension relies on the global object `window.LBGAnalytics.datalayer` for analytics integration.
- It also uses the `sessionStorage` API to cache tracking data.

---

## 3. Usage Examples

### Normal Conditions
- When a user clicks on a link in the progressive navigation, the click event is captured, and the relevant link path (including its visibility) is stored in `sessionStorage`. Subsequent interactions update this stored path and send it to the analytics layer.

### Edge Conditions
- If a user clicks on a navigation element after 30 seconds of inactivity, no navigation path will be sent to the analytics layer due to the expiration of cached data.
- In incognito mode, `sessionStorage` may fail, but the script is designed to handle this without any visible disruption to the user.

---

## 4. Known Limitations & Gotchas

- The tracking may fail silently if certain hierarchical elements are not present in the DOM structure, which might affect the retrieval of descriptive text for links.
- Instances of clicking on hidden links or elements may not be tracked correctly due to visibility checks.
- This extension may conflict with other scripts or extensions that manipulate global analytics data or modify the navigation elements dynamically.

---

## 5. Recommendations for Refactoring

- **Defensive Checks**: It might be prudent to implement additional checks before accessing nested properties to avoid potential JavaScript errors, although this current version handles critical points.
- **Code Style Improvements**: Clearer naming conventions for functions and variables can enhance readability. For example, using `getVisibleLinkContent` instead of the inline anonymous function.
- **Modularization**: Breaking up the monolithic `trackNavLinks` function into smaller, single-responsibility functions for each navigation category could enhance maintainability and clarity.

---

## 6. Maintenance & Further Notes

- **Ongoing Maintenance**: Ensure regular reviews of the relevant DOM structure to account for any changes during frontend updates.
- **Ownership**: Assign a specific team or individual responsible for maintaining and updating this extension, ensuring that they are familiar with the functionality and potential areas for improvement.
- **Testing Guidelines**: Conduct thorough testing across various browsers (including incognito modes) to confirm expected behaviour, particularly regarding data storage and retrieval.

--- 

This structured documentation provides a comprehensive overview of the "Nav Tracking 2023" extension, facilitating effective sharing among developers and stakeholders while promoting best practices for future improvements.