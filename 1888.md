# Tealium iQ Extension Documentation: SA360 Combos

## 1. Extension Overview

- **Name**: SA360 combos
- **ID**: 1890
- **Type**: Lookup Table
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
The SA360 combos extension is designed to enhance user targeting capabilities for marketing campaigns by leveraging specific conditions related to user journey names and product groups. This extension addresses limitations imposed by Google, which previously restricted the ability to use multiple user variables (uvars) for targeting.

## 2. Code Explanation

### Key Variables
- `b.WebMessagingBuild`: Holds version information for the web messaging script, which is obtained from the URL query string, cookies, or defaults to a specified version.
- `loadMessaging`: A boolean variable that determines if web messaging should be loaded based on several conditions, such as the hostname and pathname.

### Logic Flow
1. **Override Handling**: The extension checks if the URL contains a query parameter (`webmessagingoverride`) to set the build version for web messaging. If not present, it attempts to retrieve the value from cookies. If neither is found, a default build version is used.
   
2. **Web Messaging Suppression**: It prepares to set a data object for analytics based on the current datalayer cache.

3. **Condition Evaluation**: The variable `loadMessaging` evaluates a combination of conditions, including hostnames and pathnames, which dictate whether to load the web messaging script.

4. **Script Loading**: If `loadMessaging` is `true`, a new script element for web messaging is created and appended to the document head. Additionally, tagging mechanics are updated with the current web messaging build.

### Dependencies
- Utilises global objects such as `window`, `document`, and `LBGAnalytics`.
- Depends on the presence of `LBGAnalytics.santa.Q` for invoking web messaging functionalities.

## 3. Usage Examples

### Normal Scenario
1. A user visits a page related to a personal account (pathname contains `/personal/a/`).
2. If the `webmessagingoverride` is either defined in the query or previously set in cookies, the extension:
   - Loads corresponding web messaging functionality using the specified or default build.
   - Updates tagging mechanics to include the web messaging tag.

### Edge Conditions
- If the query string has `webmessagingoverride=customBuild`, the extension adapts to load the custom script, while ensuring that no other conditions suppress the messaging.
- If the hostname does not meet any specified criteria, the messaging will not be triggered, resulting in a silent page load without the web messaging script being included.

## 4. Known Limitations & Gotchas

- The extension relies heavily on the URL structure and cookie availability. Unexpected changes in the URL format may lead to failures in correctly determining the `WebMessagingBuild`.
- Conflicts may arise if other extensions modify the `document.cookie` for the `webmessagingoverride`, leading to unpredictable behaviours in script loading.
- The logic does not handle URL encoding issues, which may result in erroneous extraction of the `webmessagingoverride` value.

## 5. Recommendations for Refactoring

- **Code Organisation**: Consider modularizing the code to separate concerns (e.g., cookie management, condition evaluation, and script loading). This enhances maintainability and readability.
  
- **Error Handling**: Implement checks before accessing deeply nested properties (e.g., ensure `LBGAnalytics` and its sub-properties are defined before invocation).
  
- **Code Style**: Maintain consistent string manipulation practices, and avoid using magic strings for cookie handling to improve clarity (e.g., change `"webmessagingoverride="` to a constant).

## 6. Maintenance & Further Notes

- **Ownership**: Assign team ownership for regular review and updates, particularly during major releases of related services or libraries.
  
- **Testing**: Establish a suite of automated tests that cover various scenarios, particularly checking the conditions for loading web messaging.
  
- **Documentation Update**: Keep this documentation current alongside code changes, ensuring clarity for new developers joining the project.

---

This structured documentation aims to provide comprehensive insights for effective understanding, modification, and maintenance of the SA360 combos extension within Tealium iQ.