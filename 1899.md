# Tealium iQ Extension Documentation: PCA PBA Lookup

## 1. Extension Overview

- **Name**: PCA PBA Lookup
- **ID**: 1904
- **Type**: Lookup Table
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
The PCA PBA Lookup extension is designed to manage the behaviour of marketing tags associated with current accounts, savings, and investment products. It checks for the existence of duplicate entries in the session storage to prevent sending duplicate data events for specific brands (Lloyds, Halifax). This extension ensures accurate data tracking by flagging duplicate sessions appropriately.

## 2. Code Explanation

### Key Variables
- **FPHDAbortFlg**: A flag to determine if data should be aborted to prevent duplicates.
- **FPHDLog**: Represents session storage for tracking previously processed `PegasusTagName` values.
- **currentFPHD**: The current value of the `PegasusTagName` for the session.

### Logic Flow
1. The function checks whether the `eventType` is "view".
2. If the brand is either "Lloyds" or "Halifax":
   - It resets the `FPHDAbortFlg` to an empty string.
   - If the `FPHDAbortFlg` is not set:
     - The extension checks for the existence of sessionStorage.
     - Either updates the existing `FPHDLog` or creates it if it does not exist, comparing it against the current `PegasusTagName`.
3. If a match is found, it sets `FPHDAbortFlg` to "Y", preventing duplicate processing.
4. If no match is found and particular conditions related to `fphdLog` are true, it updates the session storage and sets `FPHDAbortFlg` to "N".

### Dependencies
- **utag.data**: Utilised for accessing relevant data attributes in Tealium.
- **sessionStorage**: A built-in browser that stores data for the duration of the page session.
- **window.fphdLog**: A global object necessary for conditional checks within the extension.

## 3. Usage Examples

### Normal Scenario
When a user views a page tagged with "Lloyds" and the paged data includes `PegasusTagName` as "Current Accounts":
- The extension checks sessionStorage for previous tags.
- If "Current Accounts" has not been logged in previous sessions, it logs it and sets `FPHDAbortFlg` to "N".

### Edge Condition
Suppose a user views the same page multiple times in the same session:
- If "Current Accounts" is already logged in `FPHDLog`, the extension sets `FPHDAbortFlg` to "Y", preventing any duplicate data events from being sent.

### Non-Matching Conditions
If a user views a page for a brand ('BrandX') not covered by the conditions:
- The extension does not execute the logic, and no flags are set.

## 4. Known Limitations & Gotchas

- **Feature Limitations**: The extension only supports specific brands (Lloyds and Halifax). Other brands will not trigger any abort logic.
- **Session Storage Restrictions**: Data stored in sessionStorage is cleared on page refresh or closing the tab. Hence, the log may not persist across different browsing sessions.
- **Potential Conflicts**: If other extensions manipulate `FPHDAbortFlg` or share the same logic without coordination, conflicting behaviours may arise.
- **Browser Compatibility**: Ensure that the user's browser supports sessionStorage as it is a critical dependency.

## 5. Recommendations for Refactoring

- **Defensive Checks**: Introduce additional checks to validate the existence of `window.fphdLog` and ensure it has expected properties.
- **Code Style**: Keep the structure of nested functions clear, possibly refactoring to named functions instead of anonymous functions for enhanced readability.
- **Modularisation**: Break down the logic into smaller, reusable functions to improve maintainability and testing.
- **Logging Enhancements**: Consider adding debug logs to capture state changes and outcomes for better troubleshooting.

## 6. Maintenance & Further Notes

- **Ownership**: A dedicated team or individual should be assigned to oversee the extension's performance and health, with regular reviews.
- **Testing Guidelines**: Implement a testing framework to simulate real user sessions, ensuring that the duplicate management logic works under various conditions.
- **Updates**: Regularly validate that the logic aligns with changing business requirements or branding changes.

This document is intended for developers and stakeholders involved in the management and implementation of the PCA PBA Lookup extension in Tealium iQ. Proper understanding of this function will enhance its effectiveness and ensure robust data integrity.