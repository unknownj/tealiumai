# Tealium iQ Extension Documentation: Celebrus Load Trigger

## 1. Extension Overview
- **Name**: Celebrus Load Trigger
- **ID**: 100036
- **Type**: Javascript Code
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
The "Celebrus Load Trigger" extension is designed to enable dynamic loading of the Celebrus SDK based on query parameters in the URL and cookies set in the browser. Using specific query parameters, it allows for different environments (development, pre-production, production, or snippet mode) for client-side tag management. The extension ensures that the correct Celebrus tagging scripts are loaded, which are crucial for tracking user interactions.

## 2. Code Explanation

### Key Variables
- **`window.location.search`**: Utilised to read the URL query parameters.
- **`document.cookie`**: Used for setting cookies that determine which environment to operate under.
- **`loadCelebrusWrapper` function**: This function creates a script element for loading the Celebrus SDK.

### Logic Flow
1. The extension checks the URL for specific query parameters (`enableCelebrus=true`, `enableCelebrus=dev`, `enableCelebrus=preprod`, `enableCelebrus=prod`, `enableCelebrus=snippet`).
2. Based on the detected parameters, it sets a corresponding cookie.
3. The `loadCelebrusWrapper` function is invoked if necessary.
4. Depending on the values of the cookies set, different Celebrus scripts are loaded into the `<head>` of the document.
5. Additionally, if the hostname matches a specific condition (e.g., starting with "put0"), the Celebrus SDK is loaded regardless of cookie status.

### Dependencies
- Utilises global objects: `window`, `document`, and `document.cookie`.
- External scripts are conditionally loaded based on cookie values.

## 3. Usage Examples

### Normal Scenarios
1. **Loading Production SDK**: 
   - URL: `https://example.com?enableCelebrus=prod`
   - Cookie set: `enableCelebrus=prod`
   - Causes: The production version of the SDK (`utag.1791.js`) loads.

2. **Loading Development SDK**:
   - URL: `https://example.com?enableCelebrus=dev`
   - Cookie set: `enableCelebrus=dev`
   - Causes: The development version of the SDK (`utag.1789.js`) loads.

### Edge Conditions
1. **Loading Snippet Mode**: 
   - URL: `https://example.com?enableCelebrus=snippet`
   - Cookie set: `enableCelebrus=snippet`
   - Causes: The Celebrus wrapper is executed, loading the snippet SDK.

2. **Missing Cookies**:
   - If no relevant cookies are found and the hostname starts with `put0`, the SDK will still load. For example, `https://put0.example.com` will trigger the wrapper regardless of cookies.

## 4. Known Limitations & Gotchas
- Potential cookie issues: If cookies are blocked in the browser, the extension will not function as intended.
- The loading sequence can be affected by other scripts that manipulate the `<head>` and `<body>` elements, which may delay or prevent the SDK from loading.
- If the hostname criteria are broadened (e.g., uncommenting the `sit0` condition), it may introduce unintended behaviours if not properly managed alongside the existing logic.

## 5. Recommendations for Refactoring
- **Defensive Checks**: While eventType and eventPayload are guaranteed, checks can be introduced to ensure cookies and URL parameters exist.
- **Modularisation**: Break out the conditional checks and script loading into smaller functions for clarity. For example, create a function dedicated to loading scripts based on cookie values.
- **Code Style**: Consistency in naming conventions can be improved. For example, using more descriptive function names or comments to indicate the purpose of each block of code.

## 6. Maintenance & Further Notes
- **Ongoing Maintenance**: Regularly review the extension as environments and dependencies evolve. Verify that the SDK links remain valid and up-to-date.
- **Ownership**: Assign ownership to a team member responsible for monitoring the functionality of this extension, ensuring any updates or changes are documented thoroughly.
- **Testing Guidelines**: Implement a testing strategy for each environment by simulating URL queries and verifying that the correct scripts load. Make sure to test scenarios with and without cookies to confirm expected behaviours. 

This documentation provides a comprehensive understanding of the "Celebrus Load Trigger" extension in Tealium iQ, promoting ease of use and future enhancements.