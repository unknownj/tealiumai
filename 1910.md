# Tealium iQ Extension Documentation

## 1. Extension Overview

- **Name:** Activity Map
- **ID:** 1910
- **Type:** Javascript Code
- **Scope:** 928
- **Execution Frequency:** Active

### Summary
The Activity Map extension dynamically tags parent elements of specified link selectors on a web page with a unique identifier. This identifier combines a sequential index with the cleaned text content of each matching link. The extension also maintains a list of link exclusions to prevent unnecessary actions on specific elements, ensuring that only relevant data is captured. This functionality is beneficial for tracking user interactions and providing insights on user behaviour within the application.

---

## 2. Code Explanation

### Key Variables
- **`activityMap`**: An object from the `u.o` (Tealium object) which serves as a namespace for activity map-related functionalities.
- **`regionIDAttribute`**: A string set to "lpos" that represents the attribute used to store the unique identifier on parent link elements.
- **`applyLinkSelectors`**: An array of CSS selectors targeting links containing "apply." and "apply2." to be processed.
- **`linkExclusions`**: A string containing all the terms that should be excluded from tracking to avoid capturing sensitive or irrelevant user data.

### Logic Flow
1. **Link Selection**: The code selects all anchor (`<a>`) elements on the page based on defined CSS selectors.
2. **Indexing Links**: It iterates through the selected links, and for each link:
   - Cleans the text content by trimming whitespace.
   - Sets a custom attribute (`lpos`) on the parent element with its indexed position and cleaned content.
3. **Exclusions**: The extension compiles a list of terms that should not trigger tracking. It appends any additional exclusions defined in a global object `LBGAnalytics`.

### Global Dependencies
- **`window.LBGAnalytics`**: This global object may contain additional `activityMapExclusions` which are appended to the exclusion list if present.

---

## 3. Usage Examples

### Scenario 1: Normal Processing
Given a webpage with links formatted as follows:

```html
<a href="apply.example.com">Apply Now</a>
<a href="apply2.example.com">Apply Today</a>
```

The extension will process these links, resulting in:
```html
<a href="apply.example.com">Apply Now</a> <!-- Parent element will have attribute lpos="0. Apply Now" -->
<a href="apply2.example.com">Apply Today</a> <!-- Parent element will have attribute lpos="1. Apply Today" -->
```

### Scenario 2: Edge Condition - Excluded Link
If a link text contains "Account Number", it will not be processed:

```html
<a href="apply.example.com">Account Number</a>
```

In this case, no attribute will be added since the link text is on the exclusion list.

---

## 4. Known Limitations & Gotchas

- **Performance**: Processing numerous links could slow down page rendering if there are many anchor tags matching the selectors.
- **Global Dependency**: The extension relies on the `LBGAnalytics` global object, which may not always be defined, potentially leading to skipped exclusions.
- **CSS Selector Limitations**: Overly broad selectors may inadvertently include links that should not be processed or excluded based on content.

---

## 5. Recommendations for Refactoring

- **Defensive Checks**: Introduce validations for the existence of elements before attempting to access their properties or methods to avoid runtime errors.
- **Modularization**: Break the code into functions for selecting links, applying exclusions, and updating attributes for better readability and maintainability.
- **Use of Constants**: Define constants for the exclusion list and selectors to improve code clarity and prevent magic strings.

### Example of Refactored Function (conceptual)
```javascript
function updateLposAttributes(elements) {
  // iteration and attribute setting logic here
}

function compileExclusions() {
  // compile exclusion logic here
}
```

---

## 6. Maintenance & Further Notes

- **Ownership**: Assignment of a dedicated primary maintainer who understands both the business logic and the technical aspects of the extension to ensure accountability.
- **Testing Guidelines**: Conduct regular tests after updates to the DOM or related scripts to confirm behaviour remains as expected. Utilise automated testing frameworks when possible.
- **Documentation Updates**: Encourage team members to update this documentation in line with any changes made to the extension code or functionality.

--- 

This documentation is intended to provide a comprehensive overview and should be treated as a living document, ensuring clarity for developers and stakeholders involved in maintaining the Tealium iQ extensions.