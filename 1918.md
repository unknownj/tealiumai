# Tealium iQ Extension Documentation: Deep Linking - Link Decoration

## 1. Extension Overview

- **Name:** Deep linking - link decoration
- **ID:** 1918
- **Type:** JavaScript Code
- **Scope:** DOM Ready
- **Execution Frequency:** Run Once

### Summary
The "Deep linking - link decoration" extension is designed to enhance inbound link tracking across specific pages by automatically parsing, extracting, and appending UTM parameters and other tracking identifiers from the URL query string to designated anchor (`<a>`) elements. By doing so, it enables more effective marketing analytics and attribution.

---

## 2. Code Explanation

### Key Variables
- **LBGAnalytics:** This is the main global object that provides functionalities for analytics operations.
- **actions:** Contains the list of actions to be performed on the selected elements.
- **selector:** A CSS selector targeting anchor elements that meet specific criteria.

### Logic Flow
1. **Action Trigger:** The extension runs once the DOM is ready.
2. **Selector Matching:** The `selector` identifies links that include specified path fragments, indicating that they require UTM decoration.
3. **Parameter Processing:** Multiple UTM parameters and identifiers are extracted from the `search` variable in the URL:
   - `utm_source`, `utm_medium`, `utm_campaign`, etc.
   These parameters are transformed through a series of operations:
   - Conversion to lowercase.
   - Splitting the string by certain delimiters (`?` and `&`).
   - Splicing to obtain the required segment.
   - Joining the segments back together for the final UTM parameter value.
4. **Settings Application:** The extracted parameters are then appended to the matched anchor elements enabling robust tracking when users click these links.

### Dependencies
- The code relies on the globally available `LBGAnalytics` object. If this object is not present, the extension will fail to execute correctly.

---

## 3. Usage Examples

### Normal Conditions
Given a URL like:
```
https://example.com/loans/app.html?utm_source=SourceName&utm_medium=MediumType
```
On loading the specified page, the extension will automatically parse the URL and attach the following parameters to any matching anchor tags:
- `utm_source` will be processed as `sourceName`
- `utm_medium` will be processed as `mediumType`

Example output:
- Original anchor tag: `<a href="https://example.com/loans/app.html">Click here</a>`
- Decorated anchor tag: `<a href="https://example.com/loans/app.html?utm_source=sourceName&utm_medium=mediumType">Click here</a>`

### Edge Conditions
1. If no UTM parameters are present in the URL, the anchor elements remain unchanged.
2. If the target page is not among those specified (e.g., `/loans/landing/home-ppc-dl.html`), the extension does not run.
3. If the URL structure changes and does not include an anchor link with the expected patterns, it will not execute.

---

## 4. Known Limitations & Gotchas

- **Character Limitations:** If the UTM parameters exceed a certain length, they may truncate in the URL, possibly leading to missing tracking information.
- **Failure on Non-Matching Paths:** The extension will not execute unless the current pathname matches any of the specified criteria in the `criteria` array.
- **Potential Conflicts:** If other scripts manipulate or remove hash (`#`) fragments from URLs before the extension runs, it might affect the extraction of parameters.
- **Link Behaviour:** If an anchor link has pre-existing query parameters, this extension may append additional parameters incorrectly unless handled.

---

## 5. Recommendations for Refactoring

- **Modularisation:** Consider breaking down operations into smaller reusable functions to enhance readability and maintainability.
- **Parameter Validation:** Include validation checks to ensure the extracted parameters are of the expected format before appending to the URL. This would prevent malformed URLs.
- **Logging/Error Handling:** Implement logging mechanisms to capture errors or unexpected behaviour during processing. This would assist in debugging any future issues.
- **CSS Selector Efficiency:** If possible, consider optimising the selector logic to reduce selector complexity, which could improve performance on larger documents.

---

## 6. Maintenance & Further Notes

- **Ownership:** Assign a dedicated team member to oversee periodic reviews of the extension code, ensuring that it remains aligned with business requirements and analytic needs.
- **Testing Guidelines:** Implement a strategy for ongoing testing through staging environments to ensure that modifications do not disrupt functionality. Testing should focus on:
  - Varied URL conditions (with and without UTM parameters).
  - Experimental use cases for integrating with new marketing campaigns.
- **Documentation Updates:** Whenever changes are made to the extension or its dependencies, ensure that the documentation is updated accordingly to reflect the latest functionality and usage instructions.

--- 

By following this structured documentation framework, developers and stakeholders can better understand, maintain, and use the "Deep linking - link decoration" extension effectively.