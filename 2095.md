# Tealium iQ Extension Documentation: Pegasus V2 : GAD Functions

## 1. Extension Overview

- **Name**: Pegasus V2 : GAD Functions
- **ID**: 2095
- **Type**: Advanced Javascript Code
- **Scope**: 1656
- **Execution Frequency**: On every event trigger

### Summary
This extension serves as a bridge for Google Ads Conversion Tracking (GAD). It creates and sends conversion events to Google Ads based on specific triggers and user interactions. This allows marketers to track performance accurately, thus optimising their advertising efforts. 

## 2. Code Explanation

### Key Variables
- **b**: Represents the `eventPayload` object containing contextual information for the occurrence.
- **acc, id**: Parameters in the `gtag_report_conversion` function that refer to the Google Ads account and conversion ID respectively.
- **payload**: An object that contains parameters to be sent to Google Ads, which includes user and transaction-specific details.
- **tagType**: A variable specifically set to 'gad' to filter for Google Ads tags.

### Logic Flow

1. **Initialization**: The extension receives parameters via an Immediately Invoked Function Expression (IIFE) that takes `eventType`, `eventPayload`, and `tagObject`.
   
2. **Processing Conversions**:
   - The `gtag_report_conversion` function prepares the conversion payload and handles any necessary callbacks.
   - It checks user consent using the Google Consent Mode and conditionally removes sensitive identifiers from the payload.
   - Unpacks parameters and checks the eligibility of tags via `runLookups`.

3. **Tag Handling**:
   - The `setTags` function dispatches the conversion based on triggers such as page views, timed events, or user interactions.
   - Efficient unpacking of strings into arrays ensures that each part of the tags and triggers is evaluated correctly.

### Dependencies
- **LBGAnalytics**: This extension relies on a global object called `LBGAnalytics` for event delegation and manipulation.
- **gtag**: The Google Tag Assistant is expected to be available to send conversion events to Google Ads.

## 3. Usage Examples

### Normal Scenario
When the user completes a purchase on the website:
- The `gtag_report_conversion` function is called with the parameters from the payload related to the conversion (e.g. `acc`, `id`).
- The conversion event is sent to Google Ads, populating the necessary details about the purchase.

### Edge Case
If the Google Consent Mode denies tracking identifiers:
- The payload will automatically strip out sensitive data (e.g. `order_id`, `application_id`).
- The conversion still proceeds, albeit with less granular data.

## 4. Known Limitations & Gotchas
- If `trigger` types are malformed or unexpected, the extension may fail to execute as intended.
- Conflicts can arise with other extensions that modify or override the `gtag` function.
- The event listeners may not function as intended if the element specified in the trigger does not exist or is created dynamically post-execution.

## 5. Recommendations for Refactoring
- **Error Handling**: Introduce more robust error-catching around external library invocations (e.g. surrounding calls to `gtag_report_conversion`).
- **Code Modularity**: Consider breaking down larger functions into smaller, single-responsibility functions for clarity. 
- **Variable Naming**: Ensure that variable names clearly reflect their purpose, thus improving readability.
- **Commenting**: Increase inline comments to enhance understanding, especially in complex sections.

## 6. Maintenance & Further Notes
- **Ownership**: Assign a primary team member responsible for monitoring and updating this extension based on changes in Google Ads or tracking requirements.
- **Testing Guidelines**: Implement checks post-deployment to ensure that conversion events are being successfully captured and reported within Google Ads.
- Periodically review this extension to ensure compliance with updated privacy regulations and user consent management strategies.

--- 

This documentation serves as a thorough guide for developers and stakeholders, ensuring they have a clear understanding of the functionality, limitations, and maintenance recommendations for the Tealium iQ extension implemented for Google Ads conversion tracking.