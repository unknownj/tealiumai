# Documentation for Tealium iQ Extension: Pegasus V2 : GDC functions

## 1. Extension Overview
- **Name**: Pegasus V2 : GDC functions
- **ID**: 2096
- **Type**: Advanced Javascript Code
- **Scope**: 1655
- **Execution Frequency**: On every relevant trigger event

### Summary
This Tealium iQ extension is designed to manage GDC (Google Data Collection) functions, specifically for reporting conversions related to purchase transactions. It differentiates between various conversion types and constructs payloads to send to Google Analytics. The extension focuses on tracking relevant customer information while ensuring compliance with privacy standards, particularly removing personally identifiable information (PII) from the payload before transmission.

---

## 2. Code Explanation

### Key Variables
- **DC_src**: Source of the data collection.
- **DC_type**: Type of conversion.
- **DC_cat**: Category of the conversion.
- **b**: A placeholder for the data layer object containing various contextual variables.
  
### Logic Flow
1. **Functionality Overview**:
   - The main function is `gfl_report_conversion`, which constructs payload data based on the current application state and sends it to Google Analytics as an event.
   - The extension processes multiple tag lookups using the `lookupTable` and calls `runLookups`.

2. **Data Processing**:
   - It checks the application state (`Fulfilled` or otherwise) to determine the conversion type and constructs the payload accordingly.
   - The payload consists of various parameters, including order IDs, currency, and customer journey information.
   - PII is stripped from the payload where applicable, ensuring compliance with privacy standards.

3. **Event Handling**:
   - The extension sets event listeners or timeouts based on the provided triggers to manage when the conversion reporting should occur.

### Dependencies
- **LBGAnalytics**: A JavaScript library for managing analytics and event handling.
- **gtag**: Google Tag Manager's global site tag function used for sending analytics data.

---

## 3. Usage Examples

### Sample Scenarios

1. **Normal Flow**:
   - A customer completes a purchase. The function checks if the application state is Fulfilled, it then constructs a payload with the purchase details and sends it to Google Analytics.
  
2. **Handling a Conversion with No Purchase**:
   - In situations where the application state is not Fulfilled, the system defaults to a unique conversion with preset values. For instance, the order total may be set to zero and the order ID to a constant value.

3. **Time-Based Trigger**:
   - If a timed trigger is specified, the extension will wait for a defined duration before reporting the conversion, leveraging JavaScript's `setTimeout`.

4. **Event-Based Trigger**:
   - The extension can attach event listeners to specified elements. For example, if a button click is specified, it will only report a conversion if the button clicked matches a specific condition (e.g., button text).

---

## 4. Known Limitations & Gotchas

- **Privacy Compliance**: If a user's consent is not validated (from the cookie), identifiers in the payload will be removed, potentially leading to less informative analytics data.
- **Error Handling**: The implementation does minimal error handling; exceptions during the execution of `gfl_report_conversion` may not be logged systematically.
- **Dependency on dom-ready**: Ensure that the LBGAnalytics library is loaded before this extension runs, as it relies on certain functions to operate correctly.
- **Complex Trigger Handling**: Depending on the application, complex triggers could lead to unexpected behavior if not properly defined.

---

## 5. Recommendations for Refactoring

- **Modularisation**: Consider breaking large functions into smaller, reusable functions to improve readability and testability.
- **Defensive Checks**: Although we are not focusing here, additional checks might be implemented for the payload to ensure all needed properties exist before the main logic runs.
- **Logging**: Introduce a more robust logging mechanism to capture errors and exceptions to ease troubleshooting.
- **Code Comments**: Increasing the number of inline comments to explain non-obvious parts of the code could benefit future developers unfamiliar with the logic.

---

## 6. Maintenance & Further Notes

### Ongoing Maintenance
- **Ownership**: Designate a team member for the ongoing management of this extension, including updates based on evolving business needs or changes in regulations.
- **Testing Guidelines**:
  - Regularly test the extension on staging and production environments to ensure it behaves as expected across all scenarios.
  - Rigorously validate that privacy compliance remains intact during updates and modifications.

### Documentation Updates
- Keep documentation up-to-date with any changes in the extension functionality or dependencies. Where possible, introduce versioning for each significant update.

--- 

This structured documentation should serve as a comprehensive guide for developers and stakeholders engaged in working with the Pegasus V2 : GDC functions extension in Tealium iQ.