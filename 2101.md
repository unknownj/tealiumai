# Tealium iQ Extension Documentation: CanonicalURL fix redux

## 1. Extension Overview

- **Name**: CanonicalURL fix redux
- **ID**: 2101
- **Type**: Advanced Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
The **CanonicalURL fix redux** extension aims to set the `CanonicalURL` variable consistently across different contexts by constructing a complete URL from the canonical domain and path provided in the data layer. This is essential for SEO purposes, ensuring proper attribution of web pages in search engine results, and preventing duplicate content issues.

## 2. Code Explanation

### Key Variables
- **a**: Represents the event type passed to the function (e.g., page view, click).
- **b**: Represents the event payload, an object containing relevant data.
- **c**: An array that combines `CanonicalDomainProd` and `CanonicalPath` to form the canonical URL.

### Logic Flow
1. The function is invoked with `eventType` and `eventPayload`.
2. It extracts `CanonicalDomainProd` and `CanonicalPath` from the event payload `b`.
3. These two components are concatenated into a single string and assigned to:
   - `b['CanonicalURL']`
   - `utag.data["CanonicalURL"]`
   - `LBGAnalytics.datalayer.set("CanonicalURL", c.join(''), true)`
   - `clova3.datalayer.set("CanonicalURL", c.join(''), true)`

The use of `join('')` effectively combines the components without any additional separator.

### Dependencies
The extension depends on the following global objects:
- `utag`: Used for interacting with the Tealium data layer.
- `LBGAnalytics` and `clova3`: Custom analytics layers, expected to have a `datalayer` object that allows setting new data.

## 3. Usage Examples

### Scenario A: Normal Operation
- **Input**:
  - `eventType`: "page_view"
  - `eventPayload`: 
    ```json
    {
      "CanonicalDomainProd": "https://www.example.com",
      "CanonicalPath": "/path/to/page"
    }
    ```
- **Process**:
  - The extension constructs the `CanonicalURL` as `https://www.example.com/path/to/page`.
- **Output**:
  - Global variables:
    - `b['CanonicalURL']`: "https://www.example.com/path/to/page"
    - `utag.data["CanonicalURL"]`: "https://www.example.com/path/to/page"
- Data layers updated:
  - `LBGAnalytics.datalayer` and `clova3.datalayer` have `CanonicalURL` set to the same value.

### Scenario B: Missing Canonical URL Components
- **Input**:
  - `eventType`: "page_view"
  - `eventPayload`: 
    ```json
    {
      "CanonicalDomainProd": "",
      "CanonicalPath": ""
    }
    ```
- **Process**:
  - The extension constructs the `CanonicalURL` which will result in an empty string.
- **Output**:
  - Global variables:
    - `b['CanonicalURL']`: ""
    - `utag.data["CanonicalURL"]`: ""
- Data layers updated:
  - `LBGAnalytics.datalayer` and `clova3.datalayer` will also have empty values set for `CanonicalURL`.

## 4. Known Limitations & Gotchas

- **Missing Data**: If either `CanonicalDomainProd` or `CanonicalPath` is missing or empty, the constructed `CanonicalURL` will be inaccurate (often resulting in an empty string).
- **Global State**: The extension overwrites existing values in the global data layer. Care should be taken to avoid unexpected results due to conflicting values from other extensions.
- **Order of Execution**: Ensure this extension runs before any other extensions or scripts that depend on the `CanonicalURL`.

## 5. Recommendations for Refactoring

- **Defensive Checks**: While the availability of `eventType` and `eventPayload` is guaranteed, consider adding checks to ensure that the values of `CanonicalDomainProd` and `CanonicalPath` exist and are valid URLs.
- **Code Style**: Refactor to improve readability, such as by breaking down the URL creation into a separate function (if modularization was permitted).
- **Error Logging**: Implement logging mechanisms to capture scenarios where the canonical components are missing, which can help with debugging.

## 6. Maintenance & Further Notes

- **Ownership**: Establish a clear ownership model to maintain the extension, ensuring that someone is responsible for updates and monitoring.
- **Testing Guidelines**: Regularly test the extension with various payloads to ensure both normal and edge conditions are handled correctly.
- **Version Control**: Maintain versioning for the extension to track changes and updates over time, facilitating easier rollbacks if necessary.

---

This documentation should serve as a comprehensive resource for developers working with the CanonicalURL fix redux extension, ensuring clarity and ease of use.