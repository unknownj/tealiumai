# Tealium iQ Extension Documentation: MCMA v2 - Mortgage Calc and AIP

## 1. Extension Overview
- **Name**: MCMA v2 - Mortgage Calc and AIP
- **ID**: 2108
- **Type**: Advanced Javascript Code
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
This extension captures and processes data related to mass affluent traffic on a mortgage calculator. Its main purpose is to evaluate users' financial status—specifically focusing on their income and savings—to assign them to specific value segments, which can then be tracked and used for analytics and marketing purposes. The resulting data helps tailor the user experience and inform future marketing strategies.

---

## 2. Code Explanation

### Key Variables
- **ValueSeg**: A string variable to hold the final value segment classification (e.g., '1', '2', '3', '4', or 'NA').
- **applicants**: A count of how many applicants are identified (1 or 2).
- **income1**, **income2**: Parsed incomes from user inputs.
- **highestIncome**: The larger of `income1` and `income2`.
- **savings**: Parsed value of the user's savings.

### Logic Flow
1. **Initialization**: The main function checks if the page has finished loading, and it initializes the `MCMA` object in `utag.data` if it does not already exist.
2. **Event Listener**: An event listener is added to capture changes in form fields specified by `fieldSelectors` for incomes and savings.
3. **Validation and Data Capture**: For each change in the form, the code validates entries:
   - It ensures that valid numbers are captured for `income1`, `income2`, and `savings`.
   - It applies eligibility expressions to conditionally modify the captured data.
4. **Segment Assignment**: Based on parsed income and savings data:
   - Users are assigned to specific segments based on predefined income and savings thresholds.
5. **Data Output**: The determined `ValueSeg` is pushed to `utag.data` and a third-party analytics system if conditions are met.

### Dependencies
- **window.performance**: Used to check if the page has fully loaded.
- **utag.data**: Tealium's global object storing the data layer.
- **LBGAnalytics**: A library used for logging analytics information.

---

## 3. Usage Examples

### Normal Scenario
1. A user enters their income for two applicants in the respective fields.
2. The extension captures their entries, validating them and calculating a total income.
3. If the total income meets specific thresholds, the user is assigned a corresponding value segment:
   - Example: If `income1 = 35000` and `income2 = 45000`, the user would fall into segment '2' based on combined income rules.

### Edge Conditions
1. **Invalid Income**: If a user enters a non-numeric value (e.g., "twenty thousand"), validation fails, and no segment is assigned.
2. **Zero Savings**: If the savings are zero with a valid income, the user might still be classified into segment '1'.
3. **Improper Field Selections**: If fields expected by the `fieldSelectors` do not exist in the form, the extension will not capture any data for those fields.

---

## 4. Known Limitations & Gotchas
- **Field Visibility**: The extension assumes that all specified `fieldSelectors` will be present at the time the event listener is triggered. If fields are dynamically generated or loaded later, the extension may fail to capture necessary data.
- **Browser Compatibility**: Ensure that the extension is tested across browsers to confirm that event listeners work correctly. Older browsers may not support all event listener features.
- **No Error Handling**: The extension silently catches errors, meaning issues may go unnoticed during execution. This could make debugging difficult.

---

## 5. Recommendations for Refactoring
- **Defensive Coding**: Consider additional checks to ensure that `utag.data.MCMA` is accessible and that `document` and `event` objects are present before using them.
- **Code Style**: Maintain consistent formatting for ease of readability, particularly with indentation and spacing.
- **Modularization**: Consider splitting complex functions into smaller, self-contained functions. This would improve maintainability and readability. For example, the data validation process could be extracted into separate functions for each income type and savings.
- **Logging Improvements**: Enhance logging to capture not only segmentation results but also any errors or unexpected behaviours during execution.

---

## 6. Maintenance & Further Notes
- **Ownership**: Assign a dedicated team responsible for monitoring the performance and functionality of the extension. Regular updates should be scheduled to review its effectiveness in capturing user data.
- **Testing Guidelines**: Establish a robust testing strategy that includes unit tests for individual functions and integration tests for the entire extension to ensure data is properly captured and segment classifications are accurate.
- **Documentation Updates**: As changes to the extension occur, ensure that documentation is kept up-to-date, reflecting any new features, variables, or logic flows introduced.

This documentation serves as a comprehensive guide for understanding and maintaining the `MCMA v2 - Mortgage Calc and AIP` Tealium iQ extension and is intended for use by developers and stakeholders within the organisation.