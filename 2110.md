# Tealium iQ Extension Documentation: CUET: Clarity Suppression and Cookie Defaults

## 1. Extension Overview

- **Name**: CUET: Clarity suppression and cookie defaults
- **ID**: 2110
- **Type**: Advanced JavaScript Code
- **Scope**: 1611
- **Execution Frequency**: Active

### Summary
This extension is designed to monitor the DOM for the presence of Clarity scripts when they are added to the page. Upon detection of such scripts, the extension will remove them and halt any active Clarity sessions to ensure that user tracking is suppressed. This is particularly useful for compliance with privacy regulations or user consent frameworks, allowing for the default prevention of unwanted tracking by Clarity.

## 2. Code Explanation

The main function of the extension is encased within an immediately invoked function expression (IIFE) designed to execute in a controlled context. Here's a breakdown of the key components:

### Key Variables

- **observer**: An instance of `MutationObserver` that monitors the DOM for newly added nodes.

### Logic Flow

1. The extension instantiates a `MutationObserver` to watch for changes in the document's structure.
2. When new nodes are added to the DOM (`addedNodes`), the function will check each node:
   - If the `addedNode` is an HTML element (`nodeType === 1`) and matches the selector for Clarity scripts (`addedNode.matches('script')`).
   - If the script's source contains the term "clarity" (`addedNode.src.match(/.*clarity.*/)`).
3. Upon finding a Clarity script:
   - The script is removed (`addedNode.remove()`).
   - The current Clarity session is halted using `window.clarity('stop')`.
   - Consent is flagged as false with `window.clarity('consent', false)`.
   - The Clarity queue is cleared (`window.clarity.q = []`).

### Dependencies
- **Global Objects**: The extension depends on the global `window` object.
- **MutationObserver**: This API is essential for observing changes in the DOM.

## 3. Usage Examples

### Normal Operation
1. The page loads, and a Clarity script tag is dynamically injected into the `<head>` or `<body>`.
2. The `MutationObserver` detects the new script, removes it, and stops Clarity tracking.
   
### Edge Cases
1. If multiple Clarity scripts are added consecutively:
   - The extension will remove each occurrence as they are detected.
2. If Clarity is already running when this extension is loaded:
   - The extension will stop any existing sessions and clear the queue.

## 4. Known Limitations & Gotchas

- **Performance Concerns**: Continuous observation of the entire DOM subtree may lead to performance drawbacks on pages with frequent DOM updates.
- **Compatibility**: Ensure that the necessary global `clarity` object is available for the commands to execute correctly. If it is not, calls to `window.clarity()` will fail silently.
- **External Script Conflicts**: If other scripts modify or replace the Clarity functionality or create custom Clarity instances, this could lead to unexpected outcomes, as this extension only works with the expected global `clarity` object.

## 5. Recommendations for Refactoring

### Suggested Improvements
- **Defensive Checks**: Include checks to ensure that `window.clarity` is defined before attempting to call its methods, to prevent potential runtime errors.
- **Code Readability**: Consider extracting the logic that processes `addedNodes` into a separate function. This can improve readability and maintainability.
- **Commenting**: Enhance inline comments to clarify logic and intent for future developers.
  
_Example of a refactored check before calling Clarity methods:_

```javascript
if (typeof window.clarity === 'function') {
    window.clarity('stop');
    window.clarity('consent', false);
}
```

## 6. Maintenance & Further Notes

### Ongoing Maintenance
- Regularly test the extension against browser updates and changes to the Clarity library to ensure compatibility and functionality.
- Monitor performance implications if the conditions for mutation observation evolve (e.g., new scripts being added).

### Ownership
- Assign a dedicated maintainer for the extension responsible for addressing issues and implementing changes when necessary.

### Testing Guidelines
- Conduct thorough testing in various scenarios, including pages with heavy DOM manipulation and configurations that include multiple tracking scripts.

---

This documentation serves as a comprehensive guide for developers working with the CUET: Clarity suppression and cookie defaults extension. For further inquiries or enhancements, please reach out to the extension maintainer.