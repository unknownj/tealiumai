# Tealium iQ Extension Documentation

## 1. Extension Overview

- **Name**: Appsflyer : SmartScript
- **ID**: 2115
- **Type**: Advanced JavaScript Code
- **Scope**: DOM Ready
- **Execution Frequency**: Run Once

### Summary
This extension facilitates the generation of one-link URLs and direct click URLs for Appsflyer, improving the tracking capabilities of web traffic originating from advertisements. It processes various URL parameters, ensuring that necessary tracking information is passed to the Appsflyer systems, and handles URL validation and logging to local storage for subsequent tracking use cases.

## 2. Code Explanation

### Key Variables
- **AF_URL_SCHEME**: Regex pattern that defines the scheme for valid Appsflyer URLs.
- **VALID_AF_URL_PARTS_LENGTH**: A constant set to 5, which denotes the expected number of parts in a valid Appsflyer URL.
- **GCLID_EXCLUDE_PARAMS_KEYS** and **AF_CUSTOM_EXCLUDE_PARAMS_KEYS**: Arrays containing keys to be excluded from URL parameters when generating click URLs.
- **LOCAL_STORAGE_VALUES**: An object that holds key names for values stored in local storage.

### Logic Flow
1. **Validation of Domains**: The extension first checks if the `udo.CanonicalDomainProd` variable matches any of the predefined domains before executing further processing.
2. **URL Processing**:
   - **URL Parameters**: Extracts URL parameters using `getQueryParamsAndSaveToLocalStorage` and stores them in local storage for further use.
   - **URL Validation**: Uses a function to validate if the current URL is correctly formatted according to Appsflyer standards.
   - **Tracking Parameter Generation**: Constructs the final tracking URL by extracting necessary parameters, handling Google Click IDs, and logging relevant data.
3. **Local Storage Management**: Functions for saving and removing expired items from local storage to keep the records relevant.

### Dependencies
- The extension relies on JavaScript's `window`, `document`, and `localStorage`, and does not depend on any external libraries beyond what Tealium provides. 

## 3. Usage Examples

### Example 1: Generate OneLink URL
When a user lands on any of the specified domains, the extension checks if the current URL is valid and generates a tracking URL, incorporating Google Click ID if present. This URL can be sent to tracking or engagement systems for analysis. 

```javascript
var oneLinkURL = window.AF_SMART_SCRIPT.generateOneLinkURL({
    oneLinkURL: "https://example.com/link",
    afParameters: { mediaSource: 'source', campaign: 'campaign_id' },
    referrerSkipList: ['referrer1', 'referrer2'],
    urlSkipList: ['skip1', 'skip2']
});
```

### Example 2: Handle Edge Cases
If a non-supported domain or an improperly formatted URL is encountered, the extension gracefully logs an error and avoids executing potentially harmful code:

```javascript
if (!isOneLinkURLValid(invalidURL)) {
    console.log("Invalid URL, unable to generate tracking link.");
}
```

## 4. Known Limitations & Gotchas

- **Domain Checking**: The extension only supports specific domains. Any attempt to use it on unlisted domains will result in no action being taken.
- **URL Length**: If generated URLs exceed a certain length due to too many parameters, certain data may be truncated, leading to potential loss of tracking data.
- **Performance Concerns**: While the extension performs adequately under normal conditions, heavy reliance on local storage for larger datasets may slow down the performance.
- **Conflict with Other Extensions**: Care should be taken if other Tealium extensions also manipulate the same `localStorage` values or global functions.

## 5. Recommendations for Refactoring

- **Modularisation**: Break down the monolithic function into smaller, self-contained modules to improve readability and maintainability. Functions such as URL validation, parameter extraction, and local storage management can be decoupled.
  
- **Error Handling**: Introduce more comprehensive error handling, using logging to capture unexpected behaviour and potential failures.
  
- **Code Style Consistency**: Adhere to a consistent code style by using naming conventions and indentation to enhance readability.

- **Defensive Checks**: Although defensive coding is not applicable for `eventType` and `eventPayload`, similar checks can be performed for other critical variables to ensure robustness.

## 6. Maintenance & Further Notes

- **Ongoing Maintenance**: Regularly review the extension for compatibility with new versions of Tealium and Appsflyer. Ensure that any updates to the API or requirements are reflected in the code.
  
- **Ownership**: Assign a dedicated owner for this extension who will be responsible for monitoring its use and updating the documentation as necessary.
  
- **Testing Guidelines**: Implement unit tests for each modular function. Ensure regression testing is conducted upon updates to establish continued functionality.

This documentation should serve as a reliable resource for developers working with the Tealium iQ extension for Appsflyer. Please refer back to this guide for clarity on functionality, expected behaviours, and best practices moving forward.