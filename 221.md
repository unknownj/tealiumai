# Tealium iQ Extension Documentation: Detect Brand and Environment

## 1. Extension Overview

- **Name**: Detect brand and environment
- **ID**: 221
- **Type**: JavaScript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary

This extension aims to detect the brand and environment of the test site based on the domain and its associated substrings. It is utilised to route data correctly for analytics and tagging purposes. By identifying the brand (Lloyds, Halifax, Bank of Scotland, etc.) and operational environment (online, apply, secure, or private), the extension ensures that the necessary metadata is available for further processing and analytics.

---

## 2. Code Explanation

### Key Variables

- **utag.data['dom.domain']**: Represents the current domain derived from the page.
- **utag.data.current_brand**: Holds the detected brand name.
- **utag.data.current_environment**: Holds the detected environment status.
- **utag.data.is_mobile**: A flag for determining if the user is on a mobile device.
- **utag.data.is_tablet**: A flag for determining if the user is on a tablet.

### Logic Flow

1. **Brand Detection**:
   - The script first checks if the domain is one of the specified test sites (`digital.lloydsbank`, `intranet.test`).
   - If true, it inspects the domain for specific substrings indicative of various brands. It assigns the corresponding value to `utag.data.current_brand`.

2. **Environment Detection**:
   - It assesses the domain for indicators of environment and assigns the respective value to `utag.data.current_environment`. It defaults to 'www' if no specific conditions are met.

3. **Fallback Mechanism**:
   - If `current_brand` is undefined, the code attempts to fetch the brand and environment values from the `window.clova3.datalayer`, ensuring dynamic data is captured when available.

4. **Additional Overrides**:
   - Further checks are made to ensure the domain doesnâ€™t conflict with specified brands and environments based on additional path and domain checks.

### Dependencies

- **Global Objects**:
  - `utag`: Tealium's Universal Tag object for managing data layers.
  - `window.clova3`: A global object assumed to exist, used for fetching data from a potential backend data layer.

---

## 3. Usage Examples

### Normal Behaviour

- On loading the site at `www.halifax.co.uk`, the extension would detect:
  - `utag.data.current_brand` as "halifax".
  - `utag.data.current_environment` as "www".

### Edge Conditions

- If the domain is `www.scottishwidowsyourfutureself.co.uk`, the brand will be explicitly set to "scottishwidows" regardless of other checks.

- If no conditions are met for either brand or environment, the extension defaults to "lloyds" for brand and "www" for environment.

---

## 4. Known Limitations & Gotchas

- The extension is hard-coded to specific domain names and substrings. Any changes to the domain naming conventions may require updates.
  
- The reliance on `window.clova3` implies that if this object is not available, the brand/environment detection will be limited to predefined rules.
  
- If domains change or are added/removed without updating the code, this could lead to incorrect data being tagged.

- There is a potential conflict when multiple Tealium extensions attempt to modify `utag.data` simultaneously, which may lead to unforeseen data corruption or overwrites.

---

## 5. Recommendations for Refactoring

- **Modularisation**: Break down the code into smaller functions to improve maintainability and readability (e.g., separate functions for brand and environment detection).

- **Error Handling**: Implement more robust error handling, especially for attempts to access properties on potentially undefined objects (e.g., `window.clova3`).

- **Documentation**: Add inline comments within the code to aid future developers in understanding the purpose of specific checks and logic paths.

- **Defensive Checks**: Check for existence before accessing properties of global objects. While `eventType` and `eventPayload` are guaranteed, consider ensuring `utag.data` is defined before proceeding.

- **Consistent Naming**: Maintain a consistent naming convention for the keys in `utag.data`, ensuring clarity and preventing conflicts.

---

## 6. Maintenance & Further Notes

- **Ownership**: Assign a dedicated owner or team responsible for the ongoing updates to the extension based on business changes or new requirements.

- **Testing Guidelines**: Regular testing is recommended, particularly after significant updates to branding or domain changes, to verify that the extension captures the correct data.

- **Documentation Updates**: Ensure that any changes to the logic or domain checks are promptly reflected in this documentation.

---

This structured documentation provides an overview of the extension's functionality, operational details, and best practices for maintenance, making it an essential reference for developers and stakeholders involved in the project.