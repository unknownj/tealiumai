# Tealium iQ Extension Documentation: Pegasus V2 - MAU Functions

## 1. Extension Overview

- **Name**: Pegasus V2 : MAU functions
- **ID**: 2257
- **Type**: Advanced Javascript Code
- **Scope**: 1611
- **Execution Frequency**: Active

**Summary**:  
This extension is designed to facilitate Microsoft Advertising (MAU) functionalities by processing various events, particularly focusing on conversions and item views. It captures critical event data and formats it to send to Microsoft Advertising using the `uetq` global variable. The extension supports dynamic triggers based on user interactions and is aimed at enhancing marketing analytics.

---

## 2. Code Explanation

### Key Variables

- **`ev`**: Represents the event type that can vary, such as 'purchase' or 'view_item'.
- **`ord`**: Used to store the order ID or a default value.
- **`value`**: Represents the monetary value associated with a purchase or event.
- **`label`**: A string combining pieces of information for the event (e.g., URL, product name).

### Logic Flow

1. **Event Handling**: The function `mau_event(ev)` handles different event types and constructs an appropriate payload for Microsoft Advertising.
2. **String Manipulation**:
    - `unpackStr(TagValues, delim)`: Splits a delimited string into an array.
    - `createElig(arr)`: Converts an eligibility mapping array to an object to determine if a tag should fire.
3. **Tag Finding**: 
    - `findTag(currentTag)`: Checks if the current tag matches the expected 'mau' tag type.
4. **Trigger Types**:
    - The `setTags(ev, trigger)` function determines how to execute the tag based on the event type, such as executing immediately, setting up time delays, or triggering on specific user actions.
5. **Running Lookups**: 
    - The lookup table is iterated through using `runLookups(currentArr)` to determine if any relevant tags should activate based on eligibility rules.

### Dependencies

- **Global Objects**:
  - `window.uetq`: Global variable used to send events to Microsoft Advertising.
  - `LBGAnalytics`: A JQuery-like object is used for event binding.

---

## 3. Usage Examples

### Normal Condition

- **Purchase Event**:
  When a purchase event occurs, the extension captures the order ID and revenue values using `mau_event('purchase')`.
  
### Edge Condition

- **View Item Event**:
  When a product is viewed but not purchased, the event can still be captured using `mau_event('view_item')`, where the value is set to 0.

### Example Scenario

```javascript
// Simulated Event Payload for Purchase
let eventPayload = {
    paid_order_id: '12345',
    JourneyAmount: '100.00',
    JourneyName: 'Winter Sale',
    JourneyProduct: 'Winter Boots',
    PegasusTagName: 'E-commerce Purchase'
};

// Triggering the event
mau_event('purchase', eventPayload);
```

- The output would be logged to the console and sent to Microsoft Advertising, containing relevant details for the conversion event.

---

## 4. Known Limitations & Gotchas

- **Missing Data Handling**: The extension assumes that certain fields (e.g., `JourneyAmount`, `JourneyName`) are always present. Cases where these values are absent may lead to undefined behavior.
- **Concurrency**: Rapid triggering of the same event might lead to multiple tag executions, resulting in non-unique transaction IDs.
- **Performance**: Extensive use of `setTimeout` can lead to performance impacts if many tags are queued particularly on high-traffic pages.

---

## 5. Recommendations for Refactoring

- **Defensive Checks**: While the availability of `eventType` and `eventPayload` is guaranteed, consider validating the structure of `eventPayload` before use to avoid runtime errors.
- **Code Style**: Improve readability by adopting consistent variable naming conventions and including comments for each block of logic.
- **Modularisation**: Extract large functions into smaller ones focused on specific tasks, such as unpacking logic and eligibility evaluation, to improve maintainability.

---

## 6. Maintenance & Further Notes

- **Ongoing Maintenance**: Regularly review the extension post-deployment to ensure continued compatibility with evolving website structures and third-party integrations.
- **Ownership**: Designate a team member responsible for monitoring the performance and accuracy of data sent to Microsoft Advertising.
- **Testing Guidelines**: Always perform regression testing when making updates to ensure existing functionalities remain intact. Testing environments should be used to simulate events before deploying changes to production.

--- 

This documentation is intended to be a thorough resource to aid future developers and stakeholders in understanding, using, and maintaining the Pegasus V2 - MAU functions extension within the Tealium iQ platform.