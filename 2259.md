# Tealium iQ Extension Documentation: Onelink Appstore Redirect

## 1. Extension Overview

- **Name**: Onelink Appstore Redirect
- **ID**: 100036
- **Type**: Javascript Code
- **Scope**: After Tag Extensions
- **Execution Frequency**: Run Once

### Summary
This extension is designed to redirect users to the appropriate app store (Google Play or Apple App Store) based on the brand and the device being used. It processes user agent information and URL parameters to determine whether a user should be redirected and updates the relevant links on the page to ensure users are directed to their corresponding app store versions.

---

## 2. Code Explanation

### Key Variables
- **appStoreRedirect**: An object that encapsulates methods and properties related to the app store redirection.
- **onelinkURLs**: A mapping of brands (e.g., "Lloyds", "Halifax") to their respective OneLink URLs.
- **AF_SMART_SCRIPT_RESULT**: A variable that stores the result of the OneLink URL generation, used for redirection.

### Logic Flow
1. **Device Detection**: The method `getBrand` checks the device type using the `navigator.userAgent` string or URL parameters to identify mobile users.
2. **URL Generation**: The main logic resides in the `onelink` method, which:
   - Generates a OneLink URL based on the brand.
   - Updates HTML elements with app store links.
   - Redirects users if they are on the download page and using a mobile device (excluding specific business pages).
3. **Invocation**: The script checks the current URL to determine which brand's OneLink to initiate, thereby executing the `onelink` method for appropriate brands.

### Dependencies
- **window.AF_SMART_SCRIPT**: This global object must exist and have a method called `generateOneLinkURL` that is used to create the appropriate app store link.

---

## 3. Usage Examples

### Normal Conditions
- A user visits `lloydsbank.com/app.html` on an iPhone:
  - The script identifies the brand as "Lloyds".
  - The script generates the corresponding OneLink URL for Lloyds.
  - Links for app store badges are updated.
  - The user is redirected to the correct app store download page.

### Edge Conditions
- A user visits a business banking page such as `lloydsbank.com/business/banking-online/...`:
  - The script identifies the brand as "LloydsBusiness".
  - No redirection occurs since it's a business page.
  - The app store badge links are updated, but clicking does not trigger a redirect.

---

## 4. Known Limitations & Gotchas

- **Device Detection Limitations**: The current method primarily checks for Android and iOS in a limited way. Some devices might not be detected correctly due to variations in user agent strings.
- **Specific Scenarios**: Redirection is only performed if the brand is not "LloydsBusiness". This could lead to confusion in user experience for business users.
- **Global Dependencies**: If the `window.AF_SMART_SCRIPT` object does not exist or is misconfigured, the entire extension will fail to execute the URL generation process.

---

## 5. Recommendations for Refactoring

- **Modularization**: Consider breaking out the `onelink` method logic into smaller utilities for URL generation and element updating. This will enhance code readability and maintainability.
- **Defensive Checks**: While event objects are guaranteed, include checks around DOM manipulations to ensure the elements exist before attempting to update them, thus preventing runtime errors.
- **Use of Constants**: Define constants for repeated strings (e.g., the URL pattern or data attributes) to avoid hardcoding them multiple times, enhancing maintainability.
- **Documentation**: Comment on key sections of the code to clarify intent and functionality for future developers.

---

## 6. Maintenance & Further Notes

- **Ownership**: The team responsible for this extension should ensure regular reviews in line with any updates to the app store link structures or brand requirements.
- **Testing Guidelines**: Every time the extension is modified, thorough testing should be conducted across multiple devices and browsers to ensure that redirections are functioning as intended.
- **Monitoring**: Keep an eye on analytics for click-through rates on the app store buttons to identify any potential issues with the link modifications.

This documentation provides a comprehensive overview of the Onelink Appstore Redirect extension, ensuring that developers and stakeholders have the necessary information for understanding, maintaining, and potentially extending the functionality of the code.