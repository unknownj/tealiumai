# Tealium iQ Extension Documentation

## 1. Extension Overview
- **Name**: Appstore redirect - remove internal UTMs if paid
- **ID**: 2263
- **Type**: Advanced JavaScript Code
- **Scope**: DOM Ready
- **Execution Frequency**: Run Once

### Summary
This Tealium iQ extension checks if the current page is the "current-accounts.html" page. If it is, the extension searches for any internal UTM parameters in the URL and removes them from links that point to the app page. This is particularly useful in ensuring that the app link does not include tracking parameters from previous marketing efforts, providing a clean URL for users.

---

## 2. Code Explanation

### Key Variables
- `AppNodes`: A NodeList of anchor (`<a>`) elements whose `href` attribute contains the string '/app.html'.

### Logic Flow
1. The code checks if the current page path is "/current-accounts.html" using `window.location.pathname`.
2. It retrieves any value associated with the `utm_source` query parameter from the URL.
3. If `utm_source` exists, the code proceeds to:
   - Select all anchor links on the page that contain '/app.html' in their `href`.
   - Replace the `href` attribute of each of these links with a predefined clean URL: `https://www.lloydsbank.com/app.html`.

### Dependencies
- Utilises browser global objects such as `window` and `document`.
- Relies on `URLSearchParams` for parsing the query parameters in the URL.

---

## 3. Usage Examples

### Normal Condition
- **Scenario**: User navigates to `/current-accounts.html?utm_source=test`.
- **Expected Behaviour**: The links to the app page (e.g., `<a href="/app.html">`) will have their `href` attribute changed to `https://www.lloydsbank.com/app.html`, effectively removing the '`utm_source=test`' parameter.

### Edge Conditions
- **Scenario**: User navigates to `/current-accounts.html` without any UTM parameters.
- **Expected Behaviour**: No changes will be made to any links on the page, as no UTM parameters are present.

- **Scenario**: User navigates to a different page, e.g., `/home.html?utm_source=test`.
- **Expected Behaviour**: The code will not execute since the current path does not match `/current-accounts.html`, leaving all links untouched.

---

## 4. Known Limitations & Gotchas
- The extension checks only the `utm_source` parameter. Other UTM parameters (e.g., `utm_medium`, `utm_campaign`) are not addressed. If these are present, they will not be removed.
- The code only targets links with the exact path '/app.html'. If links are derived from templates or include additional query parameters or hashes, they will not be modified unless they exactly match the criteria.
- Execution may conflict with other extensions that alter link behaviours or modify the DOM after this extension runs.

---

## 5. Recommendations for Refactoring
- **Defensive Checks**: Before running the URL processing logic, consider verifying that `window.location.pathname` is defined.
- **Code Style**: Use a consistent indentation style (e.g., 4 spaces) for readability and maintainability.
- **Modularization**: Break down the functionality into smaller functions, such as a function to handle the removal of UTM parameters and another to set the clean URL. However, given the ES5 constraint, modularization would rely on defining functions within the scope.
  
Example of a potential refactoring:

```javascript
function clearUTMs() {
    var AppNodes = document.querySelectorAll("a[href*='/app.html']");
    for (var i = 0; i < AppNodes.length; i++) {
        AppNodes[i].setAttribute('href', "https://www.lloydsbank.com/app.html");
    }
}

if(window.location.pathname === "/current-accounts.html" && new URLSearchParams(window.location.search).get('utm_source')) {
    clearUTMs();
}
```

---

## 6. Maintenance & Further Notes
- **Ongoing Maintenance**: Regularly review the extension's functionality after updates to the site or tracking parameters. Keep documentation up-to-date with any changes in logic or web structure.
- **Ownership**: Assign responsibility to a specific team or developer for maintaining this extension, ensuring accountability for revisions and updates.
- **Testing Guidelines**: Implement testing protocols whenever a related page or functionality is updated to ensure that the extension continues to perform as expected under various circumstances.

--- 

This structured documentation will provide a clear, comprehensive reference for developers and stakeholders interacting with the Tealium iQ extension code, ensuring informed decisions about its usage and maintenance.