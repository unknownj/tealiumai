# Tealium iQ Extension Documentation: Organic Search Detection

## 1. Extension Overview

- **Name**: Organic Search Detection
- **ID**: 2267
- **Type**: Set Data Values
- **Scope**: After Load Rules
- **Execution Frequency**: Run Always

### Summary
The **Organic Search Detection** extension identifies organic search traffic by assessing various conditions on the incoming requests. The primary goal is to determine if the visitor is arriving via a search engine, without any UTM parameters in the query string, and to capture relevant data for further tagging and analytics.

---

## 2. Code Explanation

### Key Variables
- `b.WebMessagingBuild`: Captures the build version for the web messaging script. This value can come from:
  - URL query parameter (`webmessagingoverride`)
  - Existing cookies
  - A fallback default value (`"1.0.1729783575379"`).
  
### Logic Flow
1. **Initialization of `b.WebMessagingBuild`**: The extension first checks the URL for a `webmessagingoverride` parameter.
2. **Cookie Handling**: If the parameter is absent, it checks for an existing cookie. If found, it updates the cookie and the build version accordingly.
3. **Web Messaging Suppressions**: The `loadMessaging` variable is determined based on a series of conditions applying to the page's hostname and pathname. These conditions dictate when the web messaging script should be loaded.
4. **Script Injection**: If `loadMessaging` is `true`, the extension dynamically creates a `<script>` element to load the web messaging JavaScript file based on the determined `WebMessagingBuild`.
5. **Tagging Metrics Update**: The `TaggingMechanics` variable is updated to include the web messaging build along with other tagging metrics.

### Dependencies
- This extension relies on the presence of global variables such as `eventType`, `eventPayload`, and the `b` object used for associated data.

---

## 3. Usage Examples

### Scenario 1: Organic Search Detection
- **Input**: User arrives via a search engine (referrer contains "google", "bing", etc.) without any UTM parameters in the query string.
- **Output**: The extension processes the data, confirming the organic search, and may trigger subsequent analytics.

### Scenario 2: Edge Case - UTM Parameter Present
- **Input**: User arrives at the URL with a query string containing `utm_source=google`.
- **Output**: The extension determines the conditions are not met (due to the presence of `utm_`), and hence any organic search identification logic is skipped.

### Scenario 3: Error State - Unknown WebMessaging Build
- **Input**: Neither URL parameters nor cookies provide a valid `webmessagingoverride`.
- **Output**: The extension defaults to the hardcoded build version (`"1.0.1729783575379"`), ensuring the application does not break.

---

## 4. Known Limitations & Gotchas

- **Search Engines Assumed**: The extension currently checks for a fixed list of search engines (Google, Bing, etc.). Adding support for new search engines requires modifying the code manually.
- **Cookie Management**: This extension relies on cookie handling. If cookies are blocked in the user's browser, the build detection might fail.
- **Performance on Multiple Conditions**: The extension's performance might degrade if many conditions are added to the `loadMessaging` variable.

### Potential Conflicts
- Other Tealium extensions that manipulate cookies or the `b` object could potentially conflict with this extension, especially in cases where they assume different structures or data types.
  
---

## 5. Recommendations for Refactoring

1. **Error Handling**: Enhance the module by validating the input data rigorously. Although it's guaranteed that `eventType` and `eventPayload` are present, validating cookie values and URL parameters could prevent runtime errors.
   
2. **Extract Common Logic**: Consider modularizing the script to separate concerns. For instance, cookie handling can be abstracted into a dedicated function or utility to improve readability and maintainability.

3. **Code Style**: Consistently use semicolons to terminate statements. While this is a stylistic choice, it can help prevent issues in certain edge cases due to JavaScript's automatic semicolon insertion (ASI).

4. **Commenting**: Increase inline comments to clarify the purpose of specific conditions or code blocks, facilitating easier understanding for future developers.

---

## 6. Maintenance & Further Notes

- **Ownership**: Designate a primary owner responsible for maintaining the extension, including monitoring usage, debugging issues, and applying updates as required.
  
- **Testing Guidelines**: Implement comprehensive testing protocols to ensure changes do not inadvertently disrupt existing functionality. Consider using unit testing frameworks if applicable.

- **Documentation Updates**: Regularly review and update this documentation to reflect changes in logic or conditions as the extension evolves.

---

This documentation aims to provide clarity on the **Organic Search Detection** extension for developers and stakeholders, facilitating its effective use and ongoing development.