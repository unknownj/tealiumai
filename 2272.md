# Tealium iQ Extension Documentation

## 1. Extension Overview

- **Name**: Cardnet Webchat Test
- **ID**: 100036
- **Type**: Javascript Code
- **Scope**: Before Load Rules
- **Execution Frequency**: Run Always

### Summary
The "Cardnet Webchat Test" extension is designed to integrate a web chat functionality for customer support on the website. It conditionally configures the chat system based on specific parameters in the URL, enabling a tailored user experience. By injecting necessary styles and initialising the web chat service, the extension ensures that help is readily available when prompted, enhancing customer interactions.

---

## 2. Code Explanation

### Key Variables
- **`a` and `b`**: The parameters represent event type and event payload, respectively, passed to the IIFE (Immediately Invoked Function Expression).
- **`b.WebchatPlatformOverride`**: Set to "NewCardnet", this variable determines the chat platform used for the service.
- **`window.initESW`**: A global function for initialising the embedded web chat service, defined only if it does not already exist.

### Logic Flow
1. **Condition Check**: The extension first checks if the URL contains "cardnetwebchat=test". If true, it proceeds.
2. **Style Injection**: If `window.initESW` doesn't exist, styles for the chat button are appended to the head of the document.
3. **Function Definition**: `window.initESW` is defined to configure the web chat service settings, including:
   - Enabling the help button.
   - Setting up language preferences.
   - Enabling features like "LiveAgent".
   - Routing logic based on user responses in the prechat form.
4. **Script Loading**: The chat script (`esw.min.js`) is loaded asynchronously, ultimately calling `window.initESW` with either a provided or default URL after the script is fully loaded.

### Dependencies
- The extension relies on the `window` global object for configuring the web chat service.
- It loads an external script from Salesforce for the embedded service.

---

## 3. Usage Examples

### Normal Conditions
- When a user navigates to the site with the URL parameter `cardnetwebchat=test%,` the chat service is immediately set up, and users can interact with a support agent.

### Edge Conditions
- If the external script fails to load (e.g., due to network issues), the extension attempts to load the alternate script URL. If this also fails, the chat service will not initialise, leaving users without support.

---

## 4. Known Limitations & Gotchas

- **URL Dependence**: The extension behaviour is highly dependent on the presence of specific URL parameters. If parameters are missing or malformed, the chat functionality will not initialise.
- **Script Load Timing**: There is potential for race conditions if other scripts on the page interfere with the script loading order or if the chat service is initialised before the script is loaded.
- **Compatibility**: As this extension manipulates the DOM and loads scripts dynamically, it may conflict with other extensions that also modify similar elements or scripts.
  
---

## 5. Recommendations for Refactoring

- **Defensive Checks**: While not required, consider implementing checks to verify the existence of necessary properties on `prechatFormData` before accessing them to prevent runtime errors.
- **Modularisation**: Break down large functions into smaller, reusable functions to improve readability and maintainability.
- **Clear Comments**: Add comments throughout the code to identify sections and their purposes, especially for future developers who may work on this code.
- **Single Responsibility Principle**: Consider separating the DOM manipulation logic from business logic to maintain clarity and separation of concerns.

---

## 6. Maintenance & Further Notes

- **Ownership**: Assign a specific developer or team for ongoing maintenance of this extension to ensure consistent updates and adherence to best practices.
- **Testing Guidelines**: Establish a set of functional tests that cover both normal and edge conditions to validate the behaviour of the extension after any changes or updates.
- **Documentation Updates**: Keep this documentation up to date with any changes made to the extension code, configurations, or external dependencies to ensure its continued usefulness for developers and stakeholders.

---

This documentation serves as a comprehensive guide to understanding, using, and maintaining the Cardnet Webchat Test extension within the Tealium iQ framework.