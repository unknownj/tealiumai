# Tealium iQ Extension Documentation: DeepLinkURL

## 1. Extension Overview

- **Name:** DeepLinkURL
- **ID:** 2277
- **Type:** JavaScript Code
- **Scope:** 1459
- **Execution Frequency:** On every specified event trigger

### Summary
The `DeepLinkURL` extension is designed to generate a deep link URL for passing information to AppsFlyer when a deep linking event occurs. By leveraging UTM parameters from the web page, it constructs a URL that captures relevant marketing attribution data. This is essential for ensuring accurate tracking of campaigns and user interactions within mobile applications.

---

## 2. Code Explanation

### Key Variables
- **base:** This variable holds the canonical URL of the current page.
- **u.dlv:** An object used to store deep link data, eligibility expressions, and mapping of source fields to potential deep link query parameters.

### Logic Flow
1. **Initialization:** The extension checks if the `u.dlv` object is undefined; if it is, it initializes `u.dlv` with data items and eligibility expressions.
2. **Eligibility Check:** The eligibility expressions are evaluated using `LBGAnalytics.Q` to determine if the current context is valid for generating a deep link URL.
3. **Data Mapping:** Each data item defines a field to map:
   - If a source is undefined and has a default value, use the default.
   - If an override value matches the source, apply the override.
   - Otherwise, simply take the source value.
4. **PII Scrubbing:** After data mapping, the code ensures that no personally identifiable information (PII) passes through by checking for email patterns.
5. **URL Construction:** The parameters are encapsulated within a URLSearchParams object and appended to the base URL to form the final deep link URL stored in `b.DeepLinkURL`.

### Dependencies
- **Global Objects:** The extension uses `b` for accessing tracking parameters like `CampaignSource`, `CampaignMedium`, etc.
- **Function Dependencies:** The function relies on `LBGAnalytics.Q` for eligibility checks.

---

## 3. Usage Examples

### Normal Condition:
- When the user clicks a marketing link containing UTM parameters, the extension retrieves these parameters and constructs the deep link URL.
    - Input: `https://example.com?utm_source=YouTube&utm_medium=video&utm_campaign=launch` 
    - Output: `https://canonical.url/path?pid=googleads_int&af_channel=video&c=launch&is_retargeting=true`

### Edge Cases:
- **Missing UTM Parameters:** If some UTM parameters are not present, the extension utilises default values.
    - Input: `https://example.com?utm_source=YouTube`
    - Output: `https://canonical.url/path?pid=googleads_int&af_channel=website&c=website&is_retargeting=true`

- **Avoiding PII:** If a parameter contains identifiable information (like an email), it is scrubbed out.
    - Input with PII: `https://example.com?email=user@example.com`
    - Output: `https://canonical.url/path?pid=googleads_int&af_channel=website&c=website&is_retargeting=true`

---

## 4. Known Limitations & Gotchas

### Limitations:
- **Incomplete Data Handling:** If important UTM parameters are missing from the URL, data may be rendered unusable for tracking.
- **Eligibility Expressions Context:** The extension may not work as expected if changes are made to how `LBGAnalytics.Q` evaluates eligibility.

### Gotchas:
- **Global Conflicts:** Ensure that variable names do not conflict with other global or Tealium variables to avoid unexpected results.
- **Asynchronous Data Flows:** If the page contains JavaScript that asynchronously modifies UTM parameters after the extension has run, the deep link URL may not capture the intended state.

---

## 5. Recommendations for Refactoring

### Suggested Improvements:
- **Code Structure:** Consider breaking the code into smaller functions for readability and maintainability, such as a separate function for data mapping and PII scrubbing.
- **Defensive Checks:** Currently, the code does not handle scenarios where required fields in the `b` object may be missing. Implementing checks for critical fields preemptively can increase robustness.
- **Comment Clarity:** Enhance comments to explain the purpose of eligibility expressions and how override values are intended to work. 

Example of Modularisation:
```javascript
function mapDataItem(dataItem) {
    // Implementation here
}
```

---

## 6. Maintenance & Further Notes

### Ongoing Maintenance:
- Regularly review the eligibility expressions and data items for alignment with current marketing strategies and requirements.
- Update the comments and document any changes made to functionality throughout the extension's lifecycle.

### Ownership and Testing Guidelines:
- Ensure that ownership is assigned for the code, targeting someone responsible for updates and reviews.
- Implement unit tests for the different scenarios to ensure consistent output across varying inputs.
- Schedule periodic reviews to align extension behaviour with evolving business logic and campaign structures. 

--- 

By adhering to the documented structure and suggested practices, this extension can remain scalable and maintainable, ensuring that it continues to fulfil its purpose effectively.