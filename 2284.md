# Tealium iQ Extension Documentation

## 1. Extension Overview

- **Name**: Appsflyer Onelink QR Replacement
- **ID**: 2286
- **Type**: Advanced JavaScript Code
- **Scope**: DOM Ready
- **Execution Frequency**: Run Once

### Summary
This extension processes specific URL parameters and variables related to the Lloyds Banking Group's campaigns, and enables triggering of conversions based on predefined conditions. Its primary function is to handle link attribution via Appsflyer and facilitate the appropriate tracking of user engagement with various banking brands.

---

## 2. Code Explanation

### Key Variables
- **structureLkpsM**: A mapping of lookup types to their corresponding variables, allowing for flexible data processing based on brand and path.
- **lkptbl**: A master lookup table that associates specific input conditions (formatted as `lookup type!brand!path`) with their corresponding output conversion values.

### Logic Flow
1. **Initial Checks**: The code verifies the existence of the global `LBGAnalytics` object and its `datalayer`.
2. **Data Population**: It populates the `datalayer` with lowercase versions of relevant variables (`PegasusBrand` and `CanonicalPath`).
3. **Lookup Processing**: The extension iterates over the `lkptbl` entries using the `runLookups` function:
    - **Unpacking Input**: Each lookup record is split into input and output components.
    - **Eligibility Rule Evaluation**: For each record, the eligibility is checked against existing tracking criteria.
    - **Setting Tags**: If the eligibility criteria are met, the associated `fbID` for conversion tracking is assigned.
4. **Exit Conditions**: Once all lookups are processed, the function concludes whether to initiate tag firing based on eligibility.

### Dependencies
- The extension relies on the `LBGAnalytics` object, which is expected to be available in the global scope. This object must contain a `datalayer` for the extension to function correctly.

---

## 3. Usage Examples

### Normal Condition
- **Scenario**: A user accesses a URL `https://lloydsbank.com/app.something` with the query parameter `utm_source=stuqr`.
    - The extension checks the conditions based on the URL and query string.
    - If matched, it processes the entry to trigger the required conversion based on the lookup table.

### Edge Condition
- **Scenario**: A user visits a URL `https://example.com/app.something` with `utm_source=stuqr`.
    - The extension does not meet the conditions set in the `conditions` array, therefore it does not proceed with tag firing.

---

## 4. Known Limitations & Gotchas

- **Dependency on Global Object**: The code will fail if `LBGAnalytics` or its `datalayer` is not defined within the global scope.
- **Hardcoded Properties**: The lookup values are hardcoded within the `lkptbl`. Any changes to tracking parameters require a manual update of this table.
- **Single Execution**: The extension is designed to run once per page load; multiple executions would necessitate additional logic to handle.
- **Environment Specificity**: Testing should be conducted in the environment where the extension is deployed to ensure all dependencies are satisfied.

---

## 5. Recommendations for Refactoring

- **Modularisation**: Consider breaking down the code into smaller, reusable functions to improve readability and maintenance.
- **Defensive Programming**: While the availability of `eventType` and `eventPayload` is guaranteed, implementing checks for the `LBGAnalytics` object can prevent runtime errors.
- **Variable Naming**: Using more descriptive variable names could enhance understandability, especially for `lkpnum` and `lkp`.
- **Comments and Documentation**: While the existing comments are helpful, adding more context regarding the expected structure and usage of the input data could aid future developers.

---

## 6. Maintenance & Further Notes

- **Ownership**: Assign a specific team member to oversee updates and maintenance of the extension as business needs evolve.
- **Testing Guidelines**: Implement a thorough testing methodology to cover various URL scenarios and query parameters to ensure robust functionality.
- **Documentation Updates**: Regularly review and update the extension documentation to reflect any changes in logic, dependencies, or business requirements.

---

This structured documentation serves as a comprehensive guide for developers and stakeholders involved in the maintenance and usage of the "Appsflyer Onelink QR Replacement" extension within Tealium iQ.