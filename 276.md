# Tealium iQ Extension Documentation

## 1. Extension Overview

- **Name**: Q - A Load Rule Processor
- **ID**: 100036
- **Type**: Javascript Code
- **Scope**: Pre Loader
- **Execution Frequency**: Run Once

### Summary

The "Q - A Load Rule Processor" extension is designed to handle load rules by evaluating conditions defined by users. It primarily serves to check various properties of a data object (e.g., `window` or any specified object) to determine if certain conditions are met, allowing for dynamic control of tag firing in Tealium based on these evaluations.

---

## 2. Code Explanation

### Key Variables and Structure

- **Version**: The extension initializes with a version number defined in the `fn` object (`version: "1.0.0"`).
- **Logging**: A boolean flag (`loggingEnabled`) is used to control logging output.
- **Data Object**: The `dataObject` variable holds the context for rule evaluation, defaulting to `window`.
- **Path, URL, Domain**: Functions to obtain values used for comparisons based on the current page's path, full URL, and domain, respectively.

### Logic Flow

1. **Global Context Check**: The script begins with a check for `window.LBGAnalytics` and initialises `window.clova3.Q`.
2. **Function Definitions**: Internal functions are defined to process various data types (booleans, functions, arrays, strings, objects).
3. **Evaluation Process**: The `processRule` function orchestrates the evaluation based on the type of the rule passed, invoking appropriate processing functions.
4. **Returning Value**: The processed result from `processRule` is assigned to `Q`, making it accessible as `window.clova3.Q`.

### Global Dependencies

- **`window` Object**: Heavily relies on the global `window` object for base data and path processing.
- **`window.LBGAnalytics`**: Must exist for initialisation, providing a reference for loading conditions.
- **`window.clova3.datalayer`**: Used for getting dynamic data when calling `setDataObject`.

---

## 3. Usage Examples

### Normal Flow

In a typical scenario, the extension would evaluate a rule such as:

```javascript
{
  "exists": "someProperty"
}
```

If `someProperty` exists on the data object returned by `window.clova3.datalayer.get()`, the rule evaluates to `true`, and tags associated with this load rule will fire.

### Edge Cases

If `someFunction` is defined as an evaluation function:

```javascript
function someFunction() {
  return false; // The condition will always be false.
}
```

If passed as a rule, the extension will repeatedly resolve through the `resolveFunction`, eventually returning `false` after three calls, thus ensuring stability when resolving nested functions.

---

## 4. Known Limitations & Gotchas

- **Function Evaluation Limit**: The recursive check for functions will stop after 3 iterations. If a function returns another function indefinitely, it leads to a graceful handling via a return of `undefined`.
- **Object Structure**: The extension assumes that objects being processed are correctly structured. A malformed object may lead to silent failures in evaluations (e.g., undefined keys).
- **Logging**: If logging is enabled, excessive logging may flood the console. A mechanism exists to disable it but needs careful handling.

### Conflicts

- The extension may conflict with other scripts attempting to manipulate the same global variables or overriding `window` methods.

---

## 5. Recommendations for Refactoring

- **Modular Functions**: Consider breaking the functions into smaller modular units for better maintenance and readability.
- **Consistent Logging Practices**: Avoid excessive logging during production runs. Provide toggle settings for logging that are clear and easy to understand.
- **Type Checking**: Implement more robust type checking before operating on potential structures to prevent runtime errors.
- **Error Handling**: Include more descriptive error handling within the `catch` blocks for easier debugging and insight into underlying issues.

---

## 6. Maintenance & Further Notes

### Ownership

Assign ownership to a specific team member for the upkeep of this extension, ensuring accountability in the case of issues.

### Testing Guidelines

Maintain a robust testing strategy, including:
- **Unit Tests**: Implement unit tests for critical functions to ensure they behave as expected under various scenarios.
- **Integration Tests**: Verify the extension's behaviour in the production environment to identify any integration issues with other components.

### Documentation Updates

Regularly review and update documentation to reflect changes and improvements made to the extension. Consider creating a changelog with significant updates.

--- 

### End of Documentation

This structured documentation ensures clarity and uniformity, aiding the understanding and use of the "Q - A Load Rule Processor" extension among developers and stakeholders.